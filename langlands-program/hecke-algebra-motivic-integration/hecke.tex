
% spherical Hecke algebra and motivic integration
% Tex file started June 28, 2016
% 
% 

%Authors: William Casselman, Jorge Cely, Thomas Hales

\newcommand{\XX}[1]{{\it  [To do: #1]}}
\newcommand{\ring}[1]{\mathbb{#1}}
\newcommand{\g}[1]{\langle{#1}\rangle}
\def\op#1{{\operatorname{#1}}}
\def\inv{\op{inv}}
\def\dom{P^+}
\def\Q{{\ring{Q}}}
\def\card{\op{card}}
\def\CSrho{[W_S\backslash C_\rho]}

\def\C{\mathcal C}
\def\N{\mathcal N}
\def\H{\mathcal H}
\def\M{\mathcal M}
\def\T{\mathcal T}

\def\n{{\mathfrak n}}


\def\libel#1{{\text{\sc [#1]~}}\label{#1}}
\def\rif#1{(\ref{#1}-{\text{\sc #1})}}


%\section{Introduction}

\newpage
\section{Endoscopic branching formulas}

Let $G$ be an unramified $p$-adic reductive group, and let $H$ be an unramified endoscopic
group of $G$.  We assume that we are given an embedding
\[
\xi:{}^L_H\to {}^LG,
\]
that factors through a finite unramified extension of $F$:
\[
\xi:\hat H\rtimes \g{\theta_H}\to \hat G\rtimes \g{\theta_G},
\]
such that $\xi(\theta_H) = \dot w_0 \rtimes \theta_G,$
for some element $w_0\in N_{\hat G}(\hat T)$.
The irreducible representations $\tau_\lambda$ of ${}^LG$ restricted to $\hat G\rtimes\theta_G$ are classified
by a highest weight $\lambda\in P^+_G\subseteq Y^*_G$, and similarly for irreducible representations $\sigma_\mu$
on $\hat H\rtimes \theta_H$, with $\mu\in P^+_H\subseteq Y^*_H$.  Recall $Y^*_H = X^*(\hat T_H)^{\theta_H}$.
We wish to give a  branching formula for $\tau_\lambda$ restricted to $\hat H\rtimes\theta_H$,
as a sum of $\sigma_\mu$:
\[
\tau_\lambda| = \sum_\mu m_\xi(\lambda,\mu) \sigma_\mu
\]
for some coefficients $m_\xi(\lambda,\mu)$.  (For our purposes, we want $m_\xi(\lambda,\mu)$ to be
a constructible function.)

If $\sigma_\mu$ is an irreducible character and $\epsilon:\g{\theta_H}\to \ring{C}^\times$ is a multiplicative character,
then $\sigma_\mu\otimes \epsilon$ is again an irreducible character.  Restricted to $\hat H\rtimes\theta_H$, we have
a linear dependence $(\sigma_\mu\otimes\epsilon) = \epsilon(\theta_H) \sigma_\mu $.
This means that the multiplicities $m_\xi(\lambda,\mu)$ take values in $\ring{Z}[\zeta]$, where $\zeta$ is a primitive
root of unity of the same order as $\theta_H$.  In particular, 
we lose usual connection between multiplicities and degrees of the representations. For example,
for a given $\lambda$,
it is quite possible for all the multiplicites $m_\xi(\lambda,\mu)$ to be zero.

I think that we can formally extend Kostant's formula for $m_\xi(\lambda,\mu)$ to this setting.
Recall that his formula for $m_\xi(\lambda,\mu)$ is based on the (twisted) Weyl character formula.
Let's sketch what this should look like in the endoscopic case.  I am following Goodman and Wallach,
Section 8.2.2.

Extend exponentials formally from $\ring{C}[Y^*]$ to $\ring{C}[Y^*_H\otimes \ring{Q}]$.
If $R$ is a set of roots, let 
\[
R_{\ge0} = \{\sum r_\alpha \alpha\mid r_\alpha\ge 0, ~ r_\alpha\in \ring{Q},~\alpha\in R \}.
\]

Let $\hat S_H = \hat T_H/(1-\theta_H)\hat T_H$ and $\hat S_G = \hat T_G/(1-\theta_G)\hat T_G$.
For each $s\in \hat S_H$, let $s_\xi\in \hat T_G$ be such that
\begin{itemize}
\item $t\in\hat T_H \mapsto s\in \hat S_H,$
\item $\xi(\theta_H t)$ is conjugate to $\theta_G s_\xi$.
\item For every character $\lambda\in Y^*_G$, we have $e^\lambda(s_\xi) = \zeta_\lambda e^{\lambda'}(s)$, 
for some root of unity $\zeta_\lambda$ and $\lambda'\in Y^*_H\otimes \ring{Q}$.  
If $\lambda\in \Sigma_{1,G}^+$, then $\lambda'\in \Sigma_{1,H,\ge0}^+$.
(I hope this can be done.)
\end{itemize}
We restrict to the setting where we have the regularity property that 
for every root $\alpha\in \Sigma_{1,G}$, $e^\alpha(s_\xi)$ is not identically $1$ on $\hat S_H$.

Let $\n'_G$ and $\n'_H$ be the Lie algebras of the negative root spaces for $\hat G$ and $\hat H$.
We define a relative partition function on $Y^*_H$:
\[
D_{\xi}(s) = \det(1-\theta_H s;\n'_H)/\det(1-  s_\xi;\n'_G) = (\sum_{\mu} p_\mu e^\mu)(s).
\]

We compute using the twisted Weyl character formula on $\hat H$ and $\hat G$:
\begin{align*}
\tau_\lambda| P_H(E_H^{-1},1)^{-1} &= \sum_{\mu'} m_\xi(\lambda,{\mu'}) J_H(e^{\mu'}).\\
\tau_\lambda| P_H(E_H^{-1},1)^{-1} &= \tau_\lambda D_{\xi} \det(1- s_\xi;\n'_G)\\
  &= (\sum_{\mu'} p_{\mu'}) J_G(e^\lambda)|\\
  &= \sum_{\mu'} \sum_{w\in W^\theta} (-1)^{\ell w} p_{\mu'} e^{\mu'+w\bullet \lambda|}\\
  &= \sum_{\mu'} \sum_{w\in W^\theta} (-1)^{\ell w} p_{\mu'} \zeta_{w\bullet\lambda} e^{\mu'+(w\bullet \lambda)'}\\
  &= \sum_\mu \sum_{w\in W^\theta,~{w\bullet\lambda}'\in Y^*_H} (-1)^{\ell w} \zeta_{w\bullet\lambda} p_{\mu - {w\bullet \lambda}'} e^\mu.
\end{align*}
Equating coefficients, we get
\begin{equation}
m_\xi(\lambda,\mu) = \sum_{s\in W^\theta, ~{w\bullet\lambda}'\in  Y^*_H} (-1)^{\ell w} \zeta_{w\bullet\lambda} 
p_{\mu-(w\bullet\lambda)'}.
\end{equation}
Thus, the endoscopic branching formula comes down to computing the map $s\mapsto s_\xi\in \hat T_G$,
roots of unity $\zeta_\lambda$,
and the associated partition function, with coefficients $p_{\mu'}$.


We work an example.
Let $\hat G = GL(n,\ring{C})$, and let $\theta_G$ act trivially on $\hat G$.
Assume that $n=m \ell$. 
Let $\hat H = GL(m,\ring{C})\times \cdots\times GL(m,\ring{C})$ ($\ell$ factors).
Let $\theta_H$ be an automorphism of $\hat H$ of order $\ell$ that permutes the factors:
$\theta_H(g_1,\ldots,g_\ell) = (g_\ell,g_1,g_2,\ldots)$.
We pick $\xi:\hat H\to \hat G$ to be the obvious block diagonal embedding.  We extend
to $\xi:{}^LH\to {}^LG$ by letting $\xi(\theta_H) = \dot w\times \theta_G$, for a suitable permutation
matrix $\dot w\in GL(n,\ring{C})$. We compute the partition function that gives the twisted branching formula for $\xi$.

We can identify the torus $\hat S_H$ with elements $t=\op{diag}(s,1,1,1,1,\ldots)$, where 
$s=\op{diag}(s_1,\ldots,s_m)$ is diagonal in
$GL(m,\ring{C})$.  Let $\zeta$ be a primitive $\ell$th root of unity in $\ring{C}^\times$.
We compute the image $s_\xi = \op{diag}(t_1,\ldots,t_m)$, 
where $t_i = \op{diag}(\tau_i,\tau_i \zeta,\ldots, \tau_i \zeta^{\ell-1})$.  
and $\tau_i = s_i^{1/\ell}$.
Let 
\[
\lambda = (\lambda_1,\lambda_2,\ldots,\lambda_n)\in Y^* = X^*(\hat T_G) = \ring{Z}^n.
\]
We compute that
\[
\zeta_\lambda = \zeta^{0\lambda_1+1\lambda_2+2\lambda_3+\cdots}.
\]

Let $\Sigma_{1,H}$ be the root system for a single factor $GL(m,\ring{C})$.  (It is the $\Sigma_1$ root
system for ${}^LH$.)
Using this description, we compute that\footnote{The calculations have not been carefully checked. In fact, this
could all be wrong.} 
the partition function $D_{\xi}$ for the endoscopic branching
formula is
\[
D_\xi=\frac{1}{d_{\ell}^m} \prod_{\alpha\in\Sigma^+_{1,H}} (1-e^{-\alpha})^{1-\ell}.
\]
Here $d_\ell = \ell^{\ell/2} \omega_\ell$, for a certain $12$th root of unity $\omega_\ell$ depending on $\ell$:
\[
\omega_2 = 1,\quad \omega_3 = \zeta_6,\quad \omega_4 = i,\quad \omega_5 = -1,\quad \omega_6 = \zeta_6^5,
\ldots
\]



\newpage

In this article, we use motivic integration to describe the spherical
Hecke algebra, its Satake transform, and inverse Satake transform.
The transfer principle of motivic integration implies the fundamental
lemma for the spherical Hecke algebra in sufficiently large positive characteristic.

Let $F$ be a $p$-adic field; that is, a finite extension of $\ring{Q}_p$ or $\ring{F}_p((t))$.
Let $G$ be an unramified reductive group and $H$ an unramified endoscopic group of $G$, both defined over $F$.
Let $\H(G)$ and $\H(H)$ be the spherical Hecke algebras on $G$ and $H$.
Associated with  a morphism $\xi:{}^LH\to {}^LG$ of $L$-groups, there is a homomorphism
$b_\xi:\H(G)\to \H(H)$, obtained by composing three maps: the Satake transformation of $\H(G)$,
the pullback under $\xi$, and the inverse Satake transformation to $\H(H)$.

Let 
\[
\dom = \{\lambda\in X_*(A) \mid \g{\lambda,\alpha^\vee}\ge 0,\quad \alpha\in \Delta_1\}
\]
be the set of dominant weights in $X^*(\hat S)=X_*(A)$.
The spherical Hecke algebra $\H(G)=\H(G//K)$ of functions that are bi-invariant with respect
to a given hyperspecial subgroup $K$ has a linear basis given by characteristic functions $f_\lambda$
of double cosets $K\varpi^\lambda K$.  Here $\varpi$ is a fixed uniformizing element and $\lambda$
runs over the cocharacters in a positive Weyl chamber $P^+$.

One aim of this article is to study the function $B_\xi:P^+\times H(F)\to \ring{C}$, given by
$(\lambda,h)\mapsto b_\xi(f_\lambda)(h)$.   The function $B_\xi$ can be lifted to a constructible motivic
function (Theorem \ref{thm:B}).   In particular, $B_\xi$ admits a field-independent description.  

As an application, we show that the fundamental lemma for the spherical Hecke algebra falls within
the scope of the transfer principle for constructible motivic functions.
This implies that the fundamental lemma holds for the spherical Hecke algebra in fields of large positive
characteristic (Theorem \ref{thm:fl}).

This application to the fundamental lemma is the main motivation for this work.  Our results overlap with
those of Bouthier, who proves the fundamental lemma for the spherical Hecke algebra in positive
characteristic under the restrictions that the group $G$ is semisimple and simply connected, 
and the endoscopic group is split \cite[Theorem~0.2]{bouthier}.  Our proof of the fundamental lemma for the
spherical Hecke algebra holds without his restrictions on the group and endoscopic group.
Unlike Bouthier, we are unable to be explicit in our assumption
on the characteristic of the field.  In other work,
Lemaire, Moeglin, and Waldspurger propose that the method of close fields might be used to transfer the
fundamental lemma for the spherical Hecke algebra from characteristic zero to positive characteristic, but as far as we know, 
this has not been
carried out~\cite[\S1.3]{LMW}.

The construction of $B_\xi$ involves the Langlands dual ${}^LG$, which is a non-connected complex reductive group.
Our constructibility result for $B_\xi$ follows from the  Presburger constructibilty of various
functions on lattices in the dual:  Macdonald's formula, weight multiplicity formulas, the inverse of the weight multiplicity matrix,
the Plancherel measure,
and the Kato-Lusztig formula for the inverse Satake transform.  
When $G$ and $H$ are split, we can take ${}^LG = \hat G$ and ${}^LH=\hat H$ to be connected.  In this case,
formulas of the desired form were previously known.  In this article, we
generalize these formulas to non-connected complex reductive groups.
These generalizations are a major part of this work.

One novelty of this work is that we show how to extend the theory of motivic integration to the Langlands
dual group, by encoding representation-theoretic data of the complex dual group as Presburger constructible functions on the character lattice. These
Presburger functions can then be recombined with constructible functions on the $p$-adic group.  A second innovation is
to encode the entire Hecke algebra into a single constructible function $B$.  This makes it possible to invoke the the transfer
principle of motivic integration a single time, rather than once for each function in the Hecke algebra.  (Invoking the transfer principle
an infinite number of times could potentially leave us with nothing, because we lose finitely many primes with each invocation.)

A framework for studying the spherical Hecke algebra through motivic integration is provided by Cely's thesis \cite{cely}.
This article builds on that work.  We thank Julia Gordon, who served on Cely's thesis committee and who provided valuable suggestions.



\section{the Satake transform, Macdonald's formula, and related topics}
\libel{XX} % dummy label

In this section, we extend various results from split $p$-adic groups to unramified groups
(from
complex connected reductive groups to non-connected groups on the $L$-group).

\subsection{root systems}

Let $G$ be an unramified reductive group over a $p$-adic field $F$.  It is defined by
descent from a finite unramified extension $E/F$ over which $G$ splits.  It is determined by an automorphism
$\theta$ of the root datum $(X^*,\Phi,X_*,\Phi^\vee)$ of the split form $G^*$ of $G$.     
The automorphism $\theta$
has finite order and preserves a set of simple roots associated to some set $\Phi^+$ of positive roots.
If $\op{Frob}$ is the Frobenius automorphism of $E/F$, the group $G/F$ is defined by twisting by $\theta$
action of $\op{Frob}$ on $G(E)$.
Let $(B,T,X)$ be a pinning of $G$ over $F$, preserved by $\theta$.

%Let $K$ be a hyperspecial maximal compact subgroup of $G$ and let $O_F$ be the ring of integers of $F$.  
Let $A$ be a maximal split torus in $T$.
For any $S\subseteq \Phi$,
let $M_S$
be the centralizer of 
\[
A_S = \{a\in A\mid \alpha(a)=1,\quad \alpha\in S\}.
\]
We have
$X_*(A) = X_*(T)^\theta$ and $X^*(A) = X^*(T)/(1-\theta)X^*(T)$.
The pairing of $X^*(A)$ and $X_*(A)$ is induced naturally from that of $X^*(T)$ and $X_*(T)$.
Let $N:X_*(T)\to X_*(A)$ be the norm map: $N\alpha = \sum_{\alpha'\in [\alpha]} \alpha'$.

The image of $\Phi$ in $X^*(A)$ is the restricted root sytem $\Sigma$.  
It is well known that $\Sigma$ is indeed a root system, and this is easy to
verify directly in this context.
The roots of $\Sigma$ are in bijection with the 
$\theta$-orbits of  roots in $\Phi$, and this bijection restricts to a bijection between
simple roots in $\Sigma$ and
 orbits of simple
roots in $\Phi$.
If $\alpha$ is a root of $\Phi$ (or coroot), we write 
$[\alpha]=\{\alpha,\theta\alpha,\ldots\}$ for its
$\theta$-orbit, often identified with a root of $\Sigma$.
%A root $\alpha$ is {\it nonmultipliable} if $2\alpha$ is not a root.
A root is {\it indivisible} if $\frac12\alpha$ is not a root.
%Let $\Sigma^{red}$ and 
Let $\Sigma_{red}$ be the set of %nonmultipliable and 
indivisible roots of $\Sigma$.
It is a reduced root system.
% They are both reduced root systems.
Two roots $\alpha$ and $\alpha'\in\Sigma$ are {\it homothetic} if $\alpha' = k\alpha$ for some $k>0$.
Every root is homothetic to an indivisible root.  % nonmultipliable root and to an indivisible root.


Each root $\beta\in\Phi$
can be assigned a diagram  $A_1$ or $A_2$ as follows.  
The construction is best described in the split group $G^*$.
Let $S=[\beta']$ be the $\theta$-orbit that corresponds to the indivisible
root homothetic to $[\beta]$.  
The simple
positive roots of $M_S$ form a single $\theta$-orbit $S$.  We consider
its Dynkin diagram.
% is a product of the restriction of $
%Let $[\beta]$ be the $\theta$-orbit of $\beta$.
%Note that $\theta$ preserves the height of a root.
%By joining nodes that are not orthogonal,
%the node set $S$ forms
%a Dynkin diagram.
By the transitivity of $\theta$,  all components of the diagram have the same type,
either  $A_1$
or $A_2$.  This is the diagram  of $\beta$.
This construction can be applied to $(G^*,\Phi)$ or to $(\hat G,\Phi^\vee)$, where $\hat G$
is the complex dual.
%If every component of the Dynkin diagram  has type $A_2$, 
%then we say that the roots in the orbit
%have {\it type II}.  In that case, 
%there exists $m$ such that  
%then $\theta^b$ acts nontrivially
%on each factor $A_2$.   For each such root $\beta$, % of type II, 
%we have a positive root $\gamma = \beta+\theta^b\beta$ that is the highest root in an $A_2$ factor.  
%We say that $\beta$, and $\gamma$ have diagram type $A_2$, and that the remaining roots have
%diagram type $A_1$.
%We say that $\gamma$ has {\it type III}.
%The remaining roots  have {\it type I}.  For roots of
%types I and III, each component of the Dynkin diagram has type $A_1$.
A coroot $\alpha^\vee$ has the same diagram  as $\alpha$.
We let $b(\beta)$ be the number of connected components of the Dynkin diagram.
(According to the types of Kottwitz and Shelstad, type I means diagram $A_1$, type II means
a simple root in diagram $A_2$, and type III means a highest root in diagram $A_2$ 
\cite{kottwitz1999foundations}.)
%A root of $\Phi$ has diagram $A_1$ exactly when it restricts to a root in $\Sigma$ 
%that is nonmultipliable and indivisible. 
%The restriction of a root of type II is divisible.  The restriction of a root of type III is multipliable.






\begin{lemma}\label{lemma:norm}
If $[\alpha]\in\Sigma_{red}$ is an indivisible restricted root, then the corresponding coroot is
\begin{equation}\label{eqn:norm}
[\alpha]^\vee = k\, N\alpha^\vee
%\begin{cases}
%N\alpha^\vee,&\text{if diagram $A_1$};\\
%2N \alpha^\vee,&\text{if diagram $A_2$}.
%\end{cases}
%(In brief, $kN\alpha^\vee$ for diagram $A_k$.)
\end{equation}
when the diagram has type $A_k$, for $k=1,2$.
\end{lemma}

\begin{proof}
(See \cite[1.3.9]{kottwitz1999foundations}.)
\end{proof}

Let $W$ be the
Weyl group attached to the root datum of $G$ over a splitting field $E$.
The restricted Weyl group $W^\theta$ is the subgroup of $W$
commuting with $\theta$.  The simple reflection in $W^\theta$ 
associated with an orbit $[\alpha]$ of simple roots in $\Phi$ is the
longest element in the Weyl group of the Levi component $M_{[\alpha]}$.
The group $W^\theta$
is a Coxeter group with generators given by these simple reflections.
We write $\ell(w)$ for the length of $w\in W^\theta$, computed relative to the set of simple reflections 
of the Coxeter group $W^\theta$.



\subsection{$L$-groups}

%\subsection{twisted formulas}

We review some aspects of the  theory of  non-connected complex reductive groups from
Steinberg \cite{steinberg1968endomorphisms},  Springer \cite{springer2010linear},
Kottwitz and Shelstad \cite{kottwitz1999foundations}, 
Haines \cite{haines2016dualities}, and
 Chriss \cite{chriss}.





Let ${}^LG = \hat G \rtimes \g{\theta}$ be the $L$-group of the unramified group $G$.
It has root system dual to that of $G$.
It is a semidirect product of a connected complex reductive group $\hat G$ and a finite cyclic group
generated by an outer automorphism $\theta$ of $\hat G$.  The automorphism $\theta$ 
 preserves a pinning $(\hat B,\hat T,\hat X)$ of $\hat G$. Let $\hat B = \hat T\hat N$.

Let $\Psi=\Phi^\vee$ and $\Psi^\vee=\Phi$ be the root and coroot systems
 of the complex group $\hat G$ with respect to $\hat T$, and let
$\Psi^+$ be the set of positive roots with respect to $(\hat T,\hat B)$.
If $R$ is any root system with positive roots $R^+$, we let $\rho(R)$ be the half-sum
of positive roots in $R^+$.  We have $\rho(\Sigma^+_1) = \rho(\Psi^+)$.


The torus $\hat T$ is $\theta$-stable.  We form the quotient 
$\hat S = \hat T/(1-\theta) \hat T$, where
\[
(1-\theta)\hat T = \{ t\theta(t^{-1}) \mid t\in \hat T\},
\]
using additive notation for a multiplicative group.
If $\lambda\in X^*(\hat T)^\theta$ is $\theta$-fixed, then
it is trivial on $(1-\theta)\hat T$ and descends to a character $\lambda\in X^*(\hat S)$.
This gives $X^*(\hat T)^\theta = X^*(\hat S)$.
%Let 
%\[
%\Sigma_1 = \{\pm N'\beta\mid \beta\in \Psi^+\}
%\]
%It is a root system.  Each root in $\Sigma_1$ is obviously $\theta$-fixed, and we
%may treat $\Sigma_1$ as a subset of  $X^*(\hat S)$.

We abbreviate $Y^* = X^*(\hat S)$. Let $O=O_F$.
We have identifications
\begin{equation}\label{eqn:identify}
T/T(O)=A/A(O)=X_*(A)=X_*(T)^\theta  =X^*(\hat T)^\theta = Y^* = X^*(\hat S).
\end{equation}
Each unramified character $\chi:T\to \ring{C}^\times$, by these identifications, is a homomorphism
\begin{equation}
\chi\in\op{Hom}(T/T(O),\ring{C}^\times) = \op{Hom}(X^*(\hat S),\ring{C}^\times) = X_*(\hat S)\otimes \ring{C}^\times = \hat S.
\end{equation}
We write $\chi = \chi_s$, for $s\in\hat S$.

Let $e^\lambda$ be the basis element of  the group algebra $\ring{C}[Y^*]$ of $Y^*$, 
 corresponding to group elements $\lambda\in Y^*$.

A basis of $W^\theta$-fixed functions in $\ring{C}[Y^*]$ is 
\[
m_\mu = \sum_{\lambda\in W^\theta(\mu)} e^\lambda, \quad \text{for }\mu\in P^+,
\]
where $W^\theta(\mu)$ is the orbit of $\mu\in\ring{C}[Y^*]$ under $W^\theta$.


%Let $W^\theta$ be the $\theta$-fixed subgroup of the Weyl group of $\hat T$ in $\hat G$.  
%  Then $W^\theta$ acts on $X^*(\hat T)^\theta = X^*(\hat S)$.  In fact, $W^\theta$ may be
%identified with the Weyl group of the root system $\Sigma_1$. (Compare Corollary \ref{cor:weyl-p}.)


Let $\hat G_\theta$ be the complex group with
 Cartan subgroup $\hat S$, root system 
$\Sigma_1=(\Sigma_{red})^\vee$, and root datum
\[
(X_*(A),(\Sigma_{red})^\vee,X^*(A),\Sigma_{red}) = (X^*(\hat S),\Sigma_1,X_*(\hat S),\Sigma_1^\vee).
\]
The complex group $\hat G_\theta$ is the $L$-group of $G^1$, the identity component of the
$\theta$-fixed subgroup of the split form $G^*$ \cite[\S1.3]{kottwitz1999foundations}.
As we will see, $\hat G_\theta$ fits naturally
into the twisted Weyl character formula for the $L$-group ${}^LG$, hence also into the Satake transform
and its inverse.  

\begin{example}  Let $G=\op{SU}(n,E/F)$ be an unramified unitary group in an odd number of variables $n=2k+1$.
The automorphism $\theta$ has order $2$.
The cocharacter groups of $T$ and $A$ are
\[
X_*(T) = \{(t_1,\ldots,t_{n})\in \ring{Z}^n\mid t_1+\cdots t_n=0\}, 
\quad
X_*(A)  = \ring{Z}^k,
\]
with identification $(t_1,\ldots,t_k)\in X_*(A)\mapsto (t_1,\ldots,t_k,0,-t_k,\ldots,-t_1)\in X_*(T)^\theta$.
Following Lemma \ref{lemma:norm}, we compute norms to get
\[
\Sigma_1 = \{\pm t_i\pm t_j\mid i\le j\le k\}\subset X_*(A).
\]
We recognize the root datum as that of $\hat G_\theta = \op{Sp}(2k,\ring{C})$ with root sytem $\Sigma_1$.  
In this case, $G^1 = \op{GL}(n)^{\theta,0} = \op{SO}(2k+1)$, which indeed has $L$-group $\hat G_\theta$.
\end{example}







\subsection{the partition function}



Let $\n$ be the Lie algebra of $\hat N$ and
let $\n = \oplus_{\beta\in \Psi^+} \n_\beta$ be the root space decomposition.  We define a symbolic operator $E$ on $\n$ that is diagonal with
respect to the root space decomposition:
\[
E v = e^{\beta} v, \text{ for } v \in \n_\beta.
\]
For $w\in W^\theta$, we define $w(E)$ formally, by $w(E) v = e^{ w \beta} v$, for $v\in \n_\beta$.
The automorphism $\theta$ also acts on $\n$.  We define the $q$-partition function as
\begin{equation}
P(E,q) = 1/\det(1- q \theta E;\n).
\end{equation}

%Recall that the $\theta$-orbits of $\Phi$ are in bijection with $\Sigma$; and dually, the $\theta$-orbits
%of $\Psi$ are in bijection with $\Sigma^\vee$.  
Recall that each $\alpha\in \Sigma^+_1$ has the form $[\beta^\vee]^\vee$, with $[\beta^\vee]\in \Sigma_{red}$
and some $\beta$  in $\Psi^+$.  The root $\beta$ has a diagram $A_1$ or $A_2$,
associated constant $b=b(\beta)$, and $k N\beta = \alpha$ for diagram type $A_k$ (Lemma \ref{lemma:norm}).
For each $\alpha\in \Sigma_1$, we define
\begin{equation}\label{eqn:d}
d_\alpha(q) =
\begin{cases} {1-q^b e^\alpha},    &\text{if diagram } A_1;\\
{(1-q^{2b} e^{\alpha/2})(1+q^b e^{\alpha/2})},
&\text{if diagram } A_2.
\end{cases}
\end{equation}
%\[
%\epsilon(\beta)=\begin{cases} -1, & \text{if $\beta$ has type III},\\
%     \phantom{-}1, & \text{otherwise}.
%\end{cases}
%\]
We have the following factorization.

\begin{lemma} \label{lemma:prod}
%Let $[\beta_1],\ldots,[\beta_k]$ be the $\theta$-orbits in $\Psi^+$, with cardinalities $b_i = \card([\beta_i])$.
Then
\[
\det(1-\theta  q E;\n) = \prod_{\alpha\in\Sigma^+_1} d_\alpha(q).
\]
\end{lemma}

\begin{proof} Similar factorizations in the special case $q=1$
are found in \cite{jantzen1977darstellungen}, \cite{wendt2001weyl}.  Here is a sketch.
The determinant is block diagonal, with a block for each $\theta$-orbit in $\Psi^+$.

We first consider diagram type $A_1$.
Write $\alpha = N\beta$, as above with $\beta\in\Psi$.
On the block $[\beta]$, we can pick a basis $X_i$ of the
root spaces $\n_{\theta^i\beta}$ such that $\theta$ acts as $\theta X_i = X_{i+1}$, with indices mod $b$.
The determinant restricted  to this block satisfies the fool's identity $\det(I-A) = \det(I)-\det(A)$, which yields
$1- \prod_{\beta'\in [\beta]} {q e^{\beta'}} = 1- q^b e^{N \beta}$.

Next consider diagram type $A_2$.  Write $\alpha = 2N\beta$ as above.
We choose three positive roots
$\beta,\beta',\gamma\in\Psi$ forming the positive root system of $A_2$, where $\gamma=\beta+\beta'$ is 
the highest root.  
We have $N\gamma=N\beta=N\beta'=\alpha/2$.
Recall that $b$ is the number of components in the Dynkin diagram of type $A_2$.
Then $\theta^b$ preserves the $A_2$ factor and $\theta^b(\beta)=\beta'$.
There are two $\theta$-orbits of roots: $[\gamma]$ and $[\beta]=[\beta']$ of cardinalities $b$ and $2b$.
We may pick root vectors $X_{\beta},X_{\beta'},X_{\gamma}$ in the root spaces of $\beta,\beta',\gamma$ such that 
\[
\theta^b(X_\beta)= X_{\beta'},\quad \theta^b(X_{\beta'})=X_\beta,\quad
\theta^b X_\gamma = \theta^b [X_\beta,X_{\beta'}] = [X_{\beta'},X_\beta] = -[X_\beta,X_{\beta'}] = -X_\gamma.
\]
Note the sign $(-1)$ that appears for the orbit $[\gamma]$.
We choose root vectors on the entire orbits by $\theta^i X_\delta=X_{\theta^i \delta}$, for $i=1,\ldots,b-1$ and
$\delta\in\{\beta,\beta',\gamma\}$.
We compute the determinant on these two orbits as before.  
For the orbit $[\gamma]$, we obtain
 $1+\prod_{\gamma'\in [\gamma]} {q e^{\gamma'}} = 1+ q^b e^{\alpha/2}$.
The orbit $[\beta]$ gives $1-q^{2b} e^{\alpha/2}$.
\end{proof}


In the special case $\theta=1$, the matrix $q \theta E$ is diagonal, every orbit has cardinality $1$,
and the partition function
is a product over positive roots 
$P(E,q) = \prod_{\beta\in\Psi^+} (1- q e^\beta)^{-1}$.  This is the classical $q$-partition function.


\begin{corollary}[twisted Weyl denominator]\label{cor:prod1} Specializing to $q=1$, we have
\[
P(E,1) = \prod_{\alpha\in\Sigma^+_1} (1-e^{\alpha})^{-1}.
\]
\end{corollary}

\begin{proof}  Set $q=1$ in the lemma and observe that $d_\alpha(1)=1-e^\alpha$.
\end{proof}


\begin{corollary}\label{cor:weyl-p}  
%$W^\theta$ permutes the roots of $\Sigma_1\subset Y^*$ and
for all $w\in W^\theta$,
\[
P(w(E),q) P(w(E)^{-1},q) = P(E,q)P(E^{-1},q).
\]
\end{corollary}

\begin{proof} 
By the lemma,
\[
P(E,q)P(E^{-1},q) = \prod_{\alpha\in \Sigma_1} d_{\alpha}(q)^{-1},
\]
as $\alpha$ runs over the full root system $\Sigma_1$.
The result follows by observing  that $w\in W^\theta$ permutes $\Sigma_1$, preserving the  diagram type $A_k$
 and constant $b$ attached to each root.
\end{proof}


\subsection{twisted Weyl character formula}

We review the proof of the Weyl-character formula, as presented in \cite{kostant1961lie}, 
\cite{jantzen1977darstellungen}, \cite{wendt2001weyl}, and \cite{kumar2009characters}.
At the same time, we consider various $q$-deformations of the standard formulas.

Let $\lambda$ be a dominant weight in $X^*(\hat T)^\theta = X^*(\hat S)$.  Let $V_\lambda$ be the irreducible module
of $\hat G$ with highest weight $\lambda$.  The $\theta$-invariance of $\lambda$ implies that $V_\lambda$
extends uniquely to a representation of $\hat G \rtimes \g{\theta}$ such that $\theta v = v$ for $v$ in the
highest weight space of $V_\lambda$.  We let $\tau_\lambda$ be the character on $V_\lambda$, restricted to $\hat G\rtimes\theta$.  Any such element is $\hat G$-conjugate to $\hat T\rtimes\theta$.
%This restriction depends only the $\hat G$-conjugacy class of elements $t\rtimes \theta\in \hat T\rtimes\theta$.
The $\theta$-conjugacy class of $t\theta\in \hat T\rtimes\theta$ 
depends only on the image of $t$ in $\hat S$.  
Thus, we may consider
$\tau_\lambda\in \ring{C}[X^*(\hat S)] =\ring{C}[Y^*]$.  Furthermore, $\tau_\lambda$ is $W^\theta$-invariant.

Let $\rho = \rho(\Psi^+) = \rho(\Sigma^+_1)$.
We define a dot operator $w\bullet \mu = w(\mu+\rho)-\rho$, for $w\in W^\theta$ and $\mu\in Y^*$.
We define an alt-symmetrizer operator
\[
J:\ring{C}[Y^*]\to \ring{C}[Y^*],\quad J(f) = \sum_{w\in W^\theta} (-1)^{\ell(w)} w(f e^\rho) e^{-\rho}.
\]

\begin{theorem}[twisted Weyl character]  For every dominant weight $\lambda\in X^*(\hat T)^\theta = X^*(\hat S)$.
The irreducible representation $V_\lambda$ of ${}^LG$ has character $\tau_\lambda\in \ring{C}[Y^*]$ on
$\hat G\rtimes \theta$, where
\[
\tau_\lambda = J(e^\lambda) P(E^{-1},1).
\]
\end{theorem}


The Weyl denominator $P(E^{-1},1)$ is computed in Corollary \ref{cor:prod1}.  
If we take $\lambda=0$, then $\tau_\lambda=1$, and the Weyl character formula gives 
a second formula for the Weyl denominator:
\begin{equation}\label{eqn:wd2}
1= J(1) P(E^{-1},1).
\end{equation}
It is a remarkable consequence
of the Weyl character formula that
the twisted character $\tau_\lambda$ is identical to the irreducible character of 
$\hat G_\theta$ with highest weight $\lambda$.


\begin{proof} We follow Kostant \cite{kostant1961lie}.
Let $\n$ be the Lie algebra of $\hat N$, considered as a module of ${}^L\hat T=\hat T\rtimes\g{\theta}$ by the adjoint representation,
and let $\n'$ be its contragredient.  We write $\chi_j$ for the character of the exterior power $\Lambda^j \n'$.
  We write $\tilde\chi_q = \sum_j (-q)^j\chi_j$
for the $q$-graded virtual character on the sum of $\Lambda^j \n'$, with grading $(-q)^j$ on the $j$th summand.  

The character $\tilde\chi_q$ evaluated at $\theta t$ depends only on the image $s\in\hat S$ of $t\in \hat T$.
We have 
\[
P(E^{-1},q)^{-1}(s) = \det(1- q\theta t;\n') = \sum_j (-q)^j \chi_j(t\theta) = \tilde\chi_q(t\theta).
\]
The sum is obtained from
 the determinant  by picking a basis of eigenvectors of $\theta t$ on $\n'$ and expanding into a polynomial
in $q$.
We have $E^{-1}$ rather than $E$ because $\n'$ is the contragredient of $\n$.
This gives
\begin{equation}\label{eqn:tilde}
\tilde\chi_q P(E^{-1},q) = 1.
\end{equation}
%We now have an explicit product formula for the character $\tilde\chi_q$ as given by Lemma \ref{lemma:prod}.

Upon specialization to $q=1$, 
the spaces $C^j=\Lambda^j \n'\otimes V_\lambda$ are the terms of a cochain complex of ${}^LT$-modules.
We consider the virtual character $\tilde \tau_\lambda$ on  
the sum of $C^j$, with grading $(-1)^j$ on $C^j$.  
By an Euler-Poincar\'e argument, 
$\tilde\tau_\lambda$ equals the character on the cohomology of the complex.  The cohomology has 
been computed explicitly \cite{kostant1961lie}.
These computations show that for each $w\in W^\theta$, the weight $e^{w\bullet \lambda}$ 
occurs once in cohomology with sign $(-1)^{\ell w}$.
Thus, in terms of the operator $J$, we have
\[
\tilde \tau_\lambda = J(e^\lambda) = \sum_{w\in W^\theta} (-1)^{\ell(w)} e^{w\bullet\lambda}.
\]

We have  a product decomposition $\tilde \tau_\lambda = \tilde \chi_{1}\tau_\lambda $ by the description of $C^j$ as
a tensor product.
Multiplying both sides by $P(E^{-1},1)$, and using
Equation \ref{eqn:tilde}, we obtain the twisted Weyl character formula
\begin{equation}
\tau_\lambda = J(e^\lambda) P(E^{-1},1).
\end{equation}
\end{proof}
%The Weyl denominator is given explicitly by Corollary \ref{cor:prod1}.

It is natural to extend $\tau_\lambda$ to a $q$-character by defining $\tau_{\lambda,q}$ by
$\tilde \tau_\lambda = \tilde \chi_q\tau_{\lambda,q} $, so that
\begin{equation}
\tau_{\lambda,q} = J(e^\lambda) P(E^{-1},q).
\end{equation}
We leave it as a research problem to find interpretations of $\tau_{\lambda,q}$, along the lines of Kazhdan-Lusztig
polynomials.  Kato and Lusztig give an answer when $\theta=1$.


\subsection{Macdonald's formula}\label{sec:macdonald}

% In particular, $P(E^{-1},1)$ is the denominator of the twisted Weyl integration formula for the root system $\Sigma_1$.


Let $K$ be a hyperspecial maximal compact subgroup of $G$.  The spherical Hecke
algebra $\H_{\ring{C}}(G//K)$ 
is the convolution algebra of all complex-valued compactly support $K$-biinvariant functions
on $G$.  It has a linear basis consisting of characteristic functions $f_\mu$ of double cosets
$K\varpi^\mu K$, for $\mu\in P^+$.    By the Satake isomorphism, $\H(G//K)$ is isomorphic
to the algebra $\ring{C}[Y^*]^{W^\theta}$.   We write $\hat f_\mu\in \ring{C}[Y^*]$ 
for the image of $f_\mu$
under the Satake isomorphism.

We continue in the context of a complex group $\hat G \rtimes \g{\theta}$ and keep earlier notation.
As usual, we identify elements of $\ring{C}[Y^*]$ with functions on $\hat S$.  
As before $\Phi=\Psi^\vee$ and $\Psi = \Phi^\vee$ are dual root systems.
Let $\rho^\vee = \rho(\Phi^+)\in X_*(\hat T)$.
%Let 
%\[
%d(q^{-1}\theta;\hat T)=\det(1- q^{-1}\theta;X^*(\hat T)\otimes \ring{C})^{-1}.
%\]


For each subset $S$
of the set $\Delta_1$ of simple  roots in $\Sigma^+_1$,
 let $W_S\le W^\theta$ be the group generated by the reflections in $S$.
Let $\ell' w$ be the length of $w\in W$ (as a function of the Weyl group $W$, and not the Weyl group $W^\theta$).
Let $Q_S(q^{-1}) = \sum_{w\in W_S} q^{-\ell'w}$.  We abbreviate $Q(q^{-1}) = Q_{\Delta_1}(q^{-1})$.
For each $\mu\in P^+\subset Y^*$, let $S(\mu)$ be the subset of $\Delta_1$ such that $\g{\mu,\alpha^\vee}=0$ iff $\alpha^\vee\in S(\mu)$.

\begin{theorem}[Macdonald's formula]\label{thm:macdonald}
Let $G$ be an unramified $p$-adic reductive group with $L$-group ${}^LG = \hat G \rtimes \g{\theta}$.
For each $\mu\in P^+$, 
let $\hat f_\mu$ be the Satake transform of the characteristic function of $K\varpi^\mu K$, viewed as an element
of $\ring{C}[Y^*]^{W^\theta}$.  Then
\[
\hat f_\mu = \frac{q^{\g{\mu,\rho^\vee}}}{ Q_{S(\mu)}(q^{-1})} \sum_{w\in W^\theta} e^{w\mu} \frac{P(w(E)^{-1},1)}{P(w(E)^{-1},q^{-1})}.
\]
\end{theorem}

%This formula reworks Macdonald's classical formula  to remove every vestige
%of the $p$-adic group.
The partition function
encodes the constants $q_\alpha$, $q_{\alpha/2}$ that occur in the traditional formula \cite{macdonaldspherical}.  
%The relative reduced root system $\Sigma_0$ on the $p$-adic group used by Macdonald has been eliminated.  
Our formula is closely
tied to the root system $\Sigma_1$ of $\hat G_\theta$
that occurs in the twisted Weyl character formula for ${}^LG$.  
%(See Corollary \ref{cor:prod1}.)  
%We warn the reader that the reduced root system $\Sigma_1$
%is different from a non-reduced root system $\subseteq \Sigma_0 \cup \frac{1}{2}\Sigma_0$ 
%with the same name used by Macdonald.  More precisely, 
%recall that $\Sigma_1^\vee$ is the set of indivisible roots in that non-reduced root system.
The formula in the theorem was previously known when $G$ is split  ($\theta=1$).

There is a related formula for the spherical function $\Gamma:P^+\times\hat S\to\ring{C}$ that we mention.
For every $\mu\in P^+$, 
\begin{equation} 
\Gamma_\mu = 
\frac{q^{-\g{\mu,\rho^\vee}}}{ Q(q^{-1})} \sum_{w\in W^\theta} e^{w\mu} \frac{P(w(E)^{-1},1)}{P(w(E)^{-1},q^{-1})}.
\end{equation}


\begin{proof}[Proof of Macdonald's formula]
Our proof will relate the formula in the theorem to the standard form of Macdonald's formula.
Macdonald's formula is elaborated 
in \cite{casselman1980unramified} and \cite{casselman2005companion}.
In the following discussion, we index terms by $\alpha\in\Sigma_{red}$ (or $\alpha^\vee\in \Sigma_1 = (\Sigma_{red})^\vee$), 
although terms in Macdonald's 
formula are traditionally indexed by $\Sigma^{red}$, the set of nonmultipliable roots in $\Sigma$.  
This is a harmless change, because $\Sigma_{red}$ is
in natural bijection with $\Sigma^{red}$ by sending each indivisible root $\alpha$ 
to the homothetic root $k\alpha\in\Sigma^{red}$.

Recall that for
each $\alpha\in \Sigma^+_{red}$, associated with an orbit $\alpha=[\beta]$ in $\Phi$, 
there
is a diagram type $A_k$, for some $k\in\{1,2\}$, and
cardinality $b$ (the number of connected components of the Dynkin diagram of $\beta$).
%Recall that $\Sigma^\vee$ can be identified with the set of $\theta$-orbits of $\Phi^\vee$.
%The degree $[F_1:F]$ is the orbit cardinality of the nonmultipliable root homothetic to $\alpha\in \Sigma_{red}$
%and the orbit cardinality of the corresponding $\theta$-orbit of $\Psi$.
%and $[E:F]$ is the orbit cardinality of the indivisible root homothetic to $\alpha$.
Casselman and Macdonald construct an element $a_{\alpha}\in T$, for each $\alpha\in\Sigma_{red}$.
Let $\alpha_1 = \alpha^\vee\in \Sigma_1$ be its coroot.
By the explicit formulas in \cite{casselman2005companion}, for diagram type $A_k$,
we have $a_\alpha = (k\alpha)^\vee(\varpi) = (\alpha_1/k)(\varpi)$.  
% confirmed by Casselman in email July 14 2016 that we take \alpha to be the nonmultipliable root.
%Write $\alpha^\dag$ as the restriction of $\beta^\vee$ for some $\beta\in\Phi^\vee$. Then
%e then have by the norm Equation \ref{eqn:norm},
Let $s\in \hat S$, and let $\chi_s\in\op{Hom}(T,\ring{C}^\times)$ be the associated
unramified character.  Then
\[
\chi_s(a_{\alpha}) = \chi_s((\alpha_1/k)(\varpi)) = e^{\alpha_1/k}(s).
\]
Macdonald's formula is traditionally expressed in terms of the constants $\chi_s(a_\alpha)$,
which we rewrite in terms of $e^{\alpha_1/k}$, for $\alpha_1\in\Sigma^+_1$.

For each $\alpha_1\in\Sigma^+_1$, we define
 a function $c_{\alpha_1}:\hat S\to\ring{C}$ by
%Assume $\alpha\sim \alpha_1\in \Sigma^+_1$.
%Equivalently, the function $c_\alpha$ can be reindexed by  the 
%corresponding coroot $\alpha^\vee=\alpha_1\in\Sigma^+_1$. Set
% with
%data in ${}^LG$.  
\[
c_{\alpha_1}(s) = d_{\alpha_1}(q^{-1})/d_{\alpha_1}(1),
\]
following the definition of $d_{\alpha_1}$ in Equation \ref{eqn:d}.
%\begin{cases}
%\frac{1 - q^{-1}_1 \chi_s (a_{\alpha})} {1 -\chi_s(a_{\alpha})} =
%\frac{1 - q^{-1}_1 e^{\alpha^\vee}} {1 -e^{\alpha^\vee}} (s),
%& \text{if type I; }\\[1em]
%\frac{(1 - q^{-2}_1 \chi_s (a_{\alpha}))(1+ q^{-1}_1 \chi_s(a_\alpha))} {1 -\chi^2_s(a_{\alpha})} =
%\frac{(1 - q^{-2}_1 e^{\alpha^\vee/2})(1+ q^{-1}_1 e^{\alpha^\vee/2})} {(1 - e^{\alpha^\vee/2})(1+e^{\alpha^\vee/2})} (s),
%& \text{otherwise}.
%\end{cases}
%Recall that $q_1 = q_{F_1} = q^{b(\alpha^\vee)}$ depends on the root $\alpha$, even if that dependence is not
%indicated in the notation.
%The functions indexed by $\Sigma^+_{red}$ relate to the traditional form of Macdonald's formula,
%and the functions indexed by $\Sigma^+_1$ relate to Theorem \ref{thm:macdonald}.
We define a function $\gamma:\hat S\to \ring{C}$ by
\[
\gamma(s)  = \prod_{\alpha_1\in \Sigma^+_1} c_{\alpha_1}(s^{-1}).
\]
It follows from Lemma \ref{lemma:prod} that
\begin{equation}\label{eqn:gamma}
\gamma = P(E^{-1},1)/P(E^{-1},q^{-1}).
\end{equation}
%To see this, expand both $\gamma$ and the partition function as a product over $\alpha^\vee\in \Sigma^+_1$,
%using the product formula Lemma \ref{lemma:prod}.  Match
%factor by factor.  
%As in the proof of Corollary \ref{cor:prod1},
%every non-type-I orbit in $\Psi$ is part of
% a pair of orbits with the same norm, opposite signs $\epsilon=\pm 1$, and 
%different orbit cardinalities $b$ and $2b$.

The traditional Macdonald formula is expressed as a sum of $\gamma$ over $W^\theta$.
If we use Equation (\ref{eqn:gamma}) to substitute for $\gamma$ in the traditional formula,
then Theorem \ref{thm:macdonald} is the result.

The formula for $Q_S(q^{-1})$ relies on the observation that $q^{\ell' w} = \op{card}(IwI/I)$, where $I$
is an Iwahori subgroup, and the length is computed with respect to the absolute Weyl group $W$ \cite[p.74]{carter1985finite}.
\end{proof}

\subsection{Plancherel measure}
We continue in the same context, letting
 $G$ be an unramified reductive group and  $K$ a hyperspecial maximal compact subgroup.
Let ${}^LG = \hat G\rtimes \g{\theta}$, and we continue with notation from previous sections.

Let $\hat S_1$ be the maximal compact subgroup of $\hat S$.  Let $ds$ be the Haar measure on $\hat S_1$ normalized
so that $\hat S_1$ has volume $1$.
Let $(\cdot,\cdot)$ be the inner product with respect to the Haar  measure on $\hat S_1$. That is,
\begin{equation}
(f_1,f_2) = \int_{\hat S_1} f_1(s) \bar f_2(s) ds.
\end{equation}
Multiplicative characters of $\hat S_1$ are orthonormal: $(e^\lambda,e^\mu) = \delta_{\lambda,\mu}$.  


We define a measure on $\hat S_1$ by
\begin{equation}
dm(s) = \frac{Q(q^{-1})}{\op{card}(W^\theta)}\frac{P(E,q^{-1}) P(E^{-1},q^{-1})}{P(E,1) P(E^{-1},1)} ds.
\end{equation}
It will be checked below that
the partition functions defining 
$dm(s)$
have nonzero  denominators on $\hat S_1$.
Let $\g{\cdot,\cdot}$ be the pairing provided by this measure on continuous functions on $\hat S_1$.
That is, 
\begin{equation}
\g{f_1,f_2} = \int_{\hat S_1} f_1(s) \bar f_2(s) dm(s).
\end{equation}



The proof of the Plancherel measure uses the following averaging lemma.

\begin{lemma}\label{lemma:average} 
Let $f$ be continuous on $\hat S_1$ and $W^\theta$-invariant.
Then
\[
\g{f,\hat f_\mu} = c_\mu  (f, e^\mu\frac{ P(E,q^{-1})}{P(E,1)}),
\quad\text{where }\quad
c_\mu = q^{\g{\mu,\rho^\vee}}\frac{ Q(q^{-1})}{Q_{S(\mu)}(q^{-1})}.
\]
\end{lemma}

\begin{proof}  
%We begin with an observation about averages over $W^\theta$.
The  measure $dm(s)$ is $W^\theta$-invariant by Corollary \ref{cor:weyl-p}.  As a consequence,
we may push a sum over $W^\theta$ over to $f$ to obtain
\begin{equation}\label{eqn:inv}
\g{f,\sum_{w\in W^\theta} w(f_1)} = \card(W^\theta)\g{f,f_1},
\end{equation}
for any continuous function $f_1$ on $\hat S_1$.
In particular, assume that $f_1=\hat f_\mu$, which Macdonald's
formula presents a sum over $W^\theta$.
This means that in $\g{f,\hat f_\mu}$, we may replace 
$\hat f_\mu$  with
the $w=1$ term  in Macdonald's formula.
%$q^{\g{\mu,\rho^\vee}} e^{\mu} P(E^{-1},1)/{Q_{S(\mu)}(q^{-1}) P(E^{-1},q^{-1})}$

The constant $c_\mu$ is the product of the constants appearing in Macdonald's formula, the Plancherel measure,
and Equation \ref{eqn:inv}:
\[
c_\mu = \left(\frac{q^{\g{\mu,\rho^\vee}}}{Q_S(q^{-1})}\right)\left(\frac{Q(q^{-1})}{\op{card}(W^\theta)}\right) \op{card}(W^\theta).
\]

The conjugate of $e^\mu$ is $e^{-\mu}$ and of $E$ is $E^{-1}$ on $\hat S_1$, because $\bar s = s^{-1}$, for $s\in \hat S_1$.
We have
\begin{align*}
\g{f,\hat f_\mu} &=
c_\mu\int_{\hat S_1} f \left(e^{-\mu} \frac{P(E,1)}{P(E,q^{-1})}\right) \left(\frac{P(E,q^{-1}) P(E^{-1},q^{-1})}{P(E,1)(E^{-1},1)}\right) ds\\
&=
c_\mu\int_{\hat S_1} f \left(e^{-\mu} \frac{P(E^{-1},q^{-1})}{P(E^{-1},1)}\right) ds\\
&=
c_\mu (f, e^\mu\frac{ P(E,q^{-1})}{P(E,1)}).
\end{align*}
\end{proof}

\begin{theorem}[Plancherel measure]
The denominators are nonzero on $\hat S_1$ in the partition functions defining 
$dm(s)$. 
The Plancherel measure is supported on $\hat S_1$ and is given explicitly by $dm(s)$ on $\hat S_1$.
\end{theorem}

\begin{remark}
We recall the defining property of the Plancherel measure
for the spherical Hecke algebra.  The Plancherel measure  is $dm(s)$  if
for all $f_1,f_2\in \H_{\ring{C}}(G,K)$,
\[
\int_G f_1(g) \bar f_2 (g) dg = \int_{\hat S} \hat f_1(s) \bar {\hat f}_2 (s) dm(s).
\]
When $\mu\ne\lambda$,
the integral on the left is trivial to compute for the functions $f_1 = f_\lambda$ and $f_2 = f_\mu$
because the functions $f_\mu$ and $f_\lambda$ have disjoint support, giving $0$.
When $\mu=\lambda$, the integral on the left is the volume of $K\varpi^\mu K$.
This volume is $c_\mu q^{\g{\mu,\rho^\vee}}$ by \cite{casselman2005companion}, where $c_\mu$ is
the constant in Lemma \ref{lemma:average}.
The proof of the theorem proceeds by computing the inner products $\g{\hat f_\lambda,\hat f_\mu}$
and showing that they give the same values as the integral on the left.
\end{remark}

\begin{proof}  
The proof, which we review, is due to Macdonald \cite[Ch.V]{macdonaldspherical}.
It is what he calls {\it the standard case}.  
Choose any total order $(<)$ on $P^+\subset Y^*$ such that 
$\lambda < \lambda + \alpha$, whenever $\alpha = N\beta$ is the norm of a positive root $\beta\in\Psi^+$.

By Lemma \ref{lemma:prod},
the ratio $P(E,q^{-1})/P(E,1)$  factors into a product of terms of the form $(1- t)/(1- q^{-b} t)$, 
where each $t = \epsilon e^{N\beta} = \epsilon e^\alpha$ for
some root $\beta$ with norm $\alpha$, 
for some sign $\epsilon\in \{\pm 1\}$, and for some $b\ge 1$.
For any $p$-adic field $F$, we have $q = q_F > 1$ and $q^{-b} < 1$.  Thus we have an absolutely convergent 
expansion
\begin{equation}\label{eqn:t}
\frac{1- t}{1- q^{-b} t} = 1 + (q^{-b}-1) t (1+ q^{-b} t + q^{-2b} t^2 + \cdots),
\end{equation}
noting that $|t| = |\alpha(s)|=1$ at each $s\in \hat S_1$.  In particular, the denominator of $P(E,q^{-1})/P(E,1)$ does not
vanish.  Similarly, the
denominator of $P(E^{-1},q^{-1})/P(E^{-1},1)$ does not vanish because $|q^{-b} t^{-1}|\ne1$, giving the nonvanishing of the
denominator in the measure $dm(s)$.

By multiplying the series expansions (Equation \ref{eqn:t}) associated with each factor of $P(E,q^{-1})/P(E,1)$,
it follows that for each $\mu\in P^+$ we have an absolutely convergent expansion of the form
\[
e^\mu \frac{P(E,q^{-1})}{P(E,1)} = e^\mu +\sum_{\mu< \mu'} a_{\mu'} e^{\mu'},
\] 
for some coefficients $a_{\mu'}$ that turn out not to matter.

We compute $\g{\hat f_\lambda,\hat f_\mu}$.
We may assume without loss of generality that $\lambda \le \mu$.
%we have $\g{\hat f_\lambda,\hat f_\mu} = c_\mu (\hat f_\lambda,e^\mu P(E,q^{-1})/P(E,1))$.

We have a finite expansion (see Equation \ref{eqn:s} below)
\[
\hat f_\lambda = q^{\g{\lambda,\rho^\vee}} m_\lambda + \sum_{\lambda' <\lambda } s_{\lambda\,\lambda} m_{\lambda'}.
\]
Also, for $\lambda',\mu'\in P^+$, we have
\[
(m_{\lambda'},e^{\mu'}) = \delta_{\lambda',{\mu'}}.
\]
The function $\hat f_\lambda$ is $W^\theta$-invariant, which justifies the use of 
the averaging lemma (Lemma \ref{lemma:average}) to simplify the inner product.
Invoking the averaging lemma, expanding everything, and integrating term by term, we have
\begin{align*}
\g{\hat f_\lambda,\hat f_\mu} &= c_\mu (\hat f_\lambda, e^\mu \frac{ P(E,q^{-1})}{P(E,1)})\\
&= c_\mu (q^{\g{\lambda,\rho^\vee}} m_\lambda,e^\mu) + \sum_{\lambda' < \lambda\le\mu < \mu'}
c_\mu s_{\lambda',\lambda} a_{\mu'} (m_{\lambda'},e^{\mu'})\\ 
&= c_\mu q^{\g{\mu,\rho^\vee}} \delta_{\lambda,\mu}.
\end{align*}

Comparing this inner product with the  inner products in the remark, we see that the proof is 
complete.
\end{proof}





\subsection{inverting weight multiplicities}

This section follows  van Leeuwen's algorithm to invert the weight multiplicity
matrix~\cite{vanleeuwen}.  
For type $A_n$, van Leeuwen's formula agrees with the inverse of the Kostka
matrix described in \cite{duan}.

We have two bases of $\ring{C}[Y^*]^{W^\theta}$, given by $\{m_\lambda\}$ and $\{\tau_\lambda\}$, indexed
by $\lambda\in \dom$.  
The change of basis matrix expressing $\tau_\lambda$ in terms of $m_\mu$ is the weight multiplicity
matrix $m_{\lambda,\mu} = (\tau_\lambda,e^\mu)$.  
In the reverse direction, for $\mu\in P^+$,
we have a change of basis matrix $n_{\mu,\lambda}$ 
\begin{equation}\label{eqn:n}
m_\mu = \sum_{\lambda} n_{\mu,\lambda} \tau_\lambda,
\end{equation}
with $\mu,\lambda\in P^+$.
This section gives a formula for $n_{\mu,\lambda}$.  

We have a set $Y^*_0\subseteq Y^*$ of characters $\lambda$ such that $\lambda$ is fixed 
(that is, $w\bullet \lambda = \lambda$) by some
reflection  $w\in W^\theta$.  For each $w\in W^\theta$, we define
\begin{equation}
Y^*_w = \{\lambda\in Y^*\mid w\bullet \lambda \in\dom\}.
\end{equation}
These sets partition $Y^*$, so that each $\lambda\in Y^*$ belongs to a unique $Y^*_x$, for $x\in W^\theta\cup\{0\}$.
Let $e_w$ be the characteristic function of $Y^*_w$.

Recall that we have defined an operator
$J$ that has the property $J(f) = f J(1)$ if $f\in \ring{C}[Y^*]^{W^\theta}$.
In particular, using the Weyl denominator formula (\ref{eqn:wd2}), we find that
\begin{equation}
 J(\tau_\lambda) = \tau_\lambda J(1) = J(e^\lambda) P(E^{-1},1) J(1) = J(e^\lambda),\quad  \lambda\in P^+.
\end{equation}
In the opposite direction, we define a desymmetrizer operator $L$ by
\[
L(e^\mu) = \begin{cases}
0,& \mu\in Y^*_0;\\
(-1)^{\ell{w}} e^{w\bullet \mu},& \mu\in Y^*_w.
\end{cases}
\]
We extend $L$ linearly to $\ring{C}[Y^*]$.
The operator $L$ can be characterized as the unique linear operator whose range is supported on
the dominant weights and such that $J(f) = J(L(f))$, for $f\in \ring{C}[Y^*]$.
By this characterization, $L(\tau_\lambda) = e^\lambda$, for $\lambda\in\dom$.  This means that
for any $f = \sum_{\lambda\in P^+} c_\lambda \tau_\lambda \in \ring{C}[Y^*]$, the coefficient $c_\lambda$
is the coefficient of $e^\lambda$ in $L(f)$.  We have 
\[
L(e^\mu) = \sum_{w\in W^\theta} (-1)^{\ell w} e^{w\bullet \mu} e_w(\mu).
\]

Recall that $S(\mu)$ is defined as the set of simple roots
such that 
$\g{\alpha^\vee,\mu}=0$ iff $\alpha\in S(\mu)$.
%For each subset $S$ of the set of simple roots,
%we have a set
%$P^+_S \subseteq P^+$ given by the set of $\mu\in P^+$ such that
%
%The sets $P^+_S$ partition $P^+$. 
Recall also that $W_S\le W^\theta$ is the subgroup generated by reflections in $S$.
%We define
%\[
%E_{S,w',w} = \{(\mu,\lambda)\in P^+_S\times \dom \mid w'\mu\in Y^*_{w},\quad w\bullet(w'\mu)=\lambda\}.
%\]
%indexed by subsets $S$, cosets $w'\in W^\theta/W_S$, and elements $w\in W^\theta$.
%We have the following explicit form of van Leeuwen's formula.

\begin{lemma}[van Leeuwen]  For each subset $S$ of the set of simple roots of $\Sigma^+_1$,
and for every $\mu\in P^+$ with $S = S(\mu)$,
%the function $(\mu,\lambda)\mapsto n_{\mu,\lambda}$ restricted
%to $P^+_S\times \dom$ is 
\[
n_{\mu,\lambda}=\sum_{(w',w)\in (W^\theta/W_S)\times W^\theta} (-1)^{\ell(w)} e_w(w'\mu) \delta_{w\bullet (w'\mu),\lambda}. 
\]
\end{lemma}

\begin{proof}  
\[
m_\mu = \sum_{w'\in W^\theta/W_S} e^{w' \mu}.
\]
Then
\begin{align*}
n_{\mu,\lambda} 
    &= (\sum_{\lambda'} n_{\mu,{\lambda'}} e^{\lambda'},e^\lambda) \\
     &= (L(\sum_{\lambda'} n_{\mu,\lambda'} \tau_{\lambda'}),e^\lambda) \\
     &= (L(m_\mu),e^\lambda) \\
     &= \sum_{w'\in W^\theta/W_S} (L(e^{w'\mu}),e^\lambda)\\
     &= \sum_{w'\in W^\theta/W_S} \sum_{w\in W^\theta} (-1)^{\ell w} e_w(w'\mu) (e^{w\bullet (w'\mu)},e^\lambda)
%     &= \sum_{w'\in W^\theta/W_S} \sum_{w\in W^\theta} (-1)^{\ell w} \op{char}\, E_{S,w',w}(\mu,\lambda).
\end{align*}
\end{proof}

\subsection{geometric Satake}

Let $K$ be a hyperspecial maximal compact subgroup of $G$.  In the usual
formulation,  the Satake transform is an isomorphism of the 
Hecke algebra $\H_\ring{C}(G//K)$, with the $W^\theta$-invariant functions in the
group algebra $\ring{C}[A]$.  As first pointed out by Langlands, this is the
space of conjugation invariant functions on the coset $\hat G\rtimes \theta$ in
${}^LG$.  For split groups, the geometric Satake transform reformulates the
transform in the language of sheaves and
in terms of the representation ring of $\hat G$ \cite{mirkovic2007geometric}.
For a geometric approach to geometric Satake that includes unramified groups, 
see \cite{zhu2011geometric}.
%Geometric Satake is generally expressed sheaf-theoretically. 

The identities
we give should be viewed as formal analogues of geometric Satake
by the function-sheaf dictionary. % \cite[\S7]{haines2003iwahori}.
Working formally with irreducible characters,
the geometric Satake transform expresses each $\hat f_\lambda$ in terms of the basis $\tau_\mu$ of irreducible
characters for the root system $\Sigma_1$:
\begin{equation}\label{eqn:geometric-satake}
\hat f_\lambda = \sum_\mu g_{\lambda,\mu} \tau_\mu.
\end{equation}
Casselman gives a formula for the coefficients $g_{\lambda,\mu}$ 
when $G$ is split \cite{casymmetric}.
In this section, we  extend the result to $G$ unramified.
The statement here is less polished than what is known in the split case \cite{casymmetric}.
The proof we present here is based on van Leeuwen's algorithm.



Define
\[
C = \{  - \sum_{\alpha\in S}\alpha \ \ \mid S \subseteq \Psi^+ \}^\theta;
\]
Define $p_\mu(q^{-1})$ by
\begin{equation}\label{eqn:p}
 P(E^{-1},q^{-1})^{-1} = \sum_{\mu\in C} p_\mu(q^{-1}) e^{\mu},
\text{\ \ so }  P(w(E)^{-1},q^{-1})^{-1} = \sum_{\mu\in C} p_\mu(q^{-1}) e^{w\mu}.
\end{equation}


\begin{theorem}  Let $\lambda\in P^+$ and let $S=S(\lambda)$.
\[
\hat f_\lambda = \frac{q^{\g{\lambda,\rho^\vee}}}{Q_S(q^{-1})} 
\sum_{\mu\in C}\left(\sum_{w\in W^\theta} (-1)^{\ell w} p_{\mu}(q^{-1}) e_w(\lambda+\mu)\right)  \tau_{w\bullet(\lambda+\mu)}.
\]
\end{theorem}


\begin{proof}
Abbreviate $r_\lambda = q^{\g{\lambda,\rho^\vee}}/Q_S(q^{-1})$.
By the Weyl denominator product formula (Corollary \ref{cor:prod1}),
\begin{equation}
P(w(E),1) = (-1)^{\ell w} e^{w\rho - \rho} P(E,1),
\end{equation}
Then expanding Macdonald's formula using this and Equation \ref{eqn:p}, we get
\[
\hat f_\lambda = r_\lambda \sum_{\mu\in C} p_\mu(q^{-1}) P(E^{-1},1) J (e^{\lambda+\mu}),
\]
where we have absorbed the sum over $W^\theta$ in Macdonald's formula into $J$.
We observe that 
\begin{align*}
L(\hat f_\lambda) &= r_\lambda \sum_{\mu\in C} p_\mu(q^{-1}) L(P(E^{-1},1) J(e^{\lambda+\mu})) \\
&= 
r_\lambda \sum_{\mu\in C} p_\mu(q^{-1}) L(e^{\lambda+\mu}) \\
&= 
r_\lambda
\sum_{\mu\in C} p_\mu(q^{-1}) \sum_{w\in W^\theta} (-1)^{\ell w} e_w(\lambda+\mu) e^{w\bullet (\lambda+\mu)}.
\end{align*}
Recall that the coefficient $c_\lambda$ of an expansion $f = \sum_\lambda c_\lambda\tau_\lambda$ 
is the coefficient of $e^\lambda$ in $L(f)$.  The result follows.
\end{proof}

There is a second less explicit form of the geometric Satake transform that is obtained as follows.
we have
\[
\hat f_\lambda = \sum_{\mu'} s_{\lambda,\mu'} m_{\mu'},
\]
where the coefficients $s_{\lambda,\mu'}$ are given as $p$-adic integrals (see Equation \ref{eqn:s} below).
By van Leeuwen's formula linking $m_{\mu'}$ to $\tau_\mu$ with coefficient matrix $n_{\mu',\mu}$, 
we obtain the coefficients $g_{\lambda,\mu}$ as a matrix product:
\begin{equation}
\hat f_\lambda = \sum_{\mu',\mu} s_{\lambda,\mu'} n_{\mu',\mu} \tau_{\mu} = \sum_{\mu} g_{\lambda,\mu} \tau_\mu.
\end{equation}

\subsection{a Kato-Lusztig formula}

%\cite{kato1982spherical} \cite{lusztig1983singularities} in the twisted case) for 
Equipped with Plancherel and Macdonald, we obtain an easy Kato-Lusztig formula for the inverse Satake transform.
Our result generalizes a formula that was
 known when $\theta=1$ \cite{kato1982spherical} \cite{lusztig1983singularities}.
Recall the $q$-twisted character  $\tau_{\lambda,q}$ from above.
Write 
\[
\tau_\lambda = \sum_\mu t_{\lambda,\mu}  \hat f_\mu,
\]
for some constants $t_{\lambda,\mu}$.

\begin{theorem}[Kato-Lusztig formula]
The coefficients $t_{\lambda,\mu}$ of the inverse geometric Satake transform are 
\[
t_{\lambda,\mu} =  (\tau_{\lambda,q^{-1}},e^\mu) q^{-\g{\mu,\rho^\vee}}.
\]
\end{theorem}

\begin{proof}
The character $\tau_\lambda$ is $W^\theta$-invariant. 
We use the averaging property (Lemma \ref{lemma:average}) and the Weyl character
formula to compute an inner product.
\begin{align*}
\g{\tau_\lambda,\hat f_\mu}
&=c_\mu(\tau_\lambda,e^\mu \frac{P(E,q^{-1})}{P(E,1)})\\
%&=(*)\left\langle\tau_\lambda, e^{\mu} \frac{P(E^{-1},1)}{P(E^{-1},q^{-1})}\right\rangle \hfill\\
%&=(*)\int_{\hat S_1} \tau_\lambda \left(e^{-\mu} \frac{P(E,1)}{P(E,q^{-1})}\right) dm(s)\hfill \\
%&=
%(*)\int_{\hat S_1} \left(J(e^\lambda) P(E^{-1},1)\right)  
%\left(e^{-\mu} \frac{P(E,1)}{P(E,q^{-1})}\right)
%\left(\frac{P(E,q^{-1}) P(E^{-1},q^{-1})}{P(E,1) P(E^{-1},1)}\right) ds\\
&=c_\mu\int_{\hat S_1} \left(J(e^\lambda) P(E^{-1},1)\right) \left( e^{-\mu}\frac{P(E^{-1},q^{-1})}{P(E^{-1},1)} \right) ds\\
&=
c_\mu\int_{\hat S_1} J(e^\lambda) P(E^{-1},q^{-1}) e^{-\mu} ds\\
&= c_\mu(\tau_{\lambda,q^{-1}},e^\mu).\\
\g{\tau_\lambda,\hat f_\mu}
&=\sum_{\mu'} t_{\lambda,\mu'} \g{\hat f_{\mu'},\hat f_\mu} \\
&= t_{\lambda,\mu} c_\mu q^{\g{\mu,\rho^\vee}}.
\end{align*}
\end{proof}






\section{Motivic Integration}

This section reviews the theory of motivic integration as developed by Cluckers and
Loeser~\cite{cluckers2008constructible}.  

\subsection{The Denef-Pas language}

The Denef-Pas language is a three-sorted first-order formal language in the sense of model theory.  
Its intended structures are triples $(F,k_F,\ring{Z})$, 
where $F$ is a valued field with discrete valuation, 
$k_F$ is the residue field of $F$, 
and the value group of $F$ is the ring of integers $\ring{Z}$ . 
The three sorts are $VF$ (the valued-field sort), $RF$ (the residue-field sort), and $\ring{Z}$ (the value-group sort).

In general, a first-order formal language is specified by sets of relation symbols and function symbols.
The Denef-Pas language has the following relation and function symbols.  
The valued-field sort $VF$ has the symbols of the first-order language of rings $(0,1,+,\times)$.  
The residue field sort also has the symbols of the first-order language of rings.  
The value-group sort is the Presburger language of an ordered additive group with symbols $(0,+,\le,\equiv_n)$.  
Here $(\equiv_n)$ is a binary relation symbol for each $n\ge 2$, which is to be interpreted as congruence modulo $n$ in $\ring{Z}$.
In addition, there are two function symbols $\op{ord}:VF\to\ring{Z}$ (interpreted as the valuation on the valued-field) and $\op{ac}:VF\to RF$ 
(interpreted as the angular component map).  
For the structure $(K((t)),K,\ring{Z})$, where $K((t))$ is the field of formal Laurent series, 
the intended interpretation of $\op{ac}$ 
is the function $\sum_{i\ge N} a_i t^i\mapsto a_N$ 
that returns the first nonzero coefficient of the Laurent series (and sending $0\in K((t))$ to $0$).

First-order languages are constructed in the usual way, with formulas built from logical connectives $(\land)$, $(\to)$, $(\lor)$, $\neg$, equality
$(=)$, variables of the three sorts, function symbols, relation symbols, existential quantifiers of each sort, and universal quantifiers of each sort.


Following the terminology of \cite{gordon}, we call  a {\it fixed choice} any set-theoretic data that does not depend in any way on the Denef-Pas
language, its variables, nor on the structures of $VF$ and $RF$.   Examples of fixed-choices that appear in this paper are Weyl groups, abstract groups,
representations of split reductive groups over $\ring{Q}$, and root systems.

\subsection{motivic integration}


Let $\op{Field}_\Q$ be the category of fields of characteristic zero.  

Cluckers and Loeser have used the Denef-Pas language to define various categories.  In particular, there
is a category  $\op{Def}_\Q$ of {\it definable subassignments}, given as follows.
For each $(m,n,r)\in\ring{N}^3$, let $h[m,n,r]$ be the functor from $\op{Field}_\Q$ to the category of sets that assigns
to each field $K$, the set $h[m,n,r](K)=K((t))^m\times K^n\times \ring{Z}^r$.  A {\it subassignment} of this functor is by
definition, a subset $S(K) \subseteq h[m,n,r](K)$ for each $K\in\op{Field}_\Q$.  
A definable subassignment $S$ is  a subassignment for which there exists a formula $\phi$ in the Denef-Pas language such that for each $K\in\op{Field}_\Q$, 
the set of solutions of $\phi$ in $h[m,n,r](K)$ is $S(K)$.
The definable subassignments are the objects of the category $\op{Def}_\Q$.  
A morphism $\phi:X\to Y$ is a definable subassignment 
\[
\phi\subseteq X\times Y\subseteq h[m,n,r]\times h[m',n',r'] = h[m+m',n+n',r+r']
\]
that is the graph of a function $X(K)\to Y(K)$ for each $K\in \op{Field}_\Q$.

A {\it free parameter} refers to a collection of free variables of the same sort in a formula in the Denef-Pas language, ranging over a definable
subassignment.  A bound parameter is similar, except that the variables are all bound by a contiguous block of existential or
a contiguous block of universal quantifiers.

For each definable subassignment $X\in \op{Def}_\Q$, Cluckers and Loeser have defined a ring $C(X)$ of 
{\it constructible motivic functions}.  The construction of this ring is a major undertaking, and we refer the reader
to their articles for details.     The elements of this ring are called constructible motivic functions.  Although
they behave in many ways as functions on $X$,  the elements of the ring are not literal functions in the set-theoretic
sense of function.

If $\phi:X\to Y$ is a morphism of definable subassignments, there is a pullback of functions $\phi^*:C(Y)\to C(X)$.  The
pullback $\phi^*$ is a ring homomorphism, and  pullbacks compose: $(\phi\psi)^* = \psi^* \phi^*$.

If $X\to S$ is a morphism of definable subassignments, there is  a subgroup $I_S C(X)$ of $S$-integrable constructible motivic functions.
The intuitive interpretation of an $S$-integrable function $f$ is a function such that the integral over each fiber of $X\to S$ 
is convergent with respect to the canonical motivic measure.  For a morphism $\phi: X\to Y$ over $S$, there is a 
pushforward $\phi_!:I_SC(X)\to I_SC(Y)$ that is called {\it integration over fibers}.  Pushforwards compose: $(\phi\psi)_! = \phi_!\psi_!$.
In this article, we always deal with bounded constructible functions.  Such functions are always integrable by 
\cite[Prop~12.2.2]{cluckers2008constructible}.
Thus, we do not need to deal with integrability issues.

\subsection{Presburger constructible functions}

The ring of constructible functions is a tensor product $P(X) \otimes Q(X)$.  (This is not quite correct; $C(X)$ is the graded
algebra associated to a filtration on the tensor product.)  In terms of the three sorts of the Denef-Pas language,
data related to the value-group sort $\ring{Z}$ is encoded in $P(X)$ and data related to the residue field sort $RF$ is encoded
in $Q(X)$.  The left-hand side $P(X)$ is a ring of {\it Presburger
constructible functions.}  Every Presburger constructible function $f$ gives a constructible motivic function $f\otimes 1$.

Much of what we do in this article is related to constructible functions on integer lattices.  For this, we work with Presburger
constructible functions rather than the entire ring of constructible motivic functions.

\subsection{volume forms}

Cluckers and Loeser have an extension of motivic integration that allows integration with respect to volume
forms \cite[\S8]{cluckers2008constructible}.  In brief, there is a notion of differential forms on a definable subassignment
and a space of definable positive volume forms.  Each differential form $\omega$ of top degree has an associated volume
form $|\omega|$.   For each morphism $\phi:X\to Y$ over $S$, the pushforward $\phi_!$ extends to a pushforward
$f \mapsto \phi_!(f,\omega)$ with respect to the volume form.   It is to be interpreted loosely as integration over
the fibers of $\phi:X\to Y$ with respect to a volume form constructed from a Leray residue of $\omega$ on the fiber.

\subsection{$p$-adic specialization}

Let $\C$ denote the class of $p$-adic fields.
Let $\C_N\subseteq \C$ denote the subclass of fields whose residue characteristic is at least $p\ge N$.

In general, we only care about what occurs in fields in $\C_N$ for $N$ arbitrarily large.
To make this precise, suppose that we have for some $N$, a function $X$ with domain $\C_N$.
Then by restriction of domain $\C_i$ to $\C_{j}$, for $N\le i\le j$, we may take the filtered colimit of $X_i=X|_{\C_i}$.
Two functions $X$, $X'$ have the same filtered colimit if they are equal in $\C_i$ for some sufficiently large $i$.

Let $X$ be a definable subassignment of $h[m,n,r]$, and let $f$ be a constructible motivic function on $X$.   There exists
an $N$ such that for all $F\in \C_N$, there are specializations
\[
X(F)\subseteq F^m\times k_F^n\times \ring{Z}^r,  \quad f_F: X(F) \to\ring{C},
\]
Only the  filtered colimits of $X$ and $f$ matter.

We warn the reader of a notational overload; we write $X(K)$ or $X(F)$ as $K$ and $F$ range over two quite different
classes of fields.  Different symbols $K$ and $F$  disambiguate the context.
When $K\in \op{Field}_\Q$, the valued field is $K((t))$ and the residue field is $K$; but when $F$ is a $p$-adic field, $F$
is the valued field and its residue field is denoted $k_F$.  We also warn that
we use $K$ both for a hyperspecial subgroup and for $K\in\op{Field}_\Q$.

The specializations have various expected properties.
If $\phi:X\to Y$ is a morphism of definable subassignments, then we have functions $\phi_F:X(F)\to Y(F)$.
When $f$ is $S$-integrable on $X$,  integration $\phi_!(f)$ over fibers  specializes to integration over fibers 
with respect to a canonical measure in
 $p$-adic fields $F\in \C_N$ (for some $N$).


The functions $f_F:X(F)\to\ring{C}$ that come from constructible motivic functions  $f\in C(X)$ have a special form
\begin{equation}\label{eqn:q}
f_F(x) = \sum_i \card(Y_i(F,x)) q_F^{\alpha_{i,F}(x)} \prod_j \beta_{i,j,F}(x)\prod_k \frac{1}{1-q_F^{a_{i,k}}},
\end{equation}
where all sums and products are finite, $\alpha_{i}:X\to\ring{Z}$, $\beta_{ij}:X\to\ring{Z}$ are definable, $q_F$
is the  cardinality of the residue field of $F$, and $a_{i,k}$ are nonzero integers \cite[\S2]{cluckers2011btransfer}.
The filtered colimits of these functions are  {\it $q$-constructible functions}.  Let $C_q(X)$ be the space of
$q$-constructible functions on $X$.
Sometimes we call the specialization of a  definable subassignment a definable set.  
There is an element $\ring{L}$, called the Lefschetz motive, in the ring of constructible motivic functions that specializes to $q_F$
for every $p$-adic field $F$.  When the first factors $Y_i$ are absent from Equation \ref{eqn:q}, we say the function $f$
is Presburger constructible.

We warn the reader that
very different constructible motivic functions can yield the same $q$-constructible function.  For example,
let $[S]\in C(\op{pt})$ be the isomorphism class in the residue sort of the set of nonzero squares, considered as a 
constructible motivic functions on a point.  Similarly, let $[N]$ be the class of the set of nonsquares.  Then, under specialization
to $p$-adic fields, the
two functions are equal:
$[S](F) = [N](F) = (q_F-1)/2$, for $F\in\C_1$. However, $[S]$ and $[N]$ are not at all the same constructible motivic function. Indeed,  their values on 
algebraically closed residue fields $K$ are not equal: $[N](K)$ is the emptyset and $[S](K) = K^\times$ is not.
Another family of examples is provided by isogenous elliptic curves.  They have the same number of points in a finite field, but
they are not generally isomorphic curves.
If a constructible motivic function specializes to a $q$-constructible function that is identically zero, then we call
it a {\it null function}.

The theory of motivic integration specializes to $q$-constructible functions. To integrate a $q$-constructible function $f$, we lift it to 
a contructible motivic function, use Cluckers-Loeser integration there, then take its specialization again.
Two different lifts differ by a constructible motivic function whose integral specializes to zero. Thus, this
is well-defined.

\subsection{definable reductive groups}

Definable reductive groups are understood in the sense of \cite{cluckers2011transfer}, \cite{gordon}.
In this work we restrict to unramified reductive groups (quasi-split and split over an unramified extension).

In the definable context, a reductive group $G\to Z$ lies over a definable subassignment
$Z$ called the {\it cocycle space} of $G$.  In the case of an unramified reductive group that splits over an extension of degree $r$, 
we can take $Z\subseteq h[m,0,0]$.  
The set $Z$ parameterizes lists of coefficients of irreducible monic 
polynomials, each  defining a degree $r$ unramified extension of $F$.  A field extension $E/VF$ of degree $r$ is identified
with $VF^r = VF[x]/(p)$, as $p$ runs over irreducible polynomials parameterized by $Z$.


Recall that there is no Frobenius map in the context of the Denef-Pas language, because it is not possible to take a $q$th power.
Instead, we choose a generator of the Galois group of an unramified extension $E/VF$ and call it the quasi-Frobenius element.
As part of the cocycle space data $Z$, we assume we are given a quasi-Frobenius element $\op{qFrob}$ that corresponds
to the automorphism $\theta$ of $\hat G$.  


A connected split reductive group is treated as a definable subassignment through a faithful representation of the group.
The group is identified with a closed subgroup of $\op{GL}(n,F)$.  Quasi-split reductive groups that split over an unramified degree $r$
extension (parameterized by a cocycle space $Z$) are defined in terms of explicit representations of those groups
in $\op{GL}(n,E)$, where $E/VF$ is treated as above.

If $G$ is an unramified reductive group, we may construct a hyperspecial subgroup $K$ as a definable subassignment of $G$.

A quasi-split reductive group $G$ carries an invariant differential form $\omega$ of top degree, which is described in the
context of definable subassignments in \cite{gordon}.
%We may integrate functions $f\in C_q(G)$ with respect to the invariant measure $|\omega|$.
All integration in this article is assumed to be carried out with respect to invariant measures.  We write, for example,
$\vartheta_!^\inv(f) = \vartheta_!(f,\omega)$ for the invariant integral of a constructible integrable function $f\in C_q(G)$ with respect to the
morphism $\vartheta:G\to\{\op{pt}\}$ to a point using the invariant differential form $\omega$.

\subsection{definability results}\label{sec:definability}

In this section we assume that $G$ is an unramified connected reductive group.  It is treated  as definable subassignment
over a definable cocycle space $Z$.

\begin{lemma}  Let $G$ be an unramified reductive group.  There exists a definable subassignment of $G\times G$ of all pairs
$(\gamma,x)$ such that $\gamma$ is semisimple (possibly singular) and $x$ lies in the connected component of the centralizer of $\gamma$.
\end{lemma}

\begin{lemma} Let $G$ be an unramified reductive group.  There exists a definable subassignement of $G\times G$ of all pairs
$(\gamma,\gamma')$ such that $\gamma$ is semisimple (possibly singular) and $\gamma'$ is stably conjugate to $\gamma$.
\end{lemma}

\begin{lemma} Let $G$ be an unramified reductive group, given as a definable subassignment over a cocycle space $Z$.
There is a definable subassignment $G^u$ of $G$ over $Z$ 
consisting of strongly regular semisimple elements $\gamma$ such that
the connected component of the centralizer of $\gamma$ is unramified. 
\end{lemma}

\begin{lemma} Let $G$ be an unramified reductive group with unramifed endoscopic group $H$, given as a definable subassignments over a common cocycle space $Z$.
There is a definable subassignment $GH$ of all pairs $(\gamma,\gamma_H)$ such that $\gamma_H$ is strongly $G$-regular and $\gamma\in G^u$ is an image of $\gamma_H$.
Moreover,
consider the Denef-Pas statement $\psi$ that asserts that for all strongly $G$-regular elements $\gamma_H$, there exists an image $\gamma\in G^u$ that is an image of $\gamma_H$.
Then there exists $N$ such that $\psi_F$ is true for all $F\in\C_N$.
\end{lemma}

\begin{lemma} The set of topologically unipotent elements in a reductive group is a definable subassignement.
The set of strongly compact elements is a definable subassignment.
\end{lemma}

\begin{lemma} Let $T$ be a torus defined over a cocycle space $Z$. Assume that $T$ is given by twisting a split torus by some cocycle the Galois group
of a splitting field $L/VF$.  Let $S\subset T$ be a maximal unramified subtorus of $T$.  Consider the Denef-Pas statement asserting that (for every $z$ and) for
every strongly compact $t\in T$, 
there exists $s\in S$ and a topologically unipotent element $u\in T$ such that $t =s u$.  Then there exists $N$ such that the statement is
true in $F$ for all $F\in \C_N$.
\end{lemma}

\begin{lemma}[topological Jordan decomposition] 
Let $G$ be an unramified reductive group.  There is a definable subassignment of triples $(\gamma,\gamma_s,\gamma_u)\in G^3$
 such that $\gamma$ is strongly regular semisimple and strongly compact, 
$\gamma = \gamma_s \gamma_u = \gamma_u\gamma_s$, $\gamma_u$ is topologically unipotent, and
\[
\alpha(\gamma_s)=1,\quad\text{ or }\quad \op{ord}(\alpha(\gamma_s)-1)=0,
\]
for all absolute roots $\alpha$ of the Cartan subgroup $C_G(\gamma)$.
\end{lemma}


\subsection{spherical Hecke algebra for an unramified definable group}

Let $G$ be a definable unramified reductive group over a cocycle space $Z$.  Let $A$ be a maximal split torus in $G$ of dimension
$r$.  We identify its lattice of cocharacters $X_*(A)$ with $\ring{Z}^r$ by a choice of free generators of $X_*(A)$.
This allows us to treat $X_*(A)$ as the definable subassignement $h[0,0,r] = \ring{Z}^r$.  Let $X^*(A)$ be the lattice of
characters of $A$.

There is a perfect pairing $\langle\cdot,\cdot\rangle:X^*(A)\times X_*(A) \to \ring{Z}$.
For each $\lambda\in X_*(A)$, there is a definable subassignement $A_\lambda \subseteq A$ given by the formula
\[
\{ a \in A \mid \op{ord}(\mu(a)) = \g{\mu,\lambda},\text{ for all } \mu\in X^*(A) \}.
\]
There is a definable subassignment of $X_*(A)\times A$
given by pairs $(\lambda,a)$  such that $a\in A_\lambda$.  
Of course, $p$-adically, $A_\lambda$ is just the coset $\varpi^\lambda A(O_F)$, where $O_F$ is the ring of integers of $F$.

Let $P^+\subseteq X_*(A)$ be the set of cocharacters in the positive Weyl chamber.

\begin{lemma} $P^+$ is a definable subset (of $\ring{Z}^r$).
\end{lemma}

\begin{proof} $P^+$ is defined by linear inequalities, which can be expressed in the Presburger language.
\end{proof}


\begin{lemma}[Cartan decomposition] There is a definable subassignment of $P^+\times G$ given by the formula
\[
D_G = \{(\lambda,g)\in P^+\times G \mid g \in K A_\lambda K \}.
\]
The fiber $D_G(\lambda)$ over each $\lambda\in P^+$ is definable.  Moreover,
$D_G(\lambda)\cap D_G(\lambda') = \emptyset$, for $\lambda\ne \lambda'$.
\end{lemma}

By Bruhat-Tits,  the Cartan decomposition over general discrete valued fields.

\begin{remark}   $D_G$ captures the entire spherical Hecke algebra as a single
definable subassignment.  In applications to the fundamental lemma, 
it is important to work with this single subassignment
rather than an infinite basis of the spherical Hecke algebra.
\end{remark}

We define the {\it spherical Hecke function} to be the characteristic function of $D_G$, viewed as a $q$-constructible function
on $P^+\times G$.

Let $G$ be an unramified reductive group and let ${}^LG = \hat G\rtimes \g{\theta}$ be its Langlands dual, where
$\theta$ acts on $\hat G$ as the action of the Frobenius on the root datum, as explained in Section \ref{sec:B}.
The groups $W$ and $\g{\theta}$ both act on $X^*(\hat T)$.  
Let $\hat T$ be a Cartan subgroup of $\hat G$, with Weyl group $W$.


%The group $\g{\theta}$ acts on $W$ by
%$w\mapsto \theta w \theta^{-1}$.  
%Let $W^\theta$
%be the $\theta$-fixed subgroup of $W$.   
%The group $W^\theta$ acts on $Y^*$,  where $Y^* = X^*(\hat T)^\theta$.
%We identify $Y^* =X^*(\hat T)^\theta = X_*(A)$.


In the $p$-adic context, the Satake transform $f\mapsto \hat f$
is an isomorphism  $\H_{\ring{C}}(G,K)\to\ring{C}[Y^*]^{W^\theta}$.
Let $s_{\lambda,\mu}$ be the coeficients of the change of basis $\hat f_\lambda = \sum_\mu s_{\lambda,\mu} m_\mu$.

The Satake transform lifts to the $q$-constructible setting.  The Satake transform involves
a term $q^{\langle\rho^\vee,\mu\rangle}$, where $\rho^\vee = \rho(\Psi^\vee)$.   Constructible functions
in the formula (\ref{eqn:q})  only contain integral powers of $q$.  However, \cite[\S B.3.1]{cluckers2011local} 
extends the theory of constructible functions to allow half-integers.  To accommodate the square roots introduced by $\rho$,
we extend
the theory in that way without further comment.\footnote{We may ask whether the difference $\rho_G - \rho_H$,
for $G$ and $H$ an unramified endoscopic group, is always a sum of roots.}

\begin{lemma}\label{lemma:satake} There is a $q$-constructible function $s$ on $P^+\times P^+$ that
specializes to the function $(\lambda,\mu)\mapsto s_{\lambda,\mu}$,
\end{lemma}

\begin{proof} 
The coefficients $s$ are given by a integral of a $q$-constructible function on $P^+\times G$:
\begin{equation}\label{eqn:s}
(\lambda,\mu)\mapsto s_{\lambda,\mu}=\frac{q^{\langle\rho,\mu\rangle}}{\op{vol}(A_0)} \int_{A_\mu} \int_N D_G(\lambda,t n) dn dt.
\end{equation}
Here $N$ is the unipotent radical of a Borel subgroup $B$ containing a maximally split Cartan subgroup
$T$.  The subgroup $A_0 = T\cap K$ is a maximal compact subgroup of $T$.  Its volume $\op{vol}(A_0)$ specializes
to a polynomial in $q$ that can be written as a product of cyclotomic polynomials.  Adjusting $\op{vol}(A_0)$ by a 
null function, we may assume that $\op{vol}(A_0)$ is the specialization of a product of cyclotomic polynomials.
Cyclotomic polynomials are invertible constructible motivic functions.  Thus, $\op{vol}(A_0)$ can be inverted.
  Integration here is understood to be motivic integration with respect to invariant volume forms on $N$ and $A$.
The pushforward under a definable morphism (integration over fibers) carries $q$-constructible functions
to $q$-constructible functions.
Therefore $(\lambda,\mu)\mapsto s_{\lambda,\mu}$ is a $q$-constructible function.
\end{proof}

The $q$-constructible function is given explicitly by Macdonald's formula \cite{casselman1980unramified}.
We return to Macdonald's formula in Section~\ref{sec:macdonald}.


\section{Presburger constructibility}

In this section,
we check that some functions related to the finite dimensional representations of complex reductive groups
are Presburger constructible functions on the appropriate integer lattices.  In this section, constructible means Presburger
constructible.

\begin{remark}\label{rem:matrix}
For purposes of constructibility, we consider $\ring{Z}^r$ and also $Y^*$ as 
definable subassignments $h[0,0,r]$. When dealing with $\ring{Z}^r$, integrals over fibers
in the sense of motivic integration are discrete sums.  For example, if $(\lambda,\mu)\to a_{\lambda,\mu}$
and $(\mu,\nu)\to b_{\mu,\nu}$ are constructible functions of integer parameters $(\lambda,\mu,\nu)\in L\times M\times N$,
then we may intepret the matrix product $(\lambda,\nu)\to \sum_{\mu} a_{\lambda,\mu} b_{\mu,\nu}$ as a
fiber integral as follows.  We pull $a_{\lambda,\mu}$ and $b_{\mu,\nu}$ both back to $L\times M\times N$, multiply
them as constructible functions on $L\times M\times N$, then integrate (sum) over the fibers of the projection morphism
$L\times M\times N\to L\times N$.
\end{remark}

%We write $e^\lambda$ for
%elements of basis of the group algebra $\ring{C}[X^*]$, with $\lambda\in X^*$.



\subsection{weight multiplicities}

We expand the partition function into an infinite series
\[
P(E,q) = \sum_\mu (P(E,q),e^\mu) e^{\mu},
\]

\begin{lemma}\label{lemma:partition}
The function $\mu\mapsto (P(E,q),e^\mu)$ is Presburger constructible.
The function $\mu\mapsto (P(E,1),e^\mu)$ is Presburger constructible.
\end{lemma}

\begin{proof} 
Recall that
\[
P(E,q) = \prod_{\Sigma_1^+} \frac{1}{d_\alpha(q)},
\]
where the product runs over representatives $\beta_1,\ldots,\beta_k$ of $\theta$-orbits in $\Psi^+$.

If $\sum_\mu a_\mu e^\mu$ and $\sum_\mu b_\mu e^\mu$ have constructible coefficients, then it is
easily checked that the product also has constructible coefficients.  Thus, the proof reduces immediately
to showing that constructibility of the coefficients of 
\[
\frac{1}{1-\epsilon q^b e^\alpha} = \sum_{i=0}^\infty \epsilon^i q^{i b} e^{i\alpha}
\]
This is evident.
\end{proof}

%\begin{lemma}
%$\dom$ is a definable subset of $Y^*$.
%\end{lemma}

%\begin{proof}
%$\dom$ is given by a set of linear inequalities that can be expressed in the Presburger language.
%\end{proof}


Let $m_{\lambda,\mu}\in \ring{N}$ be the multiplicity of the weight $\mu\in X^*(T)$
in the irreducible representation with highest weight $\lambda\in P^+$.


\begin{lemma}  The weight multiplicity function $(\lambda,\mu)\mapsto (\tau_\lambda,e^\mu)$, the $q$-weight multiplicity
function $(\lambda,\mu)\mapsto (\tau_{\lambda,q},e^\mu)$  and the inverse Satake transform $(\lambda,\mu)\mapsto t_{\lambda,\mu}$
are all Presburger constructible functions.
\end{lemma}

\begin{proof} 
Each function is a finite sum over $w\in W^\theta$ of partition functions.  
Because constructible functions form a ring, it is enough to check that each term in the sum is
constructible.
The relevant partition functions
are $P(w(E)^{-1},1)$, $P(w(E)^{-1},q)$, and $P(w(E)^{-1},q^{-1})$, respectively.  These are constructible
by Lemma \ref{XX}.
\end{proof}



\begin{theorem}\label{lemma:van-leeuwen} $n_{\mu,\lambda}$ is a Presburger constructible function on $\dom\times\dom$.
\end{theorem}

\begin{proof} This is a consequence of van Leeuwen's algorithm. 
It is enough to show that the restriction of $n$ to each of the definable sets
$P^+_S\times \dom$ is constructible.  
Since $Y^*_w$ is definable, its characteristic function $e_w$ is constructible.
A finite sum of constructible functions is constructible.
\end{proof}


\begin{corollary} Consider the geometric Satake transform
\[
\hat f_\lambda = \sum_\mu g_{\lambda,\mu} \tau_\mu.
\]
Then $(\lambda,\mu)\mapsto g_{\lambda,\mu}$ is Presburger constructible.
\end{corollary}

\begin{proof}  The functions $(\lambda,\mu)\mapsto s_{\lambda,\mu}$ and $(\lambda,\mu)\mapsto n_{\lambda,\mu}$
are constructible.
The basis $g_{\lambda,\mu}$
is the matrix product of these two bases.  The result follows from Remark \ref{rem:matrix}:
matrix multiplications with definable indexing sets preserves constructibility.
\end{proof}

\subsection{branching formulas}

We do not need the results in this section, but while we are on the topic of constructibility,
we point out the constructibility of branching multiplicities.
For example, we have the following corollary of the branching
multiplicity formula \cite[Theorem ~8.2.1]{goodman}.

\begin{lemma} Let $H\le G$ be complex reductive groups with Lie algebras ${\mathfrak h}\subseteq {\mathfrak g}$.
Fix maximal tori $T_H\le T_G$ with Lie algebras $t_h\subseteq t_g$.  Assume that there is an element
$X_0\in t_h$ such that $\langle\alpha,X_0\rangle>0$ for every positive root of ${\mathfrak g}$.
Let $\dom_G$ and $\dom_H$ be the sets of dominant weights in $G$ and $H$.  Let $m(\lambda,\mu)$
be the multiplicity of the irreducible $\mathfrak h$-module with highest weight $\mu$ in the irreducible
$\mathfrak g$-module with highest weight $\lambda$.  Then $m(\lambda,\mu)$ is a Presburger constructible
function on $\dom_G\times\dom_H$.
\end{lemma}

\begin{proof}  Kostant's formula expresses each branching multiplicity as a finite sum of partition
functions.  Each partition function is rational.  
Thus, the argument used in the proof of Lemma~\ref{lemma:partition} applies.
\end{proof}

Explicit formulas for branching multiplicities are typical of what Presburger constructible functions look like.
Typically branching formulas look like products of linear factors depending on cases that can be
described by linear inequalities on parameters $\lambda$ and $\mu$.
We do not pursue the topic, but we can similarly investigate the constructibility of the function giving the
multiplicities of $\tau_\mu$ in $\op{Sym}^k \tau_\lambda$, and related operations on characters.

\subsection{The constructibility of $B$}\label{sec:B}

Let ${}^LG$ be the Langlands dual of an unramified reductive group $G$.  Let ${}^LH$ be the dual of an
unramified endoscopic group $H$.  We assume that both $H$ and and $G$ are given in the category of definable subassignments
over a cocycle space $Z$.  We can assume that the cocycle space $Z$ is the same for $H$ and $G$.

There exists a homomorphism ${}^LH\to {}^LG$ that factors through a semidirect product with a finite group $\g{\theta}$:
\[
\xi:\hat H \rtimes \g{\theta} \to \hat G \rtimes \g{\theta}.
\]
We fix such a homomorphism $\xi$.  

The morphism $\xi$ gives a restriction map
\begin{equation}
J_\xi:\ring{C}[Y^*]^{W^\theta} \to \ring{C}[Y^*_H]^{W_H^{\theta_H}}
\end{equation}
that is constructed as follows.  The set of semisimple $\theta_H$ conjugacy classes in 
$\hat H$ is classified by $\hat S_H/W_H^{\theta_H}$, where we have added subscripts $H$ to
indicate quantities for ${}^LH$ corresponding to $\hat S/W^\theta$ in ${}^LG$.
The morphism $\xi$ induces a map from the set of  $\theta_H$-conjugacy classes in $\hat H$
to $\theta$-conjugacy classes in $\hat G$.  This is a morphism of varieties. The corresponding
homomorphism of coordinate rings is $J_\xi$.


Working $p$-adically, Langlands gives describes a homomorphism $b = b_\xi$
from the spherical Hecke algebra of $G$ to the spherical Hecke algebra of $H$.
If $f$ belongs to the spherical Hecek algebra of $G$, its Satake transform belongs
to $\ring{C}[Y^*]^{W^\theta}$, where $W^\theta$ is the set of fixed points in $W$ under $\theta$.
The 



The inverse Satake transform of the image of $f$ in
\[
\ring{C}[Y^*]^{W_H^\theta}
\]
is $b_\xi(f)$.

\begin{theorem}\label{thm:B}
Let $G$ be an unramified connected reductive group with unramified endoscopic group $H$, both considered as definable
subassignments over a cocycle space $Z$.  Fix an $L$-embedding $\xi:{}^LH\to {}^LG$ that factors through a finite
cyclic group $\g{\theta}$; that is, $\xi:\hat H\rtimes \g{\theta} \to \hat G \rtimes \g{\theta}$.
Then
there is a $q$-constructible function $B$ on $P^+_G\times H$ and a natural number $N$ with the following specializations:
\[
B(\lambda,h)_F = b_\xi(f_{F,\lambda})(h),\quad \text{for } h\in H(F),
\]
for all $p$-adic fields in $F\in C_N$.  
\end{theorem}

Recall that for each $F$, we let  $f_{F,\lambda}$ denote the characteristic function
of the double coset $K\varpi_F^\lambda K$ in the unramified reductive group $G$ over $F$.

The theorem implies that the homomorphism $b_\xi$ has a uniformity as the $p$-adic field
varies, and as $\lambda$ varies.  
%It suggests the existence of a sort of ``Macdonald-Kato-Lusztig''
%formula for $b_\xi$.
%Stated slightly differently, there is a single constructible function that unites
%all of the functions $b_\xi (f^G_\lambda)$ on the endoscopic group, as $\lambda$ varies.

\begin{proof}
We have done most of the work already for this theorem.
By Lemma~\ref{lemma:satake}, the change of basis $D_G(\lambda,\cdot)$ to the basis $\tau_\lambda$
is constructible.  
By Lemma \XX{add lemma.}, 
the restriction of $\tau_\lambda$ is expressed in terms of the basis $\sigma_\mu$ through
constructible coefficients $d_{\lambda,\mu}$:
\[
\tau_\lambda| = \sum_{\mu} d_{\lambda,\mu} \sigma_\mu.
\]
%By Theorem~\ref{lemma:van-leeuwen}, the change of basis from $\mu^H_\lambda$ to $\tau^H_\mu$ is constructible.
By the Kato-Lusztig constructibility result, the change of basis from 
$\sigma_\mu$ to $\hat f^H_\mu$ or $D_H(\lambda,\cdot)$ is constructible.  

\XX{Write out the matrices.}
Composition of change of basis is given by matrix multiplication of the transformation matrices.
This matrix multiplication is constructible by Remark \ref{rem:matrix}.  Thus the transformation $b_\xi$
expresses each $D_G(\lambda,\cdot)$ as a linear combination with constructible coefficients
of the $D_H(\mu,\cdot)$.   In other words, it is a linear combination of some constructible functions
$d(\lambda,\mu)$, indexed by $\lambda$ and summed over $\mu\in X_*(A_H)$.  This sum
is a fiber integral of the constructible function $d$ on $X_*(A_G)\times X_*(A_H)$ for the
projection to $X_*(A_H)$.  It is therefore a constructible function.

In fact, the support of $d$ lies in a definable set $E$ such that the fibers of $E\to X_*(A_H)$
are finite, so there are no integrability issues.
\end{proof}

\begin{remark}  We have stated $q$-constructibility results in terms of the limiting behavior on
$p$-adic fields $\C_N$ for $N$ large.  However, in fact, the formulas we obtain for $B$  hold for all
$p$-adic fields.
\end{remark}




\subsection{transfer principle}

We review the transfer principle from \cite{cluckers2010constructible}.

\subsection{enumerated Galois groups}

We deal with field extensions and Galois groups in the way described in \cite{gordon} and \cite{cluckers2011transfer}.
We let $\Gamma$ be an abstract group with fixed enumeration $1=\sigma_1,\ldots,\sigma_n$ of its elements.  We
assume a fixed short exact sequence
\[
1\to \Gamma^t\to\Gamma\to\Gamma^{unr}\to 1,
\]
with $\Gamma^t$ and $\Gamma^{unr}$ both cyclic.
The group $\Gamma$ plays the role of a Galois group with inertia subgroup $\Gamma^t$ and unramified quotient $\Gamma^{unr}$.
We treat this data as an abstract fixed choice, without a priori connection to the Galois group of any particular extension of 
$p$-adic fields.  

We may fix an abstract root datum and choose an action of $\Gamma$ on the root datum, stabilizing the set of simple roots.
Through this action on the root datum, $\Gamma$ acts on the Weyl group, and we may construct the semidirect product $W\rtimes \Gamma$.


\subsection{fundamental lemma}

We conclude this article with a proof of the fundamental lemma for the spherical Hecke algebra for unramified groups in large positive characteristic
in the following form.

\begin{theorem}  \label{thm:fl}
For each absolute root system $R$,
there is a constant $N=N_R\in\ring{N}$ such that
the Langlands-Shelstad fundamental lemma holds for all unramified connected reductive groups $G$ with absolute root system $R$ 
and all of its unramified endoscopic groups $H$ over $F$ 
for all fields $p$-adic fields $F\in \C_N$.
\end{theorem}

By abstract unramified Galois group we mean a fixed finite cyclic group $\Gamma=\Gamma^u$ with choice of generator $\op{qFrob}$
that we call the quasi-Frobenius element.  It is not tied to any particular $p$-adic field.   The abstract dual group is the Langlands
dual constructed with respect to $\Gamma$ and $\op{qFrob}$ rather than the Galois (or Weil) group of a field.

It is an unfortunate limitation of the method that we are not able to be explicit about the restriction $N$ on the residue characteristic of the field.

\begin{proof}
The fundamental lemma takes the form
\begin{equation}\label{eqn:fl}
\sum_{\gamma_G}\Delta_0(\gamma_H,\gamma_G,\cdots)\op{O}(\gamma_G,f_\lambda) - \op{SO}(\gamma_H,b_\xi(f_\lambda)) = 0.
\end{equation}
Stable orbits of regular semisimple elements are definable as fibers of the Chevalley morphism $G\to T/W$.  The invariant motivic measure
on stable orbits is the volume form attached to a Leray residue of an invariant differential form on the group with respect to the canonical
form on $T/W$.  We have shown that the transfer factor and the homomorphism $b_\xi$ can be lifted to a $q$-constructible motivic functions.
The ellipsis $(\cdots)$ indicates extra parameters such as a parameter running over $a$-data, a parameter running over admissible pinnings
for the canonical normalization, and uniformizing parameters used in our explicit treatment of the $\chi$-data.  The $p$-adic transfer factor is independent of these choices,
but in dealing with constructible motivic functions, it is best to make the dependence on the parameters explicit (or at least honor them with an ellipsis).

We may consider the left-hand side of Equation \ref{eqn:fl} as a $q$-constructible function of $(\lambda,\gamma_H,\cdots)\in P^+\times H\times\cdots$, all over a definable
cocycle space $Z$ used to parameterize an unramified splitting field of $G$ and $H$.  

The fundamental lemma holds for the unit element in positive characteristic by the work of Ng\^o \cite{ngo2010lemme}.
This can be lifted to characteristic zero \cite{cluckers2011transfer}, \cite{waldspurger2006endoscopie}.  
It extends to the full Hecke algebra in characteristic zero \cite{hales1995fundamental}.
Hence the identity (\ref{eqn:fl}) holds in characteristic zero.
By the transfer principle, 
there exists $N$ such that the fundamental lemma also holds for all fields $F\in\C_N$.

It is important for the left-hand side of the equation to be viewed as a 
single identity with $P^+$ forming a factor of the definable subassignment, rather than viewed as an infinite collection of identities indexed by $\lambda\in P^+$.
This allows us to invoke the transfer principle a single time, rather than once for each $\lambda\in P^+$.
\end{proof}

\section{Appendix on transfer factors}

In this section, we assume familiarity with the Langlands-Shelstad transfer factor \cite{langlands1987definition}.

In \cite{gordon}, we showed that the Lie algebra transfer factor is a constructible motivic function.  
%This proof extends to a proof
%that the group transfer factor is constructible in a definable neighborhood of the identity.  
In that article we were able to disregard the multiplicative characters that appear in the group level transfer factor.
In this appendix we prove that group level transfer factor is constructible for unramified endoscopic data.

We use the canonical normalization of transfer factors given in \cite[\S7]{hales1993simple}.  
The canonical normalization requires
on a choice of an admissible pinning.  
The admissible pinning involves a choice of simple root vectors $X_\alpha$ 
relative fixed Borel subgroup and Cartan.
The choices $X_\alpha$ range over a definable subassignment, 
and we obtain the canonical normalization by introducing a free
parameter into the transfer factor ranging over the definable subassignment.

\subsubsection{$a$-data}

To define the transfer factor for $p$-adic  fields, a choice of $a$-data is made, but the transfer-factor is in fact independent of the choice of $a$-data.

This section introduces a definable subassignment of $a$-data and introduces an explicit free variable $a$ into the transfer factor that ranges over
the definable subassignment of $a$-data.  The tuple $a$-data is indexed by a fixed choice of indexing set.  

We begin wih a review of $a$-data for a $p$-adic field, then show how to make the construction as a definable subassignment.
Let $\Gamma$ be the Galois group of a Galois extension $L/F$.  We assume that $\Gamma$ acts on a finite set $R$ of roots.
The $a$-data are a collection of constants $a_\alpha\in L^\times$ indexed by $\lambda\in R$ such that
\begin{equation}\label{eqn:a}
a_{-\lambda} = -a_\lambda,\quad a_{\sigma\lambda} = \sigma(a_\lambda),\quad \text{ for } \sigma\in \Gamma.
\end{equation}
Let $\epsilon:R\to R$, given by $\epsilon(\lambda)=-\lambda\ne\lambda$.  Let $O$ be the orbit of some $\lambda\in R$ under $\langle\Gamma,\epsilon\rangle$.
The choice of $a$-data can clearly be made orbit by orbit.
If there is no $\sigma\in \Gamma$ such that $\sigma\lambda=-\lambda$, we have a specific choice of $a$-data (selecting a given $\lambda\in O$) given by
\[
a_{\sigma\lambda}=1,\quad a_{-\sigma\lambda}=-1,\quad \sigma\in\Gamma.
\]
If $\sigma_0\in\Gamma$ gives $\sigma_0\lambda=-\lambda$,  then we let $F_{+\lambda}$ be the fixed field of $\Gamma_{+\lambda} = \{\sigma\in\Gamma\mid \sigma\lambda=\lambda\}$
and we let
$F_{\pm\lambda}$ be the fixed field of $\Gamma_{\pm\lambda} = \{\sigma\in\Gamma\mid \sigma\lambda=\pm\lambda\}$.
The extension $F_{+\lambda}/F_{\pm\lambda}$ is quadratic.
We may choose $a$-data by fixing $a_\lambda\in F_{+\lambda}$ such that $\sigma_0(a_\lambda) = -a_\lambda$ then extending uniquely to the entire orbit  by the relation (\ref{eqn:a}).
Specifically, the choice of $a_\lambda$ can be taken to run over units of $F_{+\lambda}$ such that its square is a nonsquare in $F_{\pm\lambda}$, when the quadratic extension is unramified.
We take $a_\lambda$ to run over uniformizers in $F_{\lambda}$ such that its square lies in $F_{\pm\lambda}$, when the quadratic extension is ramified.
We see by these explicit descriptions that $a_\lambda$ is a parameter in a definable subassignment.



\subsubsection{$\Delta_{II}$}
Two terms in the transfer factor rely on multiplicative characters constructed from $\chi$-data: the terms $\Delta_{II}$ and the term $\Delta_2$.

\begin{lemma}  There is a $q$-constructible function representing $\Delta_{II}$ (after introducing some free parameters ranging over definable subassignments).
\end{lemma}

\begin{proof}  We begin with an explicit construction of some characters for a $p$-adic field.  Then we analyze the construction to
see that it can be done constructibly.

Let $F_+/F_\pm$ be a quadratic extension of $p$-adic fields.  Let $\varpi_+$ be a uniformizer in $F_+$.  We define a multiplicative character $\chi_+ = \chi_{F_+/F_{\pm}}:F_+\to \ring{C}^\times$
as follows.  If $F_+/F_\pm$ is unramified, let $\chi_+$ be the unramified character of order two.

If $-1$ is a square in $F_+$, we define $\chi_+$ by $\chi_+(\varpi_+) = i\in\ring{C}$ and $\chi_+$ restricted to units is the unique character of order two.

If $-1$ is a nonsquare in $F_+$, we define $\chi_+$ by $\chi_+(\varpi_+)=1$ and $\chi_+$ restricted to units is the unique character of order two.

In every case, $\chi_+^4 = 1$.  

Now we analyze  constructibility.  The condition that $-1$ is a square or nonsquare is a definable condition.
Assume that $F_+$ and $F_\pm$ are both extensions of $VF$, presented as usual by a definable space of the characteristic polynomial of a generator of the fields.  
Introduce a free parameter $\varpi_+$ that runs over the constructible subassignment of uniformizers in $F_+$.
We claim that $\chi_+$ is a linear combination of characteristic functions
\[
\chi_+ = \sum_{\zeta\in\mu_4(\ring{C})} \zeta\, \op{char}(D_\zeta).
\]
where each $D_\zeta$ is constructible over the space of parameters.  
This is essentially obvious: $F_+/F_\pm$ being unramified is a definable condition on the coefficients of the characteristic polynomial;
the unique character of order two is given in terms of the characteristic function  on squares and nonsquares, etc.

Now we turn to the transfer factor $\Delta_{II}$.  It has the form
\[
\prod_\alpha \chi_\alpha\left(\frac{\alpha(\gamma)-1}{a_\alpha}\right)
\]
It is a constructible function if each factor is a constructible functions. Each morphism $\gamma\to(\alpha(\gamma)-1)/a_\alpha$ is
definable, so we only need to check that each character $\chi_\lambda$ in some choice of $\chi$-data is constructible.  We use the characters
given above to do so.

There is no harm in partitioning the domain of $\Delta_{II}$   according to definable characteristics of the element $\gamma$.  We consider a definable family of
 $L/VF$ that split the centralizer of $\gamma$.  We may assume fixed abstract Galois data $1\to\Gamma^t\to\Gamma\to \Gamma^u\to 1$ with
enumeration $\sigma_i$ of the elements of $\Gamma$ for $L$
and we may assume a fixed action of that data on the root system coming from the centralizer of $\gamma$ (relative to a split torus).   This gives the
indexing set $R$ of roots and action of $\Gamma$ as fixed choices used to partition the domain of $\Delta_{II}$.

Let $\epsilon$ be an automorphism of $R$ that acts as $\lambda\mapsto -\lambda$, and let $O(\lambda)$ be the orbit of $\lambda$ under $\langle\Gamma,\epsilon\rangle$.
If there does not exist $\sigma\in\Gamma$ such that $\sigma\lambda=-\lambda$, then we may take the $\chi$-data for $\mu\in O(\lambda)$ to be the trivial character
(which is constructible).   

Now assume that there exists $\sigma\in\Gamma$ such that $\sigma\lambda = -\lambda$.  Then $F_{+\lambda}/F_{\pm \lambda}$ is a nontrivial quadratic extension.
We set $\chi_\lambda = \chi_+$ for this quadratic extension.  
In more detail,
we include free parameters $\dot\sigma_i$ realizing each abstract automorphism $\sigma$ as a linear transformation of $L/VF$.
The extension $F_{+\lambda}/VF$ and the space of uniformizers $\varpi_+$ in the extension are then described by definable conditions inside $L/VF$ (as in \cite{cluckers2011transfer}).

By transport of structure, we obtain constructible $\chi$-data on the entire orbit of $\lambda$, using the defining properties of $\chi$-data:
$\chi_{\sigma\lambda} = \chi_{\lambda}\cdot \dot\sigma^{-1}$; $F_{+\sigma\lambda}=\dot\sigma F_{+\lambda}$; $\varpi_{+\sigma\lambda}=\dot\sigma\varpi_{+\lambda}$,
and so forth.   Running over all orbits this way, constructible $\chi$-data are obtained.
\end{proof}
% Langlands-Shelstad use Sigma = <Gamma,epsilon>,  Gamma_Langlands-Shelstad = Sigma_this.


\subsubsection{$\Delta_2$}

We have now treated all terms except $\Delta_2$.
We recall that the term $\Delta_2$ restricts to a multiplicative character on each Cartan subgroup of $G$.  It is constructed from $\chi$-data by
means of class field theory reciprocity for tori.  The following theorem completes our analysis of the transfer factors on groups.

\begin{theorem}\label{thm:delta2}  There is a $q$-constructible function representing the transfer factor $\Delta$, 
possibly after introducing some free parameters.  These parameters  have no effect upon specialization to a $p$-adic field.
\end{theorem}






\begin{proof}  We give a sketch of a proof.  
The idea of the proof is that multiplicative characters can be chosen to be tamely ramified; that is, they have trivial restricition to topologically unipotent elements.
We have descent formulas for unramified groups that reduce the transfer factor to the case of topologically unipotent elements \cite{langlands2007descent} \cite{hales1993simple} \cite{langlands2007descent}.

We freely use various lemmas on definability from the next section \ref{sec:definability}.

We enumerate the standard Levi components of $G$.  Each is a definable set.  If $\gamma_G$ is conjugate to an element $\gamma_M$ in some proper Levi subgroup, then
by descent formulas for transfer factors we have $\Delta(\gamma_G,\gamma_H) = \Delta_M(\gamma_M,\gamma_{M,H})$.   The element $\gamma_{M,H}$ is a conjugate
of $\gamma_H$ in a Levi of $H$ constructed by descent.
By an induction on the dimension of the group, we may assume that $\Delta_M$ is constructible.  Every regular semisimple element that is not
elliptic is conjugate to a proper Levi subgroup.  We may now assume that $\gamma_G$ belongs to an elliptic Cartan subgroup $T$.

Since $G$ is unramified, the connected center $Z^0$ is also unramified.
$Z^0$ can be naturally identified with a torus in the center of $H$.
By Langlands and Shelstad, there is a character $\chi_Z$ on $Z^0$ such that
\[
\Delta(z\gamma_G,z\gamma_H) = \chi_Z(z)\Delta(\gamma_G,\gamma_H).
\]
The character is unramified \cite{hales1993simple}.
The character $\chi_Z$ depends on $(\gamma_G,\gamma_H)$ only through the endoscopic data $(G,H)$.
To check constructibility of $\chi_Z$, it is convenient and allowable to temporarily assume that $\gamma_H$ belongs to the maximally split Cartan subgroup of $H$.
We can apply Levi descent, unless the image $\gamma_G$ of $\gamma_H$ lies in an elliptic torus.

If $G=H$ is a torus, then there is a tautological embedding $\xi_0:{}^LH \to {}^LG$ for which the character $\chi_Z$ is trivial.  Any other choice
of embedding $\xi$ that factors through a finite unramified extension $\op{Gal}(E/F)$.  The cocycles attached to $\xi_0$ and $\xi$ 
differ by a cocycle of $H^1(\op{Gal}(E/F),\hat T)$,
determined by the value $\phi$ on the Frobenius (or in the constructible context, the quasi-Frobenius)
\[
\phi \in \hat T = X^*(T)\otimes \ring{C}^\times = \op{Hom}(X_*(T),\ring{C}^\times)
\]
By reciprocity, this corresponds to the unramified character of $T$ given by $\varpi_F^\lambda\mapsto \phi(\lambda)$, for $\lambda\in X_{*,F}(T)$.
This clearly extends to a constructible function $\chi_Z$ on $T$.

If $G$ has a nontrivial root system and $\gamma_G$ is elliptic, then it is known that the adjoint group of $G$ is $\op{PGL}(n)$ and $H$ is the elliptic
unramified torus given by twisting by the longest element of the Weyl group of $\op{PGL}(n)$.  In this case Kazhdan gave a formula for the transfer factor 
(later repeated later in Hales and Waldspurger), and by inspection, it is constructible \cite{kazhdan1983lifting}.  It is essentially the
quadratic character attached to the unramified quadratic extension of $F$,
evaluated on a resultant polynomial constructed from $\gamma_H$.   This completes the proof that $\chi_Z$ is constructible.

Now we drop the temporary assumption on $\gamma_H$; it is no longer assumed to lie in a maximally split Cartan subgroup.


By adjusting $(\gamma_G,\gamma_H)$ by a central element, we may reduce the proof of constructibility to the special case  where $\gamma_G$ and
$\gamma_H$ lie in the maximal bounded subgroup of their Cartan subgroups $T$ and $T_H$.
We take a definable topological Jordan decompositon $\gamma_G = \gamma_s \gamma_u$, described in Section \ref{sec:definability}.
Replacing $\gamma_G$ and $\gamma_s$ by stable conjugates $\gamma'_G=\gamma_G^h$ and $\gamma_s^h$ (same $h$), we may assume that
$\gamma_s\in G_u$; that is, its centralizer is unramified.  We may do the same on the endoscopic side.  We have 
\[
\Delta_G(\gamma_G,\gamma_H) = c \Delta_G(\gamma'_G,\gamma'_H)
\]
where $c$ is the ratio of terms coming from $\Delta_{III}$.  The $\Delta_{III}$ terms are constructible, so the proof of constructibility reduces to
the case where we may now drop primes and assume that $\gamma_s$ has an unramified centralizer.
We construct descent data $(G_s,H_s)$ for the centralizer of $\gamma_s$ in $G$ and the corresponding centralizer in $H$.
By \cite{hales1993simple}, the normalized transfer factors satisfy
\[
\Delta(\gamma_G,\gamma_H) = \Delta_s(\gamma_G,\gamma_H),
\]
where the right-hand side is computed with respect to the endoscopic data $(G_s,H_s)$.
(In that reference, it is assumed that $\gamma_G\in G(O_F)$ and $\gamma_H\in H(O_F)$, but that assumption is only needed 
to prove the fact that the centralizer of $\gamma_s$ is unramified.  Since we have a separate argument of that fact, the descent formula
holds in our context as well.)
By an induction on the dimension of the group, the right-hand side is constructible, and the proof is complete except in the case
when $\gamma_s$ is central.

We now assume that $\gamma_s$ is central and strongly compact.  Then $\gamma_s\in K$ because $K$ is a maximal compact.
It is known that $\chi_Z$ is trivial on $K$ \cite[Lemma 3.2]{hales1995fundamental}. Thus again adjusting by an element in the center,
we may assume that $\gamma_s=1$.  That is, we are reduced to proving the constructibility of transfer factors on the set of topologically
unipotent elements.  We pick our $\chi$-data to be tamely ramified.  This implies that the characters $\Delta_2$ are trivial
on topologically unipotent elements.  This reduces constructibility to the analysis of factors $\Delta_I$, $\Delta_{II}$, $\Delta_1$, and $\Delta_{IV}$.
This has already been done.  This completes the proof.
\end{proof}




