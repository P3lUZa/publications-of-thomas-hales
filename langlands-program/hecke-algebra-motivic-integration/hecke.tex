
% spherical Hecke algebra and motivic integration
% Tex file started June 28, 2016
% 
% 

%Authors: William Casselman, Jorge Cely, Thomas Hales

\newcommand{\XX}[1]{{\it  [To do: #1]}}
\newcommand{\ring}[1]{\mathbb{#1}}
\newcommand{\ang}[1]{\langle{#1}\rangle}
\def\op#1{{\operatorname{#1}}}
\def\inv{\op{inv}}
\def\dom{P^+}
\def\Q{{\ring{Q}}}
\def\card{\op{card}}
\def\CSrho{[W_S\backslash C_\rho]}

\def\C{\mathcal C}
\def\N{\mathcal N}
\def\H{\mathcal H}
\def\M{\mathcal M}
\def\T{\mathcal T}

\def\n{{\mathfrak n}}
\def\g{{\mathfrak g}}
\def\t{{\mathfrak t}}
\def\h{{\mathfrak h}}

\def\Frob{\op{Frob}}
\def\dotw{\dot w}
\def\uu{\upsilon} % \was \tilde\upsilon.

\def\libel#1{{\text{\sc [#1]~}}\label{#1}}
\def\rif#1{(\ref{#1}-{\text{\sc #1})}}


%\section{Introduction}


Let $F$ be a $p$-adic field; that is, a finite extension of
$\ring{Q}_p$ or $\ring{F}_p((t))$.  Let $G$ be an unramified reductive
group and $H$ an unramified endoscopic group of $G$, both defined over
$F$.  Let $\H(G)$ and $\H(H)$ be the spherical Hecke algebras on $G$
and $H$.  Associated with a morphism $\xi:{}^LH\to {}^LG$ of
$L$-groups, there is a homomorphism $b_\xi:\H(G)\to \H(H)$, obtained
by composing three maps: the Satake transformation of $\H(G)$, the
pullback under $\xi$, and the inverse Satake transformation to
$\H(H)$.

Let $A$ be a maximal split torus of $G$.  Let 
\[
\dom = \{\lambda\in X_*(A) \mid \ang{\lambda,\alpha^\vee}\ge 0,
\quad \alpha\in \Delta_1\}
\]
be a positive chamber of $X^*(\hat S) = X_*(A)$.  (The notation
is explained in Section \ref{sec:L}.)   The spherical
Hecke algebra $\H(G)=\H(G//K)$ of functions that are bi-invariant with
respect to a given hyperspecial subgroup $K$ has a linear basis given
by characteristic functions $f_\lambda$ of double cosets
$K\varpi^\lambda K$.  Here $\varpi$ is a fixed uniformizing element
and $\lambda$ runs over the cocharacters in
$P^+$.

In this article, we use motivic integration to study the spherical
Hecke algebra and the function $B_\xi:P^+\times
H(F)\to \ring{C}$, given by $(\lambda,h)\mapsto b_\xi(f_\lambda)(h)$.
This function can be lifted to a constructible motivic function
(Theorem \ref{thm:B}) and admits a field-independent description.

As an application, we show that the fundamental lemma for the
spherical Hecke algebra falls within the scope of the transfer
principle for constructible motivic functions (Section~\ref{sec:transfer}).  This implies that the
fundamental lemma holds for the spherical Hecke algebra over fields of
large positive characteristic (Theorem \ref{thm:fl}).

This application to the fundamental lemma is the main motivation for
this work.  Our results overlap with those of Bouthier, who proves the
fundamental lemma for the spherical Hecke algebra in positive
characteristic under the restrictions that the group $G$ is semisimple
and simply connected, and the endoscopic group is split
\cite[Theorem~0.2]{bouthier}.  Our proof of the fundamental lemma for
the spherical Hecke algebra holds without restriction on the
group and endoscopic group.  Unlike Bouthier, we are unable to be
explicit in our assumption on the characteristic of the field.  This
is an unfortunate limitation of the methods we use.  In other work,
Lemaire, Moeglin, and Waldspurger propose that the method of close
fields might be used to transfer the fundamental lemma for the
spherical Hecke algebra from characteristic zero to positive
characteristic, but as far as we know, this has not been carried
out~\cite[\S1.3]{LMW}.

The construction of $B_\xi$ passes through the Langlands dual ${}^LG$,
which is a non-connected complex reductive group.  Our
constructibility result for $B_\xi$ follows from the Presburger
constructibilty of various functions on lattices in the dual:
Macdonald's formula, weight multiplicity formulas, the inverse of the
weight multiplicity matrix, the Plancherel measure, the geometric
Satake transform, and the Kato-Lusztig formula for the inverse Satake
transform.  When $G$ and $H$ are split, we can take ${}^LG = \hat G$
and ${}^LH=\hat H$ to be connected.  In this case, the desired
formulas were previously known.  In this article, we generalize these
formulas to non-connected complex reductive groups.  These
generalizations are a major part of this work.

One novelty of this work is that we show how to extend the theory of
motivic integration to the Langlands dual group, by encoding
representation-theoretic data of the complex dual group as Presburger
constructible functions on the character lattice. These Presburger
functions can then be recombined with constructible functions on the
$p$-adic group.  A second innovation is to encode the entire Hecke
algebra into a single constructible function $B_\xi$.  This makes it
possible to invoke the the transfer principle of motivic integration a
single time, rather than once for each function in the Hecke algebra.
(Invoking the transfer principle an infinite number of times could
potentially leave us with nothing, because we lose finitely many
primes with each invocation.)

A framework for studying the spherical Hecke algebra through motivic
integration is provided by Cely's thesis \cite{cely}.  This article
builds on that work.  We thank Julia Gordon, who served on Cely's
thesis committee and who provided valuable suggestions.



\section{the Satake transform, Macdonald's formula, and related topics}
\label{XX} % dummy label

In this section, we extend various results from split $p$-adic groups
to unramified groups (from complex connected reductive groups to
non-connected groups on the $L$-group).

\subsection{root systems}

Let $G$ be an unramified reductive group over a $p$-adic field $F$.
It is defined by descent from a finite unramified extension $E/F$ over
which $G$ splits.  It is determined by an automorphism $\theta$ of the
root datum $(X^*,\Phi,X_*,\Phi^\vee)$ of the split form $G^*$ of $G$.
The automorphism $\theta$ has finite order and preserves a set of
simple roots associated to some set $\Phi^+$ of positive roots.  If
$\op{Frob}$ is the Frobenius automorphism of $E/F$, the group $G/F$ is
defined by twisting the action of Frobenius on $G(E)$ by $\theta$.  Let
$(B,T,X)$ be a pinning of $G$ over $F$, preserved by $\theta$.

Let $A$ be a maximal split torus in $T$.  For any $R\subseteq \Phi$,
let $M_R$ be the centralizer of
\[
A_R = \{a\in A\mid \alpha(a)=1,\quad \alpha\in R\}.
\]
We have $X_*(A) = X_*(T)^\theta$ and $X^*(A) =
X^*(T)/(1-\theta)X^*(T)$.  The pairing of $X^*(A)$ and $X_*(A)$ is
induced naturally from that of $X^*(T)$ and $X_*(T)$.

The image of $\Phi$ in $X^*(A)$ is the restricted root sytem $\Sigma$.
It is well known that $\Sigma$ is indeed a root system, and this is
easy to verify directly in this context.  The roots of $\Sigma$ are in
bijection with the $\theta$-orbits of roots in $\Phi$, and this
bijection restricts to a bijection between simple roots in $\Sigma$
and orbits of simple roots in $\Phi$.  If $\alpha$ is a root of $\Phi$
(or coroot), we write $[\alpha]=\{\alpha,\theta\alpha,\ldots\}$ for
its $\theta$-orbit, often identified with a root of $\Sigma$.
%A root $\alpha$ is {\it nonmultipliable} if $2\alpha$ is not a root.
A root $\alpha\in\Sigma$ is {\it indivisible} if $\frac12\alpha$ is not a root.
%Let $\Sigma^{red}$ and 
Let $\Sigma_{red}$ be the set of %nonmultipliable and
indivisible roots of $\Sigma$.  It is a reduced root system.
% They are both reduced root systems.
Two roots $\alpha$ and $\alpha'\in\Sigma$ are {\it homothetic} if
$\alpha' = k\alpha$ for some $k>0$.  Every root is homothetic to an
indivisible root.  % nonmultipliable root and to an indivisible root.

Each root $\beta\in\Phi$ can be assigned a diagram $A_1$ or $A_2$ as
follows.  The construction is best described in the split group $G^*$.
Let $S=[\beta']$ be the $\theta$-orbit that corresponds to the
indivisible root homothetic to $[\beta]$.  The simple positive roots
of $M_S$ form a single $\theta$-orbit $S$.  We consider its Dynkin
diagram.  By the transitivity of $\theta$, all components of the
diagram have the same type, either $A_1$ or $A_2$.  This is the
diagram of $\beta$.  This construction can be applied to $(G^*,\Phi)$
or to $(\hat G,\Phi^\vee)$, where $\hat G$ is the complex dual.  A
coroot $\alpha^\vee$ has the same diagram as the root $\alpha$.  We let
$b(\beta)$ be the number of connected components of the Dynkin
diagram of $M_S$.  (According to the types of Kottwitz and Shelstad, type I
means diagram $A_1$, type II means a simple root in diagram $A_2$, and
type III means a highest root in diagram $A_2$
\cite{kottwitz1999foundations}.)

Let $N:X_*(T)\to X_*(A)$ be the norm map: 
$N\alpha = \sum_{\alpha'\in  [\alpha]} \alpha'$.

\begin{lemma}\label{lemma:norm}
 If $[\alpha]\in\Sigma_{red}$ is an indivisible restricted root, then
  the corresponding coroot is
\begin{equation}\label{eqn:norm}
[\alpha]^\vee = k\, N\alpha^\vee
\end{equation}
when the diagram of $\alpha$ has type $A_k$, for $k=1,2$.
\end{lemma}

\begin{proof}
(See \cite[1.3.9]{kottwitz1999foundations}.)
\end{proof}

Let $W$ be the Weyl group attached to the root datum of $G$ over a
splitting field $E$.  The restricted Weyl group $W^\theta$ is the
subgroup of $W$ commuting with $\theta$.  The group $W^\theta$ is a
Coxeter group.  The simple reflection in $W^\theta$ associated with an
orbit $[\alpha]$ of simple roots in $\Phi$ is the longest element in
the Weyl group of the Levi component $M_{[\alpha]}$.  We write
$\ell(w)$ for the length of $w\in W^\theta$, computed relative to the
set of simple reflections of the Coxeter group $W^\theta$.

\subsection{$L$-groups}\label{sec:L}

We review some aspects of the theory of non-connected complex
reductive groups from Steinberg \cite{steinberg1968endomorphisms},
Springer \cite{springer2010linear}, Kottwitz and Shelstad
\cite{kottwitz1999foundations}, Haines \cite{haines2016dualities}, and
Chriss \cite{chriss}.

Let ${}^LG = \hat G \rtimes \ang{\theta}$ be the $L$-group of the
unramified group $G$.  It has root system dual to that of $G$.  It is
a semidirect product of a connected complex reductive group $\hat G$
and a finite cyclic group generated by an outer automorphism $\theta$
of $\hat G$.  The automorphism $\theta$ preserves a pinning $(\hat
B,\hat T,\hat X)$ of $\hat G$. Let $\hat B = \hat T\hat N$.

Let $\Psi=\Phi^\vee$ and $\Psi^\vee=\Phi$ be the root and coroot
systems of the complex group $\hat G$ with respect to $\hat T$, and
let $\Psi^+$ be the set of positive roots with respect to $(\hat
T,\hat B)$.  If $R$ is any root system with positive roots $R^+$, we
let $\rho(R^+) = (1/2)\sum_{R^+} \alpha$ be the half-sum of positive roots in $R^+$.  We have
$\rho(\Sigma^+_1) = \rho(\Psi^+)$.

The torus $\hat T$ is $\theta$-stable.  We form the quotient $\hat S =
\hat T/(1-\theta) \hat T$, where
\[
(1-\theta)\hat T = \{ t\theta(t^{-1}) \mid t\in \hat T\},
\]
using Steinberg's additive notation for a multiplicative group.  If $\lambda\in
X^*(\hat T)^\theta$ is $\theta$-fixed, then it is trivial on
$(1-\theta)\hat T$ and descends to a character $\lambda\in X^*(\hat
S)$.  This gives $X^*(\hat T)^\theta = X^*(\hat S)$.

We abbreviate $Y^* = X^*(\hat S)$. Let $O=O_F$.  We have
identifications
\begin{equation}\label{eqn:identify}
T/T(O)=A/A(O)=X_*(A)=X_*(T)^\theta  =X^*(\hat T)^\theta = Y^* = X^*(\hat S).
\end{equation}
Each unramified character $\chi:T\to \ring{C}^\times$, by these
identifications, is a homomorphism
\begin{equation}
\chi\in\op{Hom}(T/T(O),\ring{C}^\times) = 
\op{Hom}(X^*(\hat S),\ring{C}^\times) = 
X_*(\hat S)\otimes \ring{C}^\times = \hat S.
\end{equation}
We write $\chi = \chi_s$, for $s\in\hat S$.

Let $e^\lambda$ be the basis element of the group algebra
$\ring{C}[Y^*]$ of $Y^*$, indexed by $\lambda\in Y^*$.

Recall that
\[
\dom = \{\lambda\in X_*(A) \mid \ang{\lambda,\alpha^\vee}\ge 0,
\quad \alpha\in \Delta_1\}
\]
where $\Delta_1$ is a set of simple roots for $\Sigma_1$.
A basis of $W^\theta$-fixed functions in $\ring{C}[Y^*]$ is
\[
m_\mu = \sum_{\lambda\in W^\theta(\mu)} e^\lambda, 
\quad \text{for }\mu\in P^+,
\]
where $W^\theta(\mu)$ is the orbit of $\mu\in\ring{C}[Y^*]$ under
$W^\theta$.

Let $\hat G_\theta$ be the complex group with Cartan subgroup $\hat
S$, root system $\Sigma_1=(\Sigma_{red})^\vee$, and root datum
\[
(X_*(A),(\Sigma_{red})^\vee,X^*(A),\Sigma_{red}) 
= (X^*(\hat S),\Sigma_1,X_*(\hat S),\Sigma_1^\vee).
\]
The complex group $\hat G_\theta$ is the $L$-group of $G^1$, the
identity component of the $\theta$-fixed subgroup of the split form
$G^*$ \cite[\S1.3]{kottwitz1999foundations}.  As we will see, $\hat
G_\theta$ appears naturally in the twisted Weyl character formula for
${}^LG$, hence also in the Satake transform and its inverse.

\begin{example} Let $G=\op{SU}(n,E/F)$ be an unramified unitary group
  in an odd number of variables $n=2k+1$.  The automorphism $\theta$
  has order $2$.  The cocharacter groups of $T$ and $A$ are
\[
X_*(T) = \{(t_1,\ldots,t_{n})\in \ring{Z}^n\mid t_1+\cdots t_n=0\}, 
\quad
X_*(A)  = \ring{Z}^k,
\]
with identification $(t_1,\ldots,t_k)\in X_*(A)\mapsto
(t_1,\ldots,t_k,0,-t_k,\ldots,-t_1)\in X_*(T)^\theta$.  Following
Lemma \ref{lemma:norm}, we compute norms to get
\[
\Sigma_1 = \{\pm t_i\pm t_j\mid i\le j\le k\}\subset X_*(A).
\]
We recognize the root datum as that of $\hat G_\theta =
\op{Sp}(2k,\ring{C})$ with root sytem $\Sigma_1$.  In this case, $G^1
= \op{GL}(n)^{\theta,0} = \op{SO}(2k+1)$, which indeed has $L$-group
$\hat G_\theta$.
\end{example}


\subsection{the partition function}

Let $\theta_1\in N_{\hat G}(\hat T) \rtimes \ang{\theta}$ be an
element of finite order.  Set $\hat T_1 = \hat T/(1-\theta_1)\hat T$
and $X^*(\hat T_1) = X^*(\hat T)^{\theta_1}$.  Let $N_1:X^*(\hat T)\to
X^*(\hat T)^{\theta_1}$ be the norm map with respect to $\theta_1$:
\[
N_1 \mu = \sum_{\mu'\in \ang{\theta_1}\mu} \mu'.
\]

Let $V$ be a finite dimensional representation of ${}^LG$, with
weight space decomposition 
$V=\oplus V_\mu$.  We have
$\theta_1(V_\mu) = V_{\theta_1\mu}$.  Let $M\subset X^*(\hat T)$ be a
$\theta_1$-stable set of weights of $V$, and set
\begin{equation}\label{eqn:VM}
V_M = \oplus_{\mu\in M} V_\mu.
\end{equation}

We define a symbolic operator $E$ on $V_M$ that is diagonal with
respect to the weight space decomposition:
\[
E v = e^{\mu} v, \text{ for } v \in V_\mu.
\]
We define a $q$-determinant $D(\hat G,V_M,\theta_1,E,q)$ and a
$q$-partition function $P(\hat G,V_M,\theta_1,E,q)$ as
\begin{align}\label{eqn:det}
D(\hat G,V_M,\theta_1,E,q) &= \det(1- q \theta_1 E;V_M);\\ 
P(\hat G,V_M,\theta_1,E,q) &= D(\hat G,V_M,\theta_1,E,q)^{-1}.
\end{align}
When $V$ is the adjoint representation, we sometimes abbreviate
$D(\hat G,V_M,\theta_1,E,q)$ to $D(\hat G,M,\theta_1,E,q)$.
The determinant and partition function carry the same information,
and we pass back and forth between $D$ and $P$ according to convenience.


We may view the determinant and partition functions as functions on
$\hat T$, by evaluating each $e^\mu (t) = \mu(t)$, for $t\in \hat T$,
so that
\[
\det(1- q\theta_1 E;V_M)(t) = \det(1-q\theta_1 t;V_M).
\]
Taking $\theta_1^{-1}(u) u^{-1}\in (1-\theta_1)\hat T$, we have
\begin{align*}
\det (1-q \theta_1 t \theta_1^{-1}(u) u^{-1};V_M) 
&= \det(1- u (q \theta_1 t ) u^{-1};V_M) = \det(1-q\theta_1 t;V_M).
\end{align*}
Thus, the partition function and determinant descend to functions on
$\hat T_1$.  The next lemma gives the general shape of a factorization
of the determinant.

\begin{lemma}\label{lemma:fact}  
  Let $M = \{\theta^i\mu\}$ be the orbit of a single weight of $V$.
  Then $D(\hat G,V_M,\theta_1,E,q)$ is a finite product of factors of
  the form
\[
1 - \zeta q^b e^{N_1\mu},
\]
where $b$ is the cardinality of the orbit $M$ and $\zeta^k=1$, where
$k b$ is the order of $\theta_1$.
\end{lemma}

\begin{proof} Fix $\mu_0\in M$ and let $\mu_i = \theta_1^i \mu_0$.
  The abelian group $\ang{\theta_1^b}$ acts on $V_{\mu_0}$.  Write
  $V_{\mu_0} = \oplus W$, where each $W$ is a $1$-dimensional
  representation of $\ang{\theta_1^b}$.  Then $V_M = \oplus
  \ang{\theta_1} W$, where $\ang{\theta_1} W = \oplus_{i=0}^{b-1}
  \theta_1^i W$.  We have $\theta_1^b v_0 = \zeta v_0$, for $v_0\in W$
  and some $\zeta = \zeta_W$.  Let $v_i = \theta_1^i v_0$.  The
  operator $1 - q \theta_1 E$ on the summand $\ang{\theta_1} W$ with
  respect to this basis is
\[
\begin{pmatrix}
1 & -q e^{\mu_0} & 0 & \ldots\\
0 & 1 & -q e^{\mu_1} & \ldots\\
   & \ldots & & \\
-\zeta  q e^{\mu_{b-1}} & 0 & \ldots & 1
\end{pmatrix}.
\]
The result follows by taking its determinant.
\end{proof}

\subsubsection{relation with $L$-functions}

Langlands has defined an $L$-function for spherical representations of
$G$.  It is written $L(\pi,V,q^{-s})$, where $\pi$ is an irreducible
admissible representation of $G$ with a $K$-fixed vector, and $V$ is a
representation of the $L$-group ${}^LG$, which we assume factors
through some finite unramified Galois extension $\op{Gal}(E/F)$.

Let $t_\pi\in \hat S$ be the Frobenius-Hecke parameter of $\pi$.  We
let $\theta_1 = \theta = \Frob$, the automorphism of $\hat G$ coming
from the action of Frobenius on the root datum.  We let $M$ be the set
of all weights, so that $V = V_M$.  As observed above, the partition
function $P(\hat G,V,\theta,E,q)$ is a function on $\hat T_1 = \hat
S$.  The partition function evaluates to the local $L$-function.

\begin{lemma} In this context,
\[
P(\hat G,V,\theta,E,q_F^{-s})(t_\pi) = L(\pi,V,q_F^{-s}).
\]
\end{lemma}

\begin{proof} Both sides are defined as the reciprocal of a
  determinant.  On both sides it is the determinant of the same
  element acting on the same vector space.
\end{proof}

\subsubsection{the partition function for the adjoint representation}\label{sec:adjoint}

A case of particular importance for us is the following.  Let $\g$ be
the adjoint representation of $\hat G$.  It is an irreducible highest
weight representation whose highest weight is $\theta$-fixed.  Hence
$\g$ extends to an irreducible representation of $\hat
G\rtimes\ang{\theta}$.  Let $\n$ be the Lie algebra of $\hat N$.  Then
$\n = \g_M$, where $M$ is the set of positive roots.  The set $M$ is
$\theta$-stable.  We have a partition function
\[
P(\hat G,\n,\theta,E,q).
\]
Much of this article handles this particular case.  When $\hat G$,
$\n$, and $\theta$ are fixed, we abbreviate $P(E,q) = P(\hat
G,\n,\theta,E,q)$.

Recall that each $\alpha\in \Sigma^+_1$ has the form
$[\beta^\vee]^\vee$, with $[\beta^\vee]\in \Sigma_{red}$ and some
$\beta$ in $\Psi^+$.  The root $\beta$ has a diagram $A_1$ or $A_2$,
associated constant $b=b(\beta)$, and $k N\beta = \alpha$ for diagram
type $A_k$ (Lemma \ref{lemma:norm}).  For each $\alpha\in \Sigma_1$,
we define
\begin{equation}\label{eqn:d}
d_\alpha(q) =
\begin{cases} {1-q^b e^\alpha},    &\text{if diagram } A_1;\\
{(1-q^{2b} e^{\alpha/2})(1+q^b e^{\alpha/2})},
&\text{if diagram } A_2.
\end{cases}
\end{equation}
We have the following factorization refining Lemma \ref{lemma:fact}.

\begin{lemma} \label{lemma:prod}
In this context,
\[
\det(1-\theta  E q ;\n) = \prod_{\alpha\in\Sigma^+_1} d_\alpha(q).
\]
\end{lemma}

\begin{proof} Similar factorizations in the special case $q=1$ are
  found in \cite{jantzen1977darstellungen}, \cite{wendt2001weyl}.
  Here is a sketch.  The determinant is block diagonal, with a block
  for each $\theta$-orbit in $\Psi^+$.

  We first consider diagram type $A_1$.  Write $\alpha = N\beta$, as
  above with $\beta\in\Psi$.  On the block $[\beta]$, we can pick a
  basis $X_i$ of the root spaces $\n_{\theta^i\beta}$ such that
  $\theta$ acts as $\theta X_i = X_{i+1}$, with indices mod $b$.  The
  determinant restricted to this block satisfies the fool's identity
  $\det(I-A) = \det(I)-\det(A)$, which yields $1- \prod_{\beta'\in
    [\beta]} {q e^{\beta'}} = 1- q^b e^{N \beta}$.

  Next consider diagram type $A_2$.  Write $\alpha = 2N\beta$ as
  above.  We choose three positive roots $\beta,\beta',\gamma\in\Psi$
  forming the positive root system of $A_2$, where
  $\gamma=\beta+\beta'$ is the highest root.  We have
  $N\gamma=N\beta=N\beta'=\alpha/2$.  Recall that $b$ is the number of
  components in the Dynkin diagram of type $A_2$.  Then $\theta^b$
  preserves the $A_2$ factor and $\theta^b(\beta)=\beta'$.  There are
  two $\theta$-orbits of roots: $[\gamma]$ and $[\beta]=[\beta']$ of
  cardinalities $b$ and $2b$.  We may pick root vectors
  $X_{\beta},X_{\beta'},X_{\gamma}$ in the root spaces of
  $\beta,\beta',\gamma$ such that
\[
\theta^b(X_\beta)= X_{\beta'},\quad \theta^b(X_{\beta'})=X_\beta,\quad
\theta^b X_\gamma = \theta^b [X_\beta,X_{\beta'}] 
= [X_{\beta'},X_\beta] = -[X_\beta,X_{\beta'}] = -X_\gamma.
\]
Note the sign $(-1)$ that appears for the orbit $[\gamma]$.  We choose
root vectors on the entire orbits by $\theta^i X_\delta=X_{\theta^i
  \delta}$, for $i=1,\ldots,b-1$ and
$\delta\in\{\beta,\beta',\gamma\}$.  We compute the determinant on
these two orbits as before.  For the orbit $[\gamma]$, we obtain
$1+\prod_{\gamma'\in [\gamma]} {q e^{\gamma'}} = 1+ q^b e^{\alpha/2}$.
The orbit $[\beta]$ gives $1-q^{2b} e^{\alpha/2}$.
\end{proof}

In the special case $\theta=1$, the matrix $q \theta E$ is diagonal,
every orbit has cardinality $1$, and the partition function is a
product over positive roots $P(E,q) = \prod_{\beta\in\Psi^+} (1- q
e^\beta)^{-1}$.  This is the classical $q$-partition function.

\begin{corollary}[twisted Weyl denominator]\label{cor:prod1} 
Specializing to $q=1$, we have
\[
P(E,1) = \prod_{\alpha\in\Sigma^+_1} (1-e^{\alpha})^{-1}.
\]
\end{corollary}

\begin{proof}  
Set $q=1$ in the lemma and observe that $d_\alpha(1)=1-e^\alpha$.
\end{proof}

For $w\in W^\theta$, we define $w(E)$ formally, by $w(E) v = e^{
  w^{-1} \beta} v$, for $v\in \n_\beta$.  Then
\[
\op{Ad}(w)(E(\op{Ad}(w^{-1}) v)) = w(E) v.
\] 
\XX{changed from $e^{w\beta}$ on Aug 16.  Macdonald's formula might
  need to be changed.}

\begin{corollary}\label{cor:weyl-p}  
for all $w\in W^\theta$,
\[
P(w(E),q) P(w(E)^{-1},q) = P(E,q)P(E^{-1},q).
\]
\end{corollary}

\begin{proof} 
By the lemma,
\[
P(E,q)P(E^{-1},q) = \prod_{\alpha\in \Sigma_1} d_{\alpha}(q)^{-1},
\]
as $\alpha$ runs over the full root system $\Sigma_1$.  The result
follows by observing that $w\in W^\theta$ permutes $\Sigma_1$,
preserving the diagram type $A_k$ and constant $b$ attached to each
root.
\end{proof}



\subsection{twisted Weyl character formula}

We review the proof of the Weyl-character formula, as presented in
\cite{kostant1961lie}, \cite{jantzen1977darstellungen},
\cite{wendt2001weyl}, and \cite{kumar2009characters}.  At the same
time, we consider various $q$-deformations of the standard formulas.

Let $\lambda$ be a dominant weight in $X^*(\hat T)^\theta = X^*(\hat
S)$.  Let $V_\lambda$ be the irreducible module of $\hat G$ with
highest weight $\lambda$.  The $\theta$-invariance of $\lambda$
implies that $V_\lambda$ extends uniquely to a representation of $\hat
G \rtimes \ang{\theta}$ such that $\theta v = v$ for $v$ in the
highest weight space of $V_\lambda$.  We let $\tau_\lambda$ be the
character on $V_\lambda$, restricted to $\hat G\rtimes\theta$.   The
$\theta$-conjugacy class of $t\theta\in \hat T\rtimes\theta$ depends
only on the image of $t$ in $\hat S$.  Thus, we may consider
$\tau_\lambda\in \ring{C}[X^*(\hat S)] =\ring{C}[Y^*]$.  Furthermore,
$\tau_\lambda$ is $W^\theta$-invariant.

Let $\rho = \rho(\Psi^+) = \rho(\Sigma^+_1)$.  We define a dot
operator $w\bullet \mu = w(\mu+\rho)-\rho$, for $w\in W^\theta$ and
$\mu\in Y^*$.  We define an alt-symmetrizer operator
\[
J:\ring{C}[Y^*]\to \ring{C}[Y^*],
\quad J(f) = \sum_{w\in W^\theta} (-1)^{\ell(w)} w(f e^\rho) e^{-\rho}.
\]

\begin{theorem}[twisted Weyl character]  
  For every dominant weight $\lambda\in X^*(\hat T)^\theta = X^*(\hat
  S)$.  The irreducible representation $V_\lambda$ of ${}^LG$ has
  character $\tau_\lambda\in \ring{C}[Y^*]$ on $\hat G\rtimes \theta$,
  where
\[
\tau_\lambda = J(e^\lambda) P(E^{-1},1).
\]
\end{theorem}


The Weyl denominator $P(E^{-1},1)$ is computed in Corollary
\ref{cor:prod1}.  If we take $\lambda=0$, then $\tau_\lambda=1$, and
the Weyl character formula gives a second formula for the Weyl
denominator:
\begin{equation}\label{eqn:wd2}
1= J(1) P(E^{-1},1).
\end{equation}
It is a remarkable consequence of the Weyl character formula that the
twisted character $\tau_\lambda$ is identical to the irreducible
character of $\hat G_\theta$ with highest weight $\lambda$.


\begin{proof} 
  We follow Kostant \cite{kostant1961lie}.  Let $\n$ be the Lie
  algebra of $\hat N$, considered as a module of ${}^L\hat T=\hat
  T\rtimes\ang{\theta}$ by the adjoint representation, and let $\n'$
  be its contragredient.  We write $\chi_j$ for the character of the
  exterior power $\Lambda^j \n'$.  We write $\tilde\chi_q = \sum_j
  (-q)^j\chi_j$ for the $q$-graded virtual character on the sum of
  $\Lambda^j \n'$, with grading $(-q)^j$ on the $j$th summand.

  The character $\tilde\chi_q$ evaluated at $\theta t$ depends only on
  the image $s\in\hat S$ of $t\in \hat T$.  We have
\[
P(E^{-1},q)^{-1}(s) = \det(1- q\theta t;\n') 
= \sum_j (-q)^j \chi_j(t\theta) = \tilde\chi_q(t\theta).
\]
The sum is obtained from the determinant by picking a basis of
eigenvectors of $\theta t$ on $\n'$ and expanding into a polynomial in
$q$.  We have $E^{-1}$ rather than $E$ because $\n'$ is the
contragredient of $\n$.  This gives
\begin{equation}\label{eqn:tilde}
\tilde\chi_q P(E^{-1},q) = 1.
\end{equation}

Upon specialization to $q=1$, the spaces $C^j=\Lambda^j \n'\otimes
V_\lambda$ are the terms of a cochain complex of ${}^LT$-modules.  We
consider the virtual character $\tilde \tau_\lambda$ on the sum of
$C^j$, with grading $(-1)^j$ on $C^j$.  By an Euler-Poincar\'e
argument, $\tilde\tau_\lambda$ equals the character on the cohomology
of the complex.  The cohomology has been computed explicitly
\cite{kostant1961lie}.  These computations show that for each $w\in
W^\theta$, the weight $e^{w\bullet \lambda}$ occurs once in cohomology
with sign $(-1)^{\ell w}$.  Thus, in terms of the operator $J$, we
have
\[
\tilde \tau_\lambda = J(e^\lambda) 
= \sum_{w\in W^\theta} (-1)^{\ell(w)} e^{w\bullet\lambda}.
\]

We have a product decomposition $\tilde \tau_\lambda = \tilde
\chi_{1}\tau_\lambda $ by the description of $C^j$ as a tensor
product.  Multiplying both sides by $P(E^{-1},1)$, and using Equation
\ref{eqn:tilde}, we obtain the twisted Weyl character formula
\begin{equation}
\tau_\lambda = J(e^\lambda) P(E^{-1},1).
\end{equation}
\end{proof}

It is natural to extend $\tau_\lambda$ to a $q$-character by defining
$\tau_{\lambda,q}$ by $\tilde \tau_\lambda = \tilde
\chi_q\tau_{\lambda,q} $, so that
\begin{equation}
\tau_{\lambda,q} = J(e^\lambda) P(E^{-1},q).
\end{equation}
We leave it as a research problem to find interpretations of
$\tau_{\lambda,q}$, along the lines of Kazhdan-Lusztig polynomials.
Kato and Lusztig give an answer when $\theta=1$.


\subsection{Macdonald's formula}\label{sec:macdonald}

Let $K$ be a hyperspecial maximal compact subgroup of $G$.  The
spherical Hecke algebra $\H_{\ring{C}}(G//K)$ is the convolution
algebra of all complex-valued compactly support $K$-biinvariant
functions on $G$.  It has a linear basis consisting of characteristic
functions $f_\mu$ of double cosets $K\varpi^\mu K$, for $\mu\in P^+$.
By the Satake isomorphism, $\H(G//K)$ is isomorphic to the algebra
$\ring{C}[Y^*]^{W^\theta}$.  We write $\hat f_\mu\in \ring{C}[Y^*]$
for the image of $f_\mu$ under the Satake isomorphism.

We continue in the context of a complex group $\hat G \rtimes
\ang{\theta}$ and keep earlier notation.  As usual, we identify
elements of $\ring{C}[Y^*]$ with functions on $\hat S$.  As before
$\Phi=\Psi^\vee$ and $\Psi = \Phi^\vee$ are dual root systems.  Let
$\rho^\vee = \rho(\Phi^+)\in X_*(\hat T)$.

For each subset $S$ of the set $\Delta_1$ of simple roots in
$\Sigma^+_1$, let $W_S\le W^\theta$ be the group generated by the
reflections in $S$.  Let $\ell' w$ be the length of $w\in W$ (as a
function of the Weyl group $W$, and not the Weyl group $W^\theta$).
Let $Q_S(q^{-1}) = \sum_{w\in W_S} q^{-\ell'w}$.  We abbreviate
$Q(q^{-1}) = Q_{\Delta_1}(q^{-1})$.  For each $\mu\in P^+\subset Y^*$,
let $S(\mu)$ be the subset of $\Delta_1$ such that
$\ang{\mu,\alpha^\vee}=0$ iff $\alpha^\vee\in S(\mu)$.

\begin{theorem}[Macdonald's formula]\label{thm:macdonald}
  Let $G$ be an unramified $p$-adic reductive group with $L$-group
  ${}^LG = \hat G \rtimes \ang{\theta}$.  For each $\mu\in P^+$, let
  $\hat f_\mu$ be the Satake transform of the characteristic function
  of $K\varpi^\mu K$, viewed as an element of
  $\ring{C}[Y^*]^{W^\theta}$.  Then
\[
\hat f_\mu = \frac{q^{\ang{\mu,\rho^\vee}}}{ Q_{S(\mu)}(q^{-1})} 
\sum_{w\in W^\theta} e^{w\mu} \frac{P(w(E)^{-1},1)}{P(w(E)^{-1},q^{-1})}.
\]
\end{theorem}

The partition function encodes the constants $q_\alpha$,
$q_{\alpha/2}$ that occur in the traditional formula
\cite{macdonaldspherical}.  Our formula is closely tied to the root
system $\Sigma_1$ of $\hat G_\theta$ that occurs in the twisted Weyl
character formula for ${}^LG$.  The formula in the theorem was
previously known when $G$ is split ($\theta=1$).

There is a related formula for the spherical function
$\Gamma:P^+\times\hat S\to\ring{C}$ that we mention.  For every
$\mu\in P^+$,
\begin{equation} 
\Gamma_\mu = 
\frac{q^{-\ang{\mu,\rho^\vee}}}{ Q(q^{-1})} 
\sum_{w\in W^\theta} e^{w\mu} \frac{P(w(E)^{-1},1)}{P(w(E)^{-1},q^{-1})}.
\end{equation}

\begin{proof}[Proof of Macdonald's formula]
  Our proof will relate the formula in the theorem to the standard
  form of Macdonald's formula.  Macdonald's formula is elaborated in
  \cite{casselman1980unramified} and \cite{casselman2005companion}.
  In the following discussion, we index terms by
  $\alpha\in\Sigma_{red}$ (or $\alpha^\vee\in \Sigma_1 =
  (\Sigma_{red})^\vee$), although terms in Macdonald's formula are
  traditionally indexed by $\Sigma^{red}$, the set of nonmultipliable
  roots in $\Sigma$.  This is a harmless change, because
  $\Sigma_{red}$ is in natural bijection with $\Sigma^{red}$ by
  sending each indivisible root $\alpha$ to the homothetic root
  $k\alpha\in\Sigma^{red}$.

  Recall that for each $\alpha\in \Sigma^+_{red}$, associated with an
  orbit $\alpha=[\beta]$ in $\Phi$, there is a diagram type $A_k$, for
  some $k\in\{1,2\}$, and cardinality $b$ (the number of connected
  components of the Dynkin diagram of $\beta$).  Casselman and
  Macdonald construct an element $a_{\alpha}\in T$, for each
  $\alpha\in\Sigma_{red}$.  Let $\alpha_1 = \alpha^\vee\in \Sigma_1$
  be its coroot.  By the explicit formulas in
  \cite{casselman2005companion}, for diagram type $A_k$, we have
  $a_\alpha = (k\alpha)^\vee(\varpi) = (\alpha_1/k)(\varpi)$.  Let
  $s\in \hat S$, and let $\chi_s\in\op{Hom}(T,\ring{C}^\times)$ be the
  associated unramified character.  Then
\[
\chi_s(a_{\alpha}) = \chi_s((\alpha_1/k)(\varpi)) = e^{\alpha_1/k}(s).
\]
Macdonald's formula is traditionally expressed in terms of the
constants $\chi_s(a_\alpha)$, which we rewrite in terms of
$e^{\alpha_1/k}$, for $\alpha_1\in\Sigma^+_1$.

For each $\alpha_1\in\Sigma^+_1$, we define a function
$c_{\alpha_1}:\hat S\to\ring{C}$ by
\[
c_{\alpha_1}(s) = d_{\alpha_1}(q^{-1})/d_{\alpha_1}(1),
\]
following the definition of $d_{\alpha_1}$ in Equation \ref{eqn:d}.
We define a function $\gamma:\hat S\to \ring{C}$ by
\[
\gamma(s)  = \prod_{\alpha_1\in \Sigma^+_1} c_{\alpha_1}(s^{-1}).
\]
It follows from Lemma \ref{lemma:prod} that
\begin{equation}\label{eqn:gamma}
\gamma = P(E^{-1},1)/P(E^{-1},q^{-1}).
\end{equation}

The traditional Macdonald formula is expressed as a sum of $\gamma$
over $W^\theta$.  If we use Equation (\ref{eqn:gamma}) to substitute
for $\gamma$ in the traditional formula, then Theorem
\ref{thm:macdonald} is the result.

The formula for $Q_S(q^{-1})$ relies on the observation that $q^{\ell'
  w} = \op{card}(IwI/I)$, where $I$ is an Iwahori subgroup, and the
length is computed with respect to the absolute Weyl group $W$
\cite[p.74]{carter1985finite}.
\end{proof}


\subsection{Plancherel measure}
We continue in the same context, letting $G$ be an unramified
reductive group and $K$ a hyperspecial maximal compact subgroup.  Let
${}^LG = \hat G\rtimes \ang{\theta}$, and we continue with notation
from previous sections.

Let $\hat S_1$ be the maximal compact subgroup of $\hat S$.  Let $ds$
be the Haar measure on $\hat S_1$ normalized so that $\hat S_1$ has
volume $1$.  Let $(\cdot,\cdot)$ be the inner product with respect to
the Haar measure on $\hat S_1$. That is,
\begin{equation}
(f_1,f_2) = \int_{\hat S_1} f_1(s) \bar f_2(s) ds.
\end{equation}
Multiplicative characters of $\hat S_1$ are orthonormal:
$(e^\lambda,e^\mu) = \delta_{\lambda,\mu}$.

We define a measure on $\hat S_1$ by
\begin{equation}
dm(s) = \frac{Q(q^{-1})}{\op{card}(W^\theta)}
\frac{P(E,q^{-1}) P(E^{-1},q^{-1})}{P(E,1) P(E^{-1},1)} ds.
\end{equation}
It will be checked below that the partition functions defining $dm(s)$
have nonzero denominators on $\hat S_1$.  Let $\ang{\cdot,\cdot}$ be
the pairing provided by this measure on continuous functions on $\hat
S_1$.  That is,
\begin{equation}
\ang{f_1,f_2} = \int_{\hat S_1} f_1(s) \bar f_2(s) dm(s).
\end{equation}

The proof of the Plancherel measure uses the following averaging lemma.

\begin{lemma}\label{lemma:average} 
  Let $f$ be continuous on $\hat S_1$ and $W^\theta$-invariant.  Then
\[
\ang{f,\hat f_\mu} = c_\mu  (f, e^\mu\frac{ P(E,q^{-1})}{P(E,1)}),
\quad\text{where }\quad
c_\mu = q^{\ang{\mu,\rho^\vee}}\frac{ Q(q^{-1})}{Q_{S(\mu)}(q^{-1})}.
\]
\end{lemma}

\begin{proof}  
  The measure $dm(s)$ is $W^\theta$-invariant by Corollary
  \ref{cor:weyl-p}.  As a consequence, we may push a sum over
  $W^\theta$ over to $f$ to obtain
\begin{equation}\label{eqn:inv}
\ang{f,\sum_{w\in W^\theta} w(f_1)} = \card(W^\theta)\ang{f,f_1},
\end{equation}
for any continuous function $f_1$ on $\hat S_1$.
In particular, assume that $f_1=\hat f_\mu$, which Macdonald's
formula presents a sum over $W^\theta$.
This means that in $\ang{f,\hat f_\mu}$, we may replace 
$\hat f_\mu$  with
the $w=1$ term  in Macdonald's formula.

The constant $c_\mu$ is the product of the constants appearing in
Macdonald's formula, the Plancherel measure, and Equation
\ref{eqn:inv}:
\[
c_\mu = \left(\frac{q^{\ang{\mu,\rho^\vee}}}{Q_S(q^{-1})}\right)\left(\frac{Q(q^{-1})}{\op{card}(W^\theta)}\right) \op{card}(W^\theta).
\]

The conjugate of $e^\mu$ is $e^{-\mu}$ and of $E$ is $E^{-1}$ on $\hat
S_1$, because $\bar s = s^{-1}$, for $s\in \hat S_1$.  We have
\begin{align*}
\ang{f,\hat f_\mu} &=
c_\mu\int_{\hat S_1} f \left(e^{-\mu} \frac{P(E,1)}{P(E,q^{-1})}\right) \left(\frac{P(E,q^{-1}) P(E^{-1},q^{-1})}{P(E,1)(E^{-1},1)}\right) ds\\
&=
c_\mu\int_{\hat S_1} f \left(e^{-\mu} \frac{P(E^{-1},q^{-1})}{P(E^{-1},1)}\right) ds\\
&=
c_\mu (f, e^\mu\frac{ P(E,q^{-1})}{P(E,1)}).
\end{align*}
\end{proof}

\begin{theorem}[Plancherel measure]
  The denominators are nonzero on $\hat S_1$ in the partition
  functions defining $dm(s)$.  The Plancherel measure is supported on
  $\hat S_1$ and is given explicitly by $dm(s)$ on $\hat S_1$.
\end{theorem}

\begin{remark}
  We recall the defining property of the Plancherel measure for the
  spherical Hecke algebra.  The Plancherel measure is $dm(s)$ if for
  all $f_1,f_2\in \H_{\ring{C}}(G,K)$,
\[
\int_G f_1(g) \bar f_2 (g) dg = \int_{\hat S} \hat f_1(s) \bar {\hat f}_2 (s) dm(s).
\]
When $\mu\ne\lambda$, the integral on the left is trivial to compute
for the functions $f_1 = f_\lambda$ and $f_2 = f_\mu$ because the
functions $f_\mu$ and $f_\lambda$ have disjoint support, giving $0$.
When $\mu=\lambda$, the integral on the left is the volume of
$K\varpi^\mu K$.  This volume is $c_\mu q^{\ang{\mu,\rho^\vee}}$ by
\cite{casselman2005companion}, where $c_\mu$ is the constant in Lemma
\ref{lemma:average}.  The proof of the theorem proceeds by computing
the inner products $\ang{\hat f_\lambda,\hat f_\mu}$ and showing that
they give the same values as the integral on the left.
\end{remark}

\begin{proof}  
  The proof, which we review, is due to Macdonald
  \cite[Ch.V]{macdonaldspherical}.  It is what he calls {\it the
    standard case}.  Choose any total order $(<)$ on $P^+\subset Y^*$
  such that $\lambda < \lambda + \alpha$, whenever $\alpha = N\beta$
  is the norm of a positive root $\beta\in\Psi^+$.

  By Lemma \ref{lemma:prod}, the ratio $P(E,q^{-1})/P(E,1)$ factors
  into a product of terms of the form $(1- t)/(1- q^{-b} t)$, where
  each $t = \epsilon e^{N\beta} = \epsilon e^\alpha$ for some root
  $\beta$ with norm $\alpha$, for some sign $\epsilon\in \{\pm 1\}$,
  and for some $b\ge 1$.  For any $p$-adic field $F$, we have $q = q_F
  > 1$ and $q^{-b} < 1$.  Thus we have an absolutely convergent
  expansion in $t$:
\begin{equation}\label{eqn:t}
\frac{1- t}{1- q^{-b} t} = 1 + (q^{-b}-1) t (1+ q^{-b} t + q^{-2b} t^2 + \cdots),
\end{equation}
noting that $|t| = |\alpha(s)|=1$ at each $s\in \hat S_1$.  In
particular, the denominator of $P(E,q^{-1})/P(E,1)$ does not vanish.
Similarly, the denominator of $P(E^{-1},q^{-1})/P(E^{-1},1)$ does not
vanish because $|q^{-b} t^{-1}|\ne1$, giving the nonvanishing of the
denominator in the measure $dm(s)$.

By multiplying the series expansions (Equation \ref{eqn:t}) associated
with each factor of $P(E,q^{-1})/P(E,1)$, it follows that for each
$\mu\in P^+$ we have an absolutely convergent expansion of the form
\[
e^\mu \frac{P(E,q^{-1})}{P(E,1)} = e^\mu +\sum_{\mu< \mu'} a_{\mu'} e^{\mu'},
\] 
for some coefficients $a_{\mu'}$ that turn out not to matter.

We compute $\ang{\hat f_\lambda,\hat f_\mu}$.  We may assume without
loss of generality that $\lambda \le \mu$.


We have a finite expansion (see Equation \ref{eqn:s} below)
\[
\hat f_\lambda = q^{\ang{\lambda,\rho^\vee}} m_\lambda 
+ \sum_{\lambda' <\lambda } s_{\lambda\,\lambda} m_{\lambda'}.
\]
Also, for $\lambda',\mu'\in P^+$, we have
\[
(m_{\lambda'},e^{\mu'}) = \delta_{\lambda',{\mu'}}.
\]
The function $\hat f_\lambda$ is $W^\theta$-invariant, which justifies
the use of the averaging lemma (Lemma \ref{lemma:average}) to simplify
the inner product.  Invoking the averaging lemma, expanding
everything, and integrating term by term, we have
\begin{align*}
\ang{\hat f_\lambda,\hat f_\mu} 
&= c_\mu (\hat f_\lambda, e^\mu \frac{ P(E,q^{-1})}{P(E,1)})\\
&= c_\mu (q^{\ang{\lambda,\rho^\vee}} m_\lambda,e^\mu) 
+ \sum_{\lambda' < \lambda\le\mu < \mu'}
c_\mu s_{\lambda',\lambda} a_{\mu'} (m_{\lambda'},e^{\mu'})\\ 
&= c_\mu q^{\ang{\mu,\rho^\vee}} \delta_{\lambda,\mu}.
\end{align*}

Comparing this inner product with the inner products in the remark, we
see that the proof is complete.
\end{proof}

\subsection{inverting weight multiplicities}

This section follows van Leeuwen's algorithm to invert the weight
multiplicity matrix~\cite{vanleeuwen}.  For type $A_n$, van Leeuwen's
formula agrees with the inverse of the Kostka matrix described in
\cite{duan}.

We have two bases of $\ring{C}[Y^*]^{W^\theta}$, given by
$\{m_\lambda\}$ and $\{\tau_\lambda\}$, indexed by $\lambda\in \dom$.
The change of basis matrix expressing $\tau_\lambda$ in terms of
$m_\mu$ is the weight multiplicity matrix $m_{\lambda,\mu} =
(\tau_\lambda,e^\mu)$.  In the reverse direction, for $\mu\in P^+$, we
have a change of basis matrix $n_{\mu,\lambda}$
\begin{equation}\label{eqn:n}
m_\mu = \sum_{\lambda} n_{\mu,\lambda} \tau_\lambda,
\end{equation}
with $\mu,\lambda\in P^+$.
This section gives a formula for $n_{\mu,\lambda}$.  

We have a set $Y^*_0\subseteq Y^*$ of characters $\lambda$ such that
$\lambda$ is fixed (that is, $w\bullet \lambda = \lambda$) by some
reflection $w\in W^\theta$.  For each $w\in W^\theta$, we define
\begin{equation}
Y^*_w = \{\lambda\in Y^*\mid w\bullet \lambda \in\dom\}.
\end{equation}
These sets partition $Y^*$, so that each $\lambda\in Y^*$ belongs to a
unique $Y^*_x$, for $x\in W^\theta\cup\{0\}$.  Let $e_w$ be the
characteristic function of $Y^*_w$.

Recall that we have defined an operator $J$ that has the property
$J(f) = f J(1)$ if $f\in \ring{C}[Y^*]^{W^\theta}$.  In particular,
using the Weyl denominator formula (\ref{eqn:wd2}), we find that
\begin{equation}
 J(\tau_\lambda) = \tau_\lambda J(1) 
= J(e^\lambda) P(E^{-1},1) J(1) = J(e^\lambda),\quad  \lambda\in P^+.
\end{equation}
In the opposite direction, we define a desymmetrizer operator $L$ by
\[
L(e^\mu) = \begin{cases}
0,& \mu\in Y^*_0;\\
(-1)^{\ell{w}} e^{w\bullet \mu},& \mu\in Y^*_w.
\end{cases}
\]
We extend $L$ linearly to $\ring{C}[Y^*]$.  The operator $L$ can be
characterized as the unique linear operator whose range is supported
on the dominant weights and such that $J(f) = J(L(f))$, for $f\in
\ring{C}[Y^*]$.  By this characterization, $L(\tau_\lambda) =
e^\lambda$, for $\lambda\in\dom$.  This means that for any $f =
\sum_{\lambda\in P^+} c_\lambda \tau_\lambda \in \ring{C}[Y^*]$, the
coefficient $c_\lambda$ is the coefficient of $e^\lambda$ in $L(f)$.
This is van Leeuwen inversion.
We have
\[
L(e^\mu) = \sum_{w\in W^\theta} (-1)^{\ell w} e^{w\bullet \mu} e_w(\mu).
\]

Recall that $S(\mu)$ is defined as the set of simple roots such that
$\ang{\alpha^\vee,\mu}=0$ iff $\alpha\in S(\mu)$.  Recall also that
$W_S\le W^\theta$ is the subgroup generated by reflections in $S$.

\begin{lemma}[van Leeuwen]  \label{lemma:van}
  For each subset $S$ of the set of simple roots of $\Sigma^+_1$, and
  for every $\mu\in P^+$ with $S = S(\mu)$,
\[
n_{\mu,\lambda}=\sum_{(w',w)\in (W^\theta/W_S)\times W^\theta}
 (-1)^{\ell(w)} e_w(w'\mu) \delta_{w\bullet (w'\mu),\lambda}. 
\]
\end{lemma}

\begin{proof}  
\[
m_\mu = \sum_{w'\in W^\theta/W_S} e^{w' \mu}.
\]
Then
\begin{align*}
n_{\mu,\lambda} 
    &= (\sum_{\lambda'} n_{\mu,{\lambda'}} e^{\lambda'},e^\lambda) \\
     &= (L(\sum_{\lambda'} n_{\mu,\lambda'} \tau_{\lambda'}),e^\lambda) \\
     &= (L(m_\mu),e^\lambda) \\
     &= \sum_{w'\in W^\theta/W_S} (L(e^{w'\mu}),e^\lambda)\\
     &= \sum_{w'\in W^\theta/W_S} \sum_{w\in W^\theta} 
      (-1)^{\ell w} e_w(w'\mu) (e^{w\bullet (w'\mu)},e^\lambda)
\end{align*}
\end{proof}


\subsection{geometric Satake}

Let $K$ be a hyperspecial maximal compact subgroup of $G$.  In the
usual formulation, the Satake transform is an isomorphism of the Hecke
algebra $\H_\ring{C}(G//K)$, with the $W^\theta$-invariant functions
in the group algebra $\ring{C}[A]$.  As first pointed out by
Langlands, this is the space of conjugation invariant functions on the
coset $\hat G\rtimes \theta$ in ${}^LG$.  For split groups, the
geometric Satake transform reformulates the transform in the language
of sheaves and in terms of the representation ring of $\hat G$
\cite{mirkovic2007geometric}.  For a geometric approach to geometric
Satake that includes unramified groups, see \cite{zhu2011geometric}.

The identities we give should be viewed as formal analogues of
geometric Satake by the function-sheaf
dictionary. % \cite[\S7]{haines2003iwahori}.
Working formally with irreducible characters, the geometric Satake
transform expresses each $\hat f_\lambda$ in terms of the basis
$\tau_\mu$ of irreducible characters for the root system $\Sigma_1$:
\begin{equation}\label{eqn:geometric-satake}
\hat f_\lambda = \sum_\mu g_{\lambda,\mu} \tau_\mu.
\end{equation}
Casselman gives a formula for the coefficients $g_{\lambda,\mu}$ when
$G$ is split \cite{casymmetric}.  In this section, we extend the
result to $G$ unramified.  The statement here is less polished than
what is known in the split case \cite{casymmetric}.  The proof we
present here is based on van Leeuwen's algorithm.

Define
\[
C = \{  - \sum_{\alpha\in S}\alpha \ \ \mid S \subseteq \Psi^+ \}^\theta;
\]
\XX{Do we need $w^{-1}$ now?}
Define $p_\mu(q^{-1})$ by
\begin{equation}\label{eqn:p}
 P(E^{-1},q^{-1})^{-1} = \sum_{\mu\in C} p_\mu(q^{-1}) e^{\mu},
\text{\ \ so }  P(w(E)^{-1},q^{-1})^{-1} 
= \sum_{\mu\in C} p_\mu(q^{-1}) e^{w\mu}.
\end{equation}

\begin{theorem}  Let $\lambda\in P^+$ and let $S=S(\lambda)$.
\[
\hat f_\lambda = \frac{q^{\ang{\lambda,\rho^\vee}}}{Q_S(q^{-1})} 
\sum_{\mu\in C}\left(\sum_{w\in W^\theta} 
(-1)^{\ell w} p_{\mu}(q^{-1}) e_w(\lambda+\mu)\right)  
\tau_{w\bullet(\lambda+\mu)}.
\]
\end{theorem}

\begin{proof}
  Abbreviate $r_\lambda = q^{\ang{\lambda,\rho^\vee}}/Q_S(q^{-1})$.
  By the Weyl denominator product formula (Corollary \ref{cor:prod1}),
\begin{equation}
P(w(E),1) = (-1)^{\ell w} e^{w\rho - \rho} P(E,1),
\end{equation}
Then expanding Macdonald's formula using this and Equation
\ref{eqn:p}, we get
\[
\hat f_\lambda = r_\lambda \sum_{\mu\in C} p_\mu(q^{-1}) P(E^{-1},1) J (e^{\lambda+\mu}),
\]
where we have absorbed the sum over $W^\theta$ in Macdonald's formula
into $J$.  We observe that
\begin{align*}
L(\hat f_\lambda) &= r_\lambda \sum_{\mu\in C} p_\mu(q^{-1}) L(P(E^{-1},1) J(e^{\lambda+\mu})) \\
&= 
r_\lambda \sum_{\mu\in C} p_\mu(q^{-1}) L(e^{\lambda+\mu}) \\
&= 
r_\lambda
\sum_{\mu\in C} p_\mu(q^{-1}) \sum_{w\in W^\theta} (-1)^{\ell w} e_w(\lambda+\mu) e^{w\bullet (\lambda+\mu)}.
\end{align*}
Recall that the coefficient $c_\lambda$ of an expansion $f =
\sum_\lambda c_\lambda\tau_\lambda$ is the coefficient of $e^\lambda$
in $L(f)$.  The result follows.
\end{proof}

There is a second less explicit form of the geometric Satake transform
that is obtained as follows.  we have
\[
\hat f_\lambda = \sum_{\mu'} s_{\lambda,\mu'} m_{\mu'},
\]
where the coefficients $s_{\lambda,\mu'}$ are given as $p$-adic
integrals (see Equation \ref{eqn:s} below).  By van Leeuwen's formula
linking $m_{\mu'}$ to $\tau_\mu$ with coefficient matrix
$n_{\mu',\mu}$, we obtain the coefficients $g_{\lambda,\mu}$ as a
matrix product:
\begin{equation}
\hat f_\lambda = \sum_{\mu',\mu} s_{\lambda,\mu'} n_{\mu',\mu} \tau_{\mu} = \sum_{\mu} g_{\lambda,\mu} \tau_\mu.
\end{equation}

\subsection{a Kato-Lusztig formula}

%\cite{kato1982spherical} \cite{lusztig1983singularities} in the twisted case) for 
Equipped with Plancherel and Macdonald, we obtain an easy Kato-Lusztig
formula for the inverse Satake transform.  Our result generalizes a
formula that was known when $\theta=1$ \cite{kato1982spherical}
\cite{lusztig1983singularities}.  Recall the $q$-twisted character
$\tau_{\lambda,q}$ from above.  Write
\[
\tau_\lambda = \sum_\mu t_{\lambda,\mu}  \hat f_\mu,
\]
for some constants $t_{\lambda,\mu}$.

\begin{theorem}[Kato-Lusztig formula]
  The coefficients $t_{\lambda,\mu}$ of the inverse geometric Satake
  transform are
\[
t_{\lambda,\mu} =  (\tau_{\lambda,q^{-1}},e^\mu) q^{-\ang{\mu,\rho^\vee}}.
\]
\end{theorem}

\begin{proof}
  The character $\tau_\lambda$ is $W^\theta$-invariant.  We use the
  averaging property (Lemma \ref{lemma:average}) and the Weyl
  character formula to compute an inner product.
\begin{align*}
\ang{\tau_\lambda,\hat f_\mu}
&=c_\mu(\tau_\lambda,e^\mu \frac{P(E,q^{-1})}{P(E,1)})\\
&=c_\mu\int_{\hat S_1} \left(J(e^\lambda) P(E^{-1},1)\right) 
\left( e^{-\mu}\frac{P(E^{-1},q^{-1})}{P(E^{-1},1)} \right) ds\\
&=
c_\mu\int_{\hat S_1} J(e^\lambda) P(E^{-1},q^{-1}) e^{-\mu} ds\\
&= c_\mu(\tau_{\lambda,q^{-1}},e^\mu).\\
\ang{\tau_\lambda,\hat f_\mu}
&=\sum_{\mu'} t_{\lambda,\mu'} \ang{\hat f_{\mu'},\hat f_\mu} \\
&= t_{\lambda,\mu} c_\mu q^{\ang{\mu,\rho^\vee}}.
\end{align*}
\end{proof}


\section{Endoscopic branching rules}\label{sec:branch}

This section uses partition functions to give a branching rule for
the restriction of an irreducible representation of $\hat G\rtimes\theta$
to $\xi(\hat H\rtimes \theta_H)$.

\subsection{$\theta$-conjugacy}

Let $G$ be an unramified reductive group, and let ${}^LG = \hat G
\rtimes \ang{\theta}$ be its $L$-group, with the automorphism $\theta$
given by the action of the Frobenius element on the root datum.  
The calculations in this subsection will be used in Theorem
\ref{thm:branch} to give an explicit branching rule for an embedding of
the $L$-group of an endoscopic groups into the $L$-group of $G$.

We have a  set of simple roots $\Delta\subseteq \Psi$, determined by $(\hat T,\hat
B)$.  Let $\alpha$ be the highest positive root and let $\Delta^e =
\Delta \cup \{-\alpha\}$ be the extended set of simple roots.  The
extended Dynkin diagram has node set $\Delta^e$.  The automorphism
$\theta$ preserves $\Delta$ and fixes $-\alpha$, hence acts on the
extended Dynkin diagram.

Let $w\in W$ be an element that preserves the extended Dynkin diagram.
We consider lifts $\dotw\in N_{\hat G}(\hat T)$ of $w$ such that
$\theta_1 = \dotw \theta$ has finite order.  The partition function
and other data $\epsilon,\phi$ we define are sensitive to the
representative $\dotw$ of $w$.  However, the branching rule that we
obtain in the end (Theorem \ref{thm:branch}) will satisfy a smple transformation
rule depending on $\dotw$ (Lemma \ref{lemma:transform}). 
In each case, we pick a particularly convenient representative $\dotw$
of $w$ to work with, and leave the rest to the transformation rule.  
The details of the choice of $\dotw$ will be
discussed further below.

Let $\hat S = \hat T/(1-\theta)\hat T$ and $\hat T_1 = \hat
T/(1-\theta_1)\hat T$.  There are norm maps $N:X^*(\hat T)\to X^*(\hat
S)$ and $N_1:X^*(\hat T)\to X^*(\hat T_1)$.  If $\theta_1 =\dotw\theta$,
then $\hat T_1$ depends only on $w\theta$ but not $\dotw$ directly.


We write $\Psi^+(\hat T,\hat B)$ for the set of positive roots of
$\hat G$ with respect to Cartan subgroup $\hat T$ and a Borel subgroup
$\hat B$.

\begin{lemma}\label{lemma:adapted}
  In this context, there exists a Borel subgroup $\hat
  B(\theta_1)\supseteq \hat T$ such that for every
  $\alpha\in\Psi^+(\hat T,\hat B(\theta_1))$, either $N_1\alpha = 0$
  or $\ang{\theta_1}\alpha\subseteq \Psi^+(\hat T,\hat B(\theta_1))$.
\end{lemma}

We call $\hat B(\theta_1)$ a {\it $\theta_1$-adapted} Borel subgroup.
The Borel $\hat B(\theta_1)$ depends on $\theta_1$ only through
$w\theta$ (and not $\dotw \theta$).

\begin{proof}  Let 
\[
C = \{N_1\alpha\in X^*(\hat T)^{\theta_1} \mid \alpha\in\Psi,\ N_1\alpha\ne 0\}
\subseteq =X^*(\hat T_1).
\]
Clearly $N_1(-\alpha)= - N_1\alpha$ and $-C = C$.  Choose a hyperplane
through the origin in $X^*(\hat T_1)\otimes\ring{Q}$ that does not
meet $C$ to partition $C = C_+ \sqcup C_-$ into a positive and
negative set.  We can choose a compatible hyperplane through the
origin in $X^*(\hat T)\otimes\ring{Q}$ such that $\alpha$ is positive
or negative according to $N_1\alpha\in C_\pm$, provided that
$N_1\alpha\ne 0$.  By a small generic perturbation of this hyperplane
through the origin, we may assume that for each pair $\pm\alpha$ of
roots such that $N_1\alpha=0$, exactly one of $\pm\alpha$ is positive.
Let $\hat B(\theta_1)$ be the Borel subgroup defined by $\hat T$ and
the positive roots determined by the hyperplane.
\end{proof}

We consider data $(\hat U,\hat B(w\theta),\hat
B_1,\iota,\phi,\epsilon,\dotw)$ of the following type: $\hat U = \hat
T_1$ and $\iota:\hat U\to \hat T_1$ is an isogeny of tori.  Also
$\phi:\hat U\to \hat S$ is a homomorphism, and $\epsilon\in \hat S$ is
an element of finite order.  Finally, $\hat B(w\theta)$ is a
$w\theta$-adapted Borel subgroup and $\hat B_1$ is a $\theta$-stable
Borel subgroup of $\hat G$ containing $\hat T$.


The purpose of the isogeny is to remove all radicals from the formulas that follow.
We always have $\hat U = \hat T_1$, but we maintain two notations for
the same torus to distinguish the source $\hat U$ from the target
$\hat T_1$ of the isogeny $\iota$.  We write $\uu$ for an element of
$\hat U$ and $\iota(\uu)=\tau\in \hat T_1$ for an element of the target of the
isogeny.  Let $\phi_\epsilon:\hat U\to\hat S$ be given by $\phi_\epsilon(\uu)=
\epsilon\phi(\uu)$.

As noted above,
$D(\hat G,M,\theta,E,q)$ is a function on $\hat S$, which we pull back
to a function $\phi^*_\epsilon D(\hat G,M,\theta,E,q)$ on $\hat U$.
Similarly, $\iota^* D(\hat G,M',\dotw \theta,E,q)$ is a function on
$\hat U$.  The $\hat G$-conjugacy class of $t\dotw \theta$ depends
only on the image $\tau\in \hat T_1$ of $t\in \hat T$.  We can
therefore refer to the $\hat G$-conjugacy class of $\tau\dotw\theta$,
for $\tau\in \hat T_1$.

Let $\Psi_{\phi,\theta}(\hat T,\hat B_1)$ be the set of roots $\alpha$ of
  $\Psi^+(\hat T,\hat B_1)$ such that $\phi^*N\alpha\ne 0$, and let
  $\Psi_{w\theta}^+(\hat T,\hat B(\theta_1))$ 
be the set of roots $\alpha$ of $\Psi^+(\hat T,\hat B(\theta_1))$ such
  that $N_1\alpha\ne0$.  Then

\begin{proposition}\label{lemma:ephi}
  Let $G$ be an unramified reductive group with complex dual $\hat
  G\rtimes \ang{\theta}$.  Assume that $w\theta$ acts on the extended
  root system.  Then we can construct $(\hat U,\hat B(w\theta),\hat
  B_1,\iota,\phi,\epsilon,\dotw)$ typed as above such that
\begin{enumerate}
\item (conjugacy) $\tau\dotw\theta$ is $\hat G$-conjugate to
  $\epsilon\phi(\uu) \theta$, where $\iota\uu = \tau\in\hat T_1$;
%\item (non-negativity) $\phi^*\alpha$ is non-negative for every
%  positive root $\alpha$ of $\hat G$ (that is, if $\phi^*\alpha$ is
%  nonzero, then it is positive);
\item (regularity) For each $\alpha\in\Sigma_1$, the zero set of
  $\alpha(\phi_\epsilon(\uu))-1$ is a proper Zariski closed subset of $\hat U$.
   % If $\uu$ is generic in $\hat U$, then
  %$\alpha(\epsilon\phi(\uu))\ne 0$, for every $\alpha\in\Sigma_1$.
\item (partition) 
\begin{equation}
\phi^*_\epsilon D(\hat G,\Psi_{\phi,\theta}(\hat T,\hat B_1),\theta,E,q) =\iota^* D(\hat G,\Psi_{w\theta}^+(\hat T,\hat B(\theta_1)),\dotw\theta,E,q).
\end{equation}
\end{enumerate}
\end{proposition}

We note that $\hat T_1/W_H^{\theta_H}$ classifies
$\theta_H$-semisimple conjugacy classes in ${}^LH$, and
$\hat S/W_G^{\theta}$ classifies $\theta$-semisimple conjugacy classes
in ${}^LG$.  The morphism $\xi$ induces a map of conjugacy classes
$\hat T_1/W_H^{\theta_H}\to \hat S/W_G^\theta$.  The morphism
$\phi:\hat U\to\hat S$ should be viewed as a lifting of this map of
conjugacy classes.  The identity of partition functions should be
viewed as a refinement of the statement that conjugate elements have
the same characteristic polynomial.

We have calculated the determinants on a case-by-case basis and
the answers can be pretty.  For example, if $\theta=1$ and $\hat G$ is
simply laced, the data can be chosen in such a way that the partition
function takes the form \XX{insert-m-alpha-formula}.

\begin{proof}
  We give a reduction to the case that $\hat G$ is semisimple and
  simply-connected.  For this, we allow twisted endoscopic groups with
  non-trivial multiplicative character (and trivial automorphism) in
  the sense of Kottwitz and Shelstad \cite{kottwitz1999foundations}.
  Assume that we are given $w$.  Let $\hat G_{sc}$ be
  the simply connected cover of the derived group of $\hat G$.  Assume
  that we are able to construct $(\hat U_{sc},\hat
  B(w_{sc}\theta),\hat
  B_{1,\sc},\iota_{sc},\phi_{sc},\epsilon_{sc},\dotw_{sc})$ for $\hat
  G_{sc}$.  
  %We may assume the endoscopic data is defined by the
  %centralizer of some $s = \bar s_{sc} z$, where $z$ is central and
  %$\bar s_{sc}$ is the image of $s_{sc}\in \hat G_{sc}$.  We make the
  %embeddings $\xi_{sc}$ and $\xi$ compatible by picking $\dotw
  %_{sc}\in \hat G_{sc}$ such that $\bar \dotw _{sc} = \dotw$.  
  We pick $\dotw$ to be the imageof $\dotw_{sc}$.  Let
  $\hat Z = Z(\hat G)^0$.  Let $\hat G' = \hat Z\times \hat G_{sc}$.

  %Using $s$ and $\dotw$, we construct an endoscopic group $H'$ of $G'$
  %with dual $\hat H'$, and embedding $\xi':{}^LH' \to {}^LG'$
  %compatible with $\xi:{}^LH\to {}^LG$.  We have surjective
  %projections ${}^LH'\to {}^LH$ and ${}^LG'\to {}^LG$.  We identify
  %the root systems of $\hat H$ and $\hat H'$ and
  We identify the root systems of $\hat G$ and $\hat G'$.  We let
  $\hat B_1$ be the Borel with the same set of positive roots as $\hat
  B_{1,sc}$.  Similarly, $\hat B(w\theta)$ is given by the positive
  roots of $\hat B(w_{sc}\theta)$.  We let $\epsilon$ be the image of
  $\epsilon_{sc}$.  We define $\iota:\hat U\to \hat T_1$ by
  \[
  \hat U = \hat Z/(1-\theta)\hat Z \times \hat U_{sc} \to^{(1,\iota_{sc})}
\hat Z/(1-\theta)\hat Z\times \hat T_{1,sc} \to \hat T_1.
  \]
  We define $\phi:\hat U\to \hat S$ by
  \[
  \hat U = \hat Z/(1-\theta)/\hat Z \times \hat U_{sc}\to \hat Z/(1-\theta)\hat Z \times 
  \hat S_{sc}\to \hat S.
  \]
  Properties (1), (2), and (3) hold for this data by routine calculations.

  We may partition connected components of the Dynkin diagram of $\hat
  G$ into orbits under $\theta$.  We give a reduction to the case that
  $\theta$ is transitive on orbits.  Assume that data $(\hat U_i,\ldots)$
  has been constructed from each factor of $\hat G = \hat G_1\times\cdots\times \hat G_r$.
   We have factorizations of $\hat T_1$ and $\hat S$ as
  $r$-fold products.  We may define the data $(\hat U,\ldots)$ for $\hat G$ as
  a $r$-tuples $\phi = (\phi_1,\ldots,\phi_r)$, $\epsilon =
  (\epsilon_{1},\ldots,\epsilon_{r})$, etc.  The verification of properties (1), (2), (3)
  is routine in this case.  This completes the reduction.

  We give a further reduction to $\hat G$ simple.  In fact, let $\hat
  G'$ be a factor of $\hat G$.  Let $k$ be the smallest integer such
  that $\theta':=\theta^k$ acts on $\hat G'$.  Assume that we have data $(\hat
  U',\ldots)$ for $\hat G'$.  
  We write 
  \[
  \hat G = \hat G' \times \theta(\hat G') \times \cdots,
  \quad
  \theta(g_1,\ldots,g_k) = (\theta' g_k, g_1,g_2,\ldots,g_{k-1}),
  \quad
  \dotw = (\dotw',1,1,\ldots,1).
  \]
We have $\hat T = (\hat T')^k$, $\hat S
  = \hat S'$, $\hat T_1 = \hat T_1'$.  We can define $\hat B_1$ and
  $\hat B(w\theta)$ by their positive roots, which we take to be the
  $\theta$-orbits of positive roots of $\hat B_1'$ and $\hat
  B( w'\theta')'$.   Properties (1-conjugacy) and (2-regularity) follow from
  the corresponding properties of $\hat G'$.  The determinant formula follows from
  the identities
  \begin{align*}
    \phi^*_\epsilon D(\hat G,\Psi_{\phi,\theta}^+(\hat T,\hat B_1),\theta,E,q) &=
    \phi'^*_{\epsilon'} D(\hat G',\Psi_{\phi',\theta'}^+(\hat T',\hat B_1'),\theta',E',q^k).\\
    \iota^* D(\hat G,\Psi_{w\theta}^+(\hat T,\hat B(w\theta)),\dotw\theta,E,q) &=
    \iota^* D(\hat G',\Psi_{w'\theta'}^+(\hat T',\hat B(w'\theta')'),\dotw'\theta',E',q^k).
    \end{align*}

  Next, we give a reduction that removes the assumption that $\hat G$
  is simply connected.  That is, it is enough to prove the proposition for
  any group in the isogeny class of $\hat G$.
  Suppose that we have a surjective map $\hat
  G_{sc}\to \hat G$ with kernel $Z' \subseteq Z(G_{sc})$.  Assume that
  we have data $(\hat U,\ldots)$ for $\hat G$.  We show how to construct
  data $(\hat U_{sc},\ldots)$. for $\hat G_{sc}$, adding the subscript
  ${sc}$ to all data attached to $\hat G_{sc}$.  The morphism $\hat U
  \to \hat S\times \hat T_1$ gives $X_*(\hat U)\to X_*(\hat S)\times
  X_*(\hat T_1)$.  Define $\hat U_{sc}$ by defining its character
  lattice to be the preimage in $X_*(\hat U)$ of
\[
X_*(\hat S_{sc})\times X_*(\hat T_{1, sc}) 
\subseteq X_*(\hat S)\times X_*(\hat T_1).
\] 
By restriction, we have
\[
X_*(\hat U_{sc})\to X_*(\hat S_{sc}) \times X_*(\hat T_{1,sc}).  
\]
Define $\hat B_{1,sc}$ and $\hat B_{sc}(w\theta)$
by the bijection of roots between $\hat G$ and $\hat G_{sc}$.
The components give a morphism $\phi_{sc}:\hat U_{sc}\to\hat S_{sc}$
and an isogeny $\iota_{sc}:\hat U_{sc} \to \hat T_{1,sc}$.  Fix any
lift $\dotw_{sc}$ of $\dotw$ to the simply connected cover.

Let $\epsilon_{sc}\in \hat S_{sc}$ be any lift of
$\epsilon\in \hat S$.  For every $\uu\in \hat U_{sc}$ with image
$\tau\in \hat T_{1,sc}$, the elements $\epsilon_{sc}\phi_{sc}(\uu)$
and $\tau\dotw_{sc}\theta$ have the same image in $\hat S/W^\theta$.
For each $z\in Z'$, define
\[
\hat U_{sc,z} = \{\uu \in \hat U_{sc}\mid 
z \epsilon_{sc}(\uu)\phi_{sc}(\uu)\theta\text{ and }
\iota_{sc}(\uu)\dotw_{sc}\theta \text{ same image in } \hat S_{sc}/W^\theta\}.
\]
%Each set $\hat U_{sc,z}$ is closed in $\hat U_{sc}$. 
 It follows from
the fact that conjugacy (property 1) holds for $\hat G$ that
\[
\hat U_{sc} = \cup_{z\in Z'} \hat U_{sc,z},
\]
expressing an irreducible set $\hat U_{sc}$ as a finite union of
Zariski closed subsets.  It follows that $\hat U_{sc} = \hat U_{sc,z}$
for some $z\in Z'$.  We replace $\epsilon_{sc}$ by $z\epsilon_{sc}$.
Then $\hat U_{sc} = \hat U_{sc,1}$.  That is, property (1) holds for
$\hat G_{sc}$.  Regularity (2) follows from property (2-regularity)
for $\hat G$.

Property (3-partition) follows because the determinant
is computed by the adjoint representation,  and the groups $\hat G$
and $\hat G_{sc}$ have the same adjoint group.


We say that $w\theta$ has outer type, if $w_1 w \theta
w_1^{-1}=\theta$ for some $w_1\in W$.  Next, we prove the proposition
when $w\theta$ has outer type.

Let $\dotw'$ and $\dotw_1$ be lifts of $w$ and $w_1$ to $N_{\hat
  G}(\hat T)$.  Then
\[
\dotw_1 \dotw' \theta\dotw_1^{-1} = t\theta,
\]
for some $t\in \hat T$.  Let $\dotw = \dotw_1^{-1} t^{-1}
\dotw_1\dotw'$.  Then $\dotw\mapsto w$ and
\begin{equation}\label{eqn:outer}
\dotw_1\dotw \theta\dotw_1^{-1} = \theta.
\end{equation}

Set $\hat B(\theta_1) = \hat B^{w_1}$.  Then $\hat B(\theta_1)$ is
$\theta_1$-stable.  This implies that there are no roots $\alpha$ such
that $N_1\alpha=0$.  Thus,
\[
\Psi_{w\theta}^+(\hat T,\hat B(w\theta)) = 
\Psi^+(\hat T,\hat B(w\theta)).
\]

Set $\hat B_1 = \hat B$.  We take $\epsilon=1$ and $\iota:\hat
U\to\hat T_1$ to be the identity map.  We have isomorphisms
\begin{equation}
\hat U = \hat T_1 = \hat T/(1-\theta_1) \hat T 
= \hat T/(1-w \theta)\hat T 
= \hat T/(1-\theta)\hat T = \hat S.
\end{equation}
The isomorphism $\hat T/(1-w \theta)\hat T\to \hat T/(1-\theta)\hat T$
is given by $t \mapsto w_1 t w_1^{-1}$.

We compute the partition functions for data of outer type.
Let $\g$ be the Lie algebra of $\hat G$.  We have an isomorphism
\[
\psi:\g\to \g,\quad X\mapsto \op{Ad}(\dotw_1) X,
\]
sending $\g_{\Psi^+(\hat T,\hat B(w\theta))}$ to $\g_{\Psi^+(\hat T,\hat B)}$.  Then
\begin{align*}
\iota^* D(\hat G,\Psi^+(\hat T,\hat B(w\theta)),\dotw\theta,E,q) &=
D(\hat G,\dotw_1^{-1}\Psi^+(\hat T,\hat B),\dotw_1^{-1}\theta \dotw_1,E,q) \\ &=
\det(1-\dotw_1^{-1} \theta\dotw_1 E q; \g_{\dotw_1^{-1}\Psi^+(\hat T,\hat B)}) \\ &=
\det(1 - \psi(\dotw_1^{-1} \theta\dotw_1 E) q; \g_{\Psi^+(\hat T,\hat B)}) \\ &=
\det(1- \theta \dotw_1 E \dotw_1^{-1} q;\g_{\Psi^+(\hat T,\hat B)}) \\ &=
D(\hat G,\Psi^+(\hat T,\hat B),\theta,{}^{\dotw_1} E,q).
\end{align*}

On the other hand, $\phi$ is an isomorphism so $\phi^*(N\alpha)=0$ iff
$N\alpha=0$ iff $\alpha=0$.  Thus, $\Psi_{\phi,\theta}^+(\hat T,\hat B_1) = 
\Psi^+(\hat T,\hat B)$.  We have
\begin{align*}
\phi^*_\epsilon D(\hat G,\Psi^+(\hat T,\hat B),\theta,E,q)(\tau) &=
D(\hat G,\Psi^+(\hat T,\hat B),\theta,E,q) (w_1\tau w_1^{-1}) &=
D(\hat G,\Psi^+(\hat T,\hat B),\theta,{}^{\dotw_1} E,q) (\tau).
\end{align*}
These determinant formulas give property (3) of the proposition.

To prove property (1-conjugacy), we can realize the $\hat G$-conjugacy
of $\tau \dotw \theta$ and $\phi(\tau)\theta = \dotw_1\tau
\dotw_1^{-1}\theta$ explicitly by conjugation by $\dotw_1$.

To prove property (2-regularity), we observe that
$\alpha(\phi(\tau))=1$ iff $\alpha(\dotw_1\tau\dotw_1^{-1})=1$.  This
occurs for all $\tau$ iff $\alpha=0$.
This completes the proof when $w\theta$ has outer type.


We can explicitly describe all cases when $w\theta$ has outer type.
The outer type with representative $\dotw = 1$ includes all cases
where $\hat G_{sc}$ is adjoint: $G_2$, $F_4$, and $E_8$.

We claim that every case such that $\theta$ is not the identity and
such that $\hat G$ has Dynkin diagram $A_{n-1}$ or $E_6$ has outer type.

We consider groups of type ${}^2A_{n-1}$.  That is, we consider $\hat
G = \op{SL}(n,\ring{C})$ and an outer automorphism $\theta$ that
preserves a pinning.  We claim that every $w\theta$ has outer type.
The extended Dynkin diagram is a loop with $n$ nodes.  The
automorphism $\theta$ acts as a reflection that fixes the extended
node of the diagram.  The automorphism $w$ acts as a rotation of the
diagram.  Then $w \theta$ is also a reflection of the diagram.  There
are two cases, depending on whether $w\theta$ fixes a node.  If it
fixes a node, then we may assume without loss of generality that the
fixed node is the extended node.  Then $w\theta = \theta$.  If
$w\theta$ does not fix a node, then $n$ is even and the automorphism
acts as a reflection of a regular $n=2k$-gon through the center of two
opposite edges.  Up to conjugacy, this automorphism is represented as
$w\theta$, where $w $ acts as a cyclic permutation $w (t) =
\op{diag}(t_2,t_3,\ldots,t_n,t_1)$, and $\theta(t) =
\op{diag}(t_n^{-1},\ldots,t_1^{-1})$, where
$t=\op{diag}(t_1,\ldots,t_n)$.  We find that $w \theta$ is
$W$-conjugate to $\theta$, by an element $w_1$ such that $w_1(t) =
\op{diag}(t_1,\ldots,t_k,\ t_n,t_{n-1},\ldots,t_{k+1})$. Thus
$w\theta$ has outer type.

In the remainder of the proof we assume that $w\theta$ does not have
outer type.  In particular, if $\theta$ is not the identity, then the
group $\hat G$ has type $D_n$ and $\theta$ acts as an involution on
the Dynkin diagram.  In this case, we can take $\hat G = \op{SO}(2n)$, and
we realize $\theta$ as an element of $\op{O}(2n)$.  Excluding outer type,
we assume that $w\theta$ is not of the form $w_1\theta w_1^{-1}$.  In
all cases $W\rtimes \ang{\theta}$ is a Coxeter group.

Among all Levi subgroups containing $\hat T$ of $\theta$-stable
parabolic subgroups of $\hat G$, we pick on that is minimal in the
sense that
\[
w\theta(\hat M) = \hat M,\quad w\in W(\hat T,\hat M),\quad X^*(\hat T_M)^{w\theta}=0,
\]
where $\hat T_M = \hat T\cap \hat M_{der}$.  This is an ellipticity
condition on $w\theta$ with respect to the Levi $\hat M$.
\XX{double check this is
  possible.}  Write $\hat T = \hat A\hat T_M$, where $\hat A = Z(\hat M)^0$.

The tori $\hat T_M$ and $\hat A$ have the following properties.  The
subgroup $\hat T_M^{w\theta}$ is finite.  We have $(1-w\theta)\hat T_M
= \hat T_M$ (\cite[Theorem 10.1]{steinberg1968endomorphisms}).  The
maps $\hat T_M^{\theta,0} \to \hat T_M/(1-\theta)\hat T_M$ and $\hat
A^{\theta,0}\to \hat A/(1-\theta)\hat A$ are isogenies.  A root $\alpha$
restricts to zero on $\hat A^{\theta,0}$ iff it restricts to zero on $\hat A$.

We set 
\[
\hat U= \hat \hat A/(1-\theta)\hat A = \hat A/(1-w\theta)\hat A.
\]
We have 
\[
\hat T_1 = \hat A \hat T_M/((1-\theta)\hat A, (1-w\theta) \hat T_M
   = \hat A/((1-\theta)\hat A,\hat A\cap \hat T_M).
\]
We have an isogeny $\iota:\hat U\to\hat T_1$ induced by the natural map
\[
\hat A \mapsto  \hat A/((1-\theta)\hat A,\hat A\cap \hat T_M).
\]
We have a morphism $\phi:\hat U\to \hat S$ induced by the inclusion $\hat A\subseteq\hat T$
and
\[
\hat A/(1-\theta)\hat A \to \hat T/(1-\theta)\hat T = \hat S.
\]
We pick any Borel subgroup $\hat B(w\theta)$ such that $\hat
T\subseteq \hat B(w\theta) \subseteq \hat P$.

We claim that $\Psi^{++}:=\Psi^+_{w\theta}(\hat T,\hat B(w\theta))$ is the
set of roots $\Psi^+(\hat T,\hat B(w\theta))$ that are not roots of $\hat M$.
In fact, if $\alpha$ is a root of $\hat M$, then
\[
N_1 \alpha\in X^*(\hat T_M)^{w\theta}= 0,
\]
so $N_1\alpha=0$ and $\alpha\not\in\Psi^{++}$.  If $\alpha$ is not a root of
$\hat M$, then $\theta\alpha$ and $(w\theta)(\alpha)$ are also positive,
and are also not roots of $\hat M$.  Thus, $N_1\alpha$ is a sum of positive roots,
hence positive.  In particular $N_1\alpha\ne0$, and $\alpha\in \Psi^{++}$.
This proves the claim.

We let $\hat B_1 = \hat B(w\theta)$.  We claim that 
$\Psi_{\phi,\theta}^+(\hat T,\hat B_1) = \Psi^{++}$.
Using the surjective isogeny $\hat A^{\theta,0}\to \hat A/(1-\theta)\hat A= \hat U$, we
can test whether $\phi^* N\alpha$ is zero by evaluating on $\hat A^{\theta,0}$.
That is, using the properties of $\hat A$ given above:
\[
\phi^* N\alpha = 0 \ \Leftrightarrow \ 
N\alpha|_{\hat A^{\theta,0}}=0 \ \Leftrightarrow \ 
k\alpha|_{\hat A^{\theta,0}}=0 \ \Leftrightarrow \ 
\alpha|_{\hat A}=0.
\]
Finally, $\alpha|_{\hat A} = 0$ iff $\alpha$ is a root of $\hat M$.  This proves the claim.

We choose $\dotw\in \hat M_{der}$ to be any lift of $w$.  We note that
the lift is unique up to $\theta$-conjugacy.  If $t\dotw\in \hat
M_{der}$ is any other lift with $t\in \hat T_M$, then by the
properties of $\hat T_M$ stated above, $t = (1-\dotw\theta) (u)$,
and $t\dotw\theta = u\dotw\theta u^{-1}$ is conjugate to $\dotw\theta$.

We choose $m\in \hat M_{der}$ such that $m^{-1} \dotw\theta m = \epsilon
\theta$, where $\epsilon \in \hat T_M$.  By the properties of $\hat
T_M$ stated above, $\hat T_M = \hat T_M^{\theta,0} ((1-\theta)\hat
T_M)$.  Adjusting $m$ by an element of $\hat T_M$, we may assume that
$\epsilon\in \hat T_M^{\theta,0}$.  We use the same notation
$\epsilon$ for its image in $\hat S$ via $\hat T_M^{\theta,0}\subseteq
\hat T \to \hat S$.

For any $\uu\in \hat U = \hat A/(1-\theta)\hat A$, we let $a\in \hat A$ be a
preimage.  Note that $a\in Z(\hat M)$ and $h\in \hat M$ commute.  We
are ready to prove property (1-conjugacy) of the proposition.  The
elements $\tau\dotw\theta$ and $\epsilon\phi(\uu)\theta$ are conjugate
iff $a\dotw\theta$ and $a\epsilon \theta$ are conjugate.  By
construction, the element $h$ conjugates one to the other.

We claim that property (2-regularity) of the proposition holds.  As
shown above, if $\alpha$ is not a root of $\hat M$, then
$\phi^*N\alpha\ne 0$, so the regularity properties holds for such
$\alpha$.  If $\alpha$ is a root of $\hat M$, it is enough to show
that $N\alpha(\epsilon)\ne0$.  This we can do on a case-by-case basis.
The typical case is $\theta=1$, $N\alpha = \alpha$, and the
calculation reduces to individual factors of $\hat M_{sc}$, which are
typically $\op{SL}(k,\ring{C})$ for some $k$. The elliptic condition forces
$w$ to be the Coxeter element, and the eigenvalues of $\dotw$ and
$\epsilon$ are distinct roots of unity.  A slight variant of this
argument, which we leave to the reader, works when $\theta$ is
nontrivial in the group $\op{O}(2n)$.

Finally, we claim that property (3-partition) of the proposition
holds.  Set $\g_{++}=\g_{\Psi^{++}}$.
We have an isomorphism $\psi:\g_{++}\to \g_{++}$ given by
$X\mapsto \op{Ad}(h)(X)$.  This leads to an equality of determinants for
all $\uu\in \hat U$:
\begin{align*}
\phi^*_\epsilon D(\hat G,\Psi^{++},\theta,E,q) (u) &=
\det(1- \epsilon \theta a q;\g_{++}) \\ &=
\det(1-\psi(\epsilon\theta a) q;\g_{++}) \\ &=
\det(1-\dotw \theta a q;\g_{++}) \\ &=
\iota^* D(\hat G,\Psi^{++},\dotw\theta,E,q)(u).
\end{align*}
This completes the proof of the proposition.
\end{proof}


\subsection{branching rules}\label{sec:branch}

\subsection{moved from H}


A Weyl group element that acts on the extended Dynkin diagram arises
in the following context.  Let $G$ be an unramified $p$-adic reductive
group, and let $H$ be an unramified endoscopic group of $G$.  We
assume that we are given an embedding
\[
\xi:{}^LH\to {}^LG,
\]
that factors through a finite unramified extension of $F$:
\[
\xi:\hat H\rtimes \ang{\theta_H}\to \hat G\rtimes \ang{\theta},
\]
such that $\xi(\theta_H) = \dotw \rtimes \theta,$ for some
representative $\dotw $ of an element $w$ in the Weyl group $W_G$.  It
is known that the element $w$ can be chosen 
to act as an automorphism of the extended Dynkin diagram,
up to an equivalence of endoscopic data
\cite[\S4.7]{hales1993simple}.

From the description of endoscopic data, we may assume that $\hat H =
C_{\hat G}(s)^0$ for some $s\in \hat T$, and that $\xi(h) = h$, for $h
\in \hat H$, with this identification.  We may assume $\hat T = \hat
T_G = \hat T_H$ using this identification of $\hat H$ with a subgroup
of $\hat G$.  In what follows all $L$-morphisms $\xi$ are assumed
to have this form.

Returning to our discussion of endoscopic groups,
since $\hat H = C_{\hat G}(s)^0$ for some $s\in \hat T$, the root system $\Psi_H$
of $\hat H$
with respect to $\hat T$ is a subset of $\Psi$.

\begin{lemma} In this context,  if $\alpha\in \Psi$ and  $N_1\alpha=0$, then
$\alpha$ is not in the root system of $\hat H$.
\end{lemma}

\begin{proof} We prove the contrapositive.  Assume that $\alpha\in\Psi_H$.
Pick a Borel subgroup $\hat B_H\supseteq \hat T$ of $\hat H$ that
is $\theta_1$-stable.  Replace $\alpha$ by $-\alpha$ if necessary so that 
$\alpha\in\Psi^+(\hat T,\hat B_H)$.  Then $N_1\alpha$ is a sum of positive roots,
hence positive.  Thus, $N_1\alpha$ is nonzero.
\end{proof}

If $\hat B(\theta_1)$ is a $\theta_1$-adapted Borel subgroup of $\hat G$,
then we can define a positive root system for $\hat H$ by
$\Psi^+(\hat T,\hat B(\theta_1))\cap \Psi_H$.  We say that such a system of positive
roots for $\hat H$ is $\theta_1$-adapted.  By the two previous lemmas,
if $\Psi^+_H$ is $\theta_1$-adapted, then $\theta_1$ preserves $\Psi^+_H$.

We can use this construction to define an {\it endoscopic} partition function as follows.
Let ${}^LH$ be an endoscopic group
as above, with $\theta_1 = \dotw \theta$.
Let $\hat B(\theta_1)$ and $\Psi^+_H$ be $\theta_1$-adapted.  
We have a disjoint sum
\begin{equation}\label{eqn:disj-b1}
\Psi^+(\hat T,\hat B(\theta_1)) = \Psi^+_H \sqcup (\text{norm }  0) \sqcup M_\xi,
\end{equation}
where $(\text{norm } 0)$ is the set of $\hat B(\theta_1)$-positive roots $\alpha$ such that $N_1\alpha=0$,
and $M_\xi$ is the set of positive roots with nonzero $N_1$-norm that are not roots
of $\hat H$.
We define the endoscopic partition function to be
\begin{equation}\label{eqn:endo-partition}
P(\hat G,M_\xi,\dotw\theta,E,q).
\end{equation}
As we will see, the branching rule for the subgroup $\xi({}^LH)\subseteq {}^LG$ is
given in terms of this partition function.


\XX{stray}

Here
$\dotw\in N_{\hat G}(\hat T)$ over $w\in W$ gives
$\theta_1=\dotw\theta$ determining the $L$-morphism ${}^LH\to {}^LG$
as described above.  

The next propositon gives a concrete representation of the image under
$\xi$ of a $\theta_H$-conjugacy class in ${}^LH$.  

Let $\xi:{}^LH\to {}^LG$ be an embedding of
  $L$-groups that factors over a finite unramifed extension $E/F$.

\subsection{new}



The irreducible representations $\tau_\lambda$ of ${}^LG$ restricted
to $\hat G\rtimes\theta$ are classified by a highest weight
$\lambda\in P^+_G\subseteq Y^*_G$, and similarly for irreducible
representations $\sigma_\mu$ on $\hat H\rtimes \theta_H$, with $\mu\in
P^+_H\subseteq X^*(\hat T_1)$.
This section gives a branching rule for $\tau_\lambda$ restricted to
$\xi(\hat H\rtimes\theta_H)$, as a sum of $\sigma_\mu$:
\[
\tau_\lambda| = \sum_\mu m(\lambda,\mu) \sigma_\mu
\]
for some coefficients $m(\lambda,\mu)$.  

If $\sigma_\mu$ is an irreducible character and
$\chi:\ang{\theta_H}\to \ring{C}^\times$ is a multiplicative
character, then $ \chi\otimes\sigma_\mu$ is again an irreducible
character.  Restricted to $\hat H\rtimes\theta_H$, the characters
$\chi\otimes\sigma_\mu$ and $\sigma_\mu$ are linearly dependent:
$\chi\otimes\sigma_\mu = \chi(\theta_H) \sigma_\mu $.  This
means that the multiplicities $m(\lambda,\mu)$ should take values in
$\ring{Z}[\zeta]$, where $\zeta$ is a primitive root of unity of the
same order as $\theta_H$.

We fix data $(\hat U,\hat B(w\theta),\hat B_1,\iota,\phi,\epsilon,\dotw)$ associated with
$\xi:{}^LH\to{}^LG$ as in Proposition \ref{lemma:ephi}.  That
construction is based on a choice of $\theta_1$-adapted Borel subgroup
$\hat B(\theta_1)$.  We have constructed a $\theta_1$-adapted set
$\Psi^+_H$ of positive roots of $\hat H$.  We expand the endoscopic
partition function of Equation \ref{eqn:endo-partition} (or rather its
pullback to $\hat U$) in a series
\begin{equation}
\iota^* P(\hat G,M_\xi,\dotw\theta,E,1) = \sum_{\mu} p_\mu e^\mu,
\end{equation}
where the support of $\mu\mapsto p_\mu$ is a subset of $X^*(\hat U)$.  We have a
disjoint sum decomposition 
\[
\Psi^+(\hat T,\hat B_1) = \Psi_{\phi,\theta}(\hat T,\hat B_1)\sqcup M_0(\theta),
\]
where $\Psi_{\phi,\theta}(\hat T,\hat B_1)$ is the set of Proposition \ref{lemma:ephi} and
\[
M_0(\theta) = \{\alpha\in \Psi^+(\hat T,\hat B_1)\mid \phi^* N\alpha=0\}.
\]
Using the determinant identity of 
Proposition \ref{lemma:ephi}, this gives a product decomposition
\begin{equation}
\phi^*_\epsilon D(\hat G,\Psi^+(\hat T,\hat B_1),\theta,E,1) = 
\iota^* D(\hat G,\Psi_{w\theta}^+(\hat T,\hat B(\theta_1)),\theta_1,E,1) \ \ 
\phi^*_\epsilon D(\hat G,M_0(\theta),\theta,E,1).
\end{equation}
The condition $\phi^* N\alpha=0$ implies that 
the second factor $\phi^*_\epsilon D(\hat G,M_0(\theta),\theta,E,1)$
is a constant $d_0(\epsilon,\theta)\in\ring{C}$ (that is, it is
independent of $\mu\in X^*(\hat U)$.  Regularity implies that 
the constant is nonzero.  The constant is  a routine computation, but we  do not do so here.
We abbreviate
\begin{align*}
D_H = \iota^* D(\hat H,\Psi^+_H,\theta_1,E,1) = \iota^* D(\hat G,\Psi^+_H,\theta_1,E,1).
\end{align*}
This is the denominator in the twisted Weyl character formula (on
$X^*(\hat U)$) for $(\hat H,\theta_1)$
with respect to the postive root system $\Psi^+_H$.
Combining these identities, we have
\begin{align}\label{eqn:DHDG}
\begin{split}
D_H &= i^* D(\hat H,\Psi^+_H,\dotw\theta,E,1)\\
&=\frac{i^*D(\hat G,\Psi_{w\theta}^+(\hat T,\hat B(\theta_1)),\dotw\theta,E,1)}
{i^*D(\hat G,M_\xi,\dotw\theta,E,1)}\\
&=
{i^*P(\hat G,M_\xi,\dotw\theta,E,1)}
\phi^*_\epsilon D(\hat G,\Psi_{\phi,\theta}(\hat T,\hat B_1),\theta,E,1)\\
&=
{i^*P(\hat G,M_\xi,\dotw\theta,E,1)}
\frac{\phi^*_\epsilon D(\hat G,\Psi^+(\hat T,\hat B_1),\theta,E,1)}
{\phi^*_\epsilon D(\hat G,M_0(\theta),\theta,E,1)}\\
&=
(\sum_{\mu} p_\mu e^\mu) 
\ \frac{\phi^*_\epsilon D_G}{
d_0(\epsilon,\theta)},
\end{split}
\end{align}
with abbreviation $D_G= D(\hat G,\Psi^+(\hat T,\hat B_1),\theta,E,1)$ for
the twisted Weyl denominator for $(\hat G,\theta)$ with respect to the positive
root system $\Psi^+(\hat T,\hat B_1)$.


Define constants 
\begin{equation}\label{eqn:branch}
m(\lambda,\mu) = \sum_{w\in W^\theta} 
%, ~\phi^*({w\bullet\lambda})\in  X^*(\hat T_1)} 
(-1)^{\ell w} ({w\bullet\lambda})(\epsilon)
\frac{p_{\mu-\phi^*(w\bullet\lambda)}}{d_0(\epsilon,\theta)} \in \ring{Q}(\zeta).
\end{equation}

The following theorem is the main result of this section.

\begin{theorem}\label{thm:branch}
  Let $G$ be a reductive group and let $H$ be an endoscopic group of
  $G$, both unramified.  Let $\xi:{}^LH\to {}^LG$ be an embedding of
  $L$-groups that factors over a finite unramifed extension $E/F$.
  Suppose that $\xi(\theta_H) = \dotw\theta$.  Let $\dotw\mapsto w\in W$.
  Let $(\hat U,\ldots,\dotw)$ be the data constructed by
  Proposition \ref{lemma:ephi} (with the same $\dotw$).  
  Then Equation \ref{eqn:branch} gives
  the twisted branching rule for $\hat G\rtimes \theta$ restricted to
  $\xi(\hat H\rtimes \theta_H)$:
\[
\phi^*_\epsilon\tau_\lambda = \sum_\mu m(\lambda,\mu) \sigma_\mu.
\]
\end{theorem}

Before starting the proof of the theorem, we give a transformation rule
describing how the branching
rules depend on the choice $\dotw\mapsto w$ 
used to define the embedding $\xi$ of $L$-groups.  


\begin{lemma}\label{lemma:transform}
Suppose that we have two embeddings $\xi_i:{}^L\to {}^LG$ with
$\xi_1(\hat H) =\xi_2(\hat H)$, $\xi_1(\hat T) = \xi_2(\hat T) = \hat T$, 
$\xi_i(\theta_H) = \dotw_i\theta$, and $\dotw_2 = t\dotw_1$.
Write $m_i(\lambda,\mu)$ for the multiplicity formulas for $\xi_i$.
Then $m_1(\lambda,\mu) = \mu_2(\lambda,\mu)\mu(t)$.
\end{lemma}

We note that the image $\xi_i({}^LH)$ does not not depend on 
$i$, but the multiplicity formula does.

\begin{proof}  
Let $V_\lambda$ be the representation of $G\rtimes \ang{\theta}$ with
highest weight $\lambda$, normalized as usual by the condition that $\theta v=v$,
when $v$ is a vector of highest weight.

Let $W$ be a $\hat H$-irreducible subrepresentation with highest
weight $\mu$.  By the condition $\xi_1(\hat H) =\xi_2(\hat H)$, the
two module structures on $W$ agree.  Assume that $\mu$ is
$\theta_H$-fixed.  We extend $W$ to ${}^LH$ by requiring $\theta_H v =
v$, where $v$ is a vector of highest weight.  The two
different normalizations
\[
\theta_H v = \xi_i(\theta_H) v = \dotw_i \theta v =v,
\]
for $i=1,2$, 
differ by a scalar $\mu(t)$.  
Hence the multiplicities are also affected by a factor $\mu(t)$.
\end{proof}

In general, the $L$-group can be formed with respect to various
unramified Galois extensions.
We let $L/F$ be a second unramified extension with $L/E/F$.  Let
$[L:E]=\ell$.  We show that the  branching multiplicities on
do not depend on $L$.

Fix an admissible embedding
\[
\xi_L:\hat H \rtimes \op{Gal}(L/F)\to \hat G \rtimes \op{Gal}(L/F),
\]
where $\xi_L(\Frob_L) = \dotw \Frob_L$, with the same choice $\dotw $
as with $\xi = \xi_E$.  Then $\Frob_L^\ell$ acts trivially on the
datum of $\hat H$, and $(\dotw \Frob_L)^\ell$ acts trivially on the
datum of $\hat G$.  Let $\tau_\lambda$ be an irreducible
representation of $\hat G$ that is $\theta$-fixed.  The extension of
$\tau_\lambda$ to $\hat G\rtimes \op{Gal}(L/F)$ factors through $\hat
G\rtimes \op{Gal}(E/F)$.  Similarly, $\sigma_\mu$ extends to $\hat
H\rtimes \op{Gal}(L/F)$ and factors through $\hat
H\rtimes\op{Gal}(E/F)$.  We conclude that the branching multiplicities
are the same for $L/F$ and
\[
\xi_E(\hat H \rtimes \Frob_E) 
= \xi_L(\hat H\rtimes \Frob_L)/(\dotw \Frob_L)^\ell 
\subset (\hat G\rtimes \Frob_L)/( \Frob_L)^\ell 
= \hat G\rtimes \Frob_E.
\]
The multiplicity formula is independent of the choice of $L/F$.

\begin{proof}
  We extend Kostant's formula for branching multiplicities
  $m(\lambda,\mu)$ to this setting, following Goodman and Wallach
  \cite[\S8.2.2]{goodman}.  Recall that this formula for
  $m(\lambda,\mu)$ is based on the (twisted) Weyl character formula.

  We show that the properties of $\phi,\epsilon$ imply the branching
  rule, which we compute using Equation \ref{eqn:DHDG} and the twisted
  Weyl character formula on $\hat H$ and $\hat G$.  The conjugacy
  property of Proposition \ref{lemma:ephi} implies that
  $\phi_\epsilon^*\tau_\lambda = \iota^*\tau_\lambda$ on $\hat U$.  We
  have
\begin{align*}
(\phi^*_\epsilon\tau_\lambda) D_H 
 &= (\iota^*\tau_\lambda) D_H\\
 &= \sum_{\mu'} m(\lambda,{\mu'}) J_H(e^{\mu'})\\
  &= m(\lambda,\mu)e^\mu + \sum_{\mu'\ne\mu} c_{\mu'} e^{\mu'}.\\
(\phi^*_\epsilon\tau_\lambda) D_H 
  &= (\sum p_{\mu'} e^{\mu'})(\phi^*_\epsilon(\tau_\lambda D_{G})) /d_0\\
  &= (\sum p_{\mu'} e^{\mu'}) \phi^*_\epsilon(J_G(e^\lambda)) /d_0\\
  &= \sum_{\mu'} \sum_{w\in W^\theta} (-1)^{\ell w} 
  (p_{\mu'} e^{\mu'}) (\phi^*_\epsilon (e^{w\bullet \lambda})) /d_0\\
  &= \sum_{\mu'} \sum_{w\in W^\theta} (-1)^{\ell w}  
 ({w\bullet\lambda})(\epsilon) p_{\mu'}
e^{\mu'+\phi^*(w\bullet \lambda)} /d_0\\
  &= \sum_{\mu'} \sum_{w\in W^\theta} 
 % ~\text{s.t. }\phi^*({w\bullet\lambda})\in X^*(\hat U)} 
(-1)^{\ell w} ({w\bullet\lambda})(\epsilon) 
 p_{\mu' - \phi^*({w\bullet \lambda})} e^{\mu'} /d_0.
\end{align*}
We have used the twisted Weyl character formula with respect to $\Psi^+_H$ on $\hat H$
and with respect to $\Psi^+(\hat T,\hat B_1)$  on $\hat G$.
To justify the equation in the third row, let $\mu\in P_H^+$.  If
$w'\bullet \mu' = w\bullet \mu$ for some $w,w'\in W_H$ and $\mu'\in
P_H^+$, then using the fact that $P_H^+$ is a fundamental domain for
$W_H$ and that $\mu'+\rho_H$ lies in the interior of that domain, we
find that $w=w'$ and $\mu=\mu'$.

Equating coefficients of $e^\mu$, we get Equation \ref{eqn:branch}.
This completes the proof.
\end{proof}



\section{Motivic Integration}

This section reviews the theory of motivic integration as developed by
Cluckers and Loeser~\cite{cluckers2008constructible}.

\subsection{the Denef-Pas language}

The Denef-Pas language is a three-sorted first-order formal language
in the sense of model theory.  Its intended structures are triples
$(F,k_F,\ring{Z})$, where $F$ is a valued field with discrete
valuation, $k_F$ is the residue field of $F$, and the value group of
$F$ is the ring of integers $\ring{Z}$ .  The three sorts are $VF$
(the valued-field sort), $RF$ (the residue-field sort), and $\ring{Z}$
(the value-group sort).

In general, a first-order formal language is specified by sets of
relation symbols and function symbols.  The Denef-Pas language has the
following relation and function symbols.  The valued-field sort $VF$
has the symbols of the first-order language of rings $(0,1,+,\times)$.
The residue field sort also has the symbols of the first-order
language of rings.  The value-group sort is the Presburger language of
an ordered additive group with symbols $(0,+,\le,\equiv_n)$.  Here
$(\equiv_n)$ is a binary relation symbol for each $n\ge 2$, which is
to be interpreted as congruence modulo $n$ in $\ring{Z}$.  In
addition, there are two function symbols $\op{ord}:VF\to\ring{Z}$
(interpreted as the valuation on the valued-field) and $\op{ac}:VF\to
RF$ (interpreted as the angular component map).  For the structure
$(K((t)),K,\ring{Z})$, where $K((t))$ is the field of formal Laurent
series, the intended interpretation of $\op{ac}$ is the function
$\sum_{i\ge N} a_i t^i\mapsto a_N$ that returns the first nonzero
coefficient of the Laurent series (and sending $0\in K((t))$ to $0$).

First-order languages are constructed in the usual way, with formulas
built from logical connectives $(\land)$, $(\to)$, $(\lor)$, $\neg$,
equality $(=)$, variables of the three sorts, function symbols,
relation symbols, existential quantifiers of each sort, and universal
quantifiers of each sort.

Following the terminology of \cite{gordon}, we call a {\it fixed
  choice} any set-theoretic data that does not depend in any way on
the Denef-Pas language, its variables, nor on the structures of $VF$
and $RF$.  Examples of fixed-choices that appear in this paper are
Weyl groups, abstract groups, representations of split reductive
groups over $\ring{Q}$, and root systems.

\subsection{motivic integration}

Let $\op{Field}_\Q$ be the category of fields of characteristic zero.

Cluckers and Loeser have used the Denef-Pas language to define various
categories.  In particular, there is a category $\op{Def}_\Q$ of {\it
  definable subassignments}, given as follows.  For each
$(m,n,r)\in\ring{N}^3$, let $h[m,n,r]$ be the functor from
$\op{Field}_\Q$ to the category of sets that assigns to each field
$K$, the set $h[m,n,r](K)=K((t))^m\times K^n\times \ring{Z}^r$.  A
{\it subassignment} of this functor is by definition, a subset $S(K)
\subseteq h[m,n,r](K)$ for each $K\in\op{Field}_\Q$.  A definable
subassignment $S$ is a subassignment for which there exists a formula
$\phi$ in the Denef-Pas language such that for each
$K\in\op{Field}_\Q$, the set of solutions of $\phi$ in $h[m,n,r](K)$
is $S(K)$.  The definable subassignments are the objects of the
category $\op{Def}_\Q$.  A morphism $\phi:X\to Y$ is a definable
subassignment
\[
\phi\subseteq X\times Y
\subseteq h[m,n,r]\times h[m',n',r'] = h[m+m',n+n',r+r']
\]
that is the graph of a function $X(K)\to Y(K)$ for each $K\in
\op{Field}_\Q$.

A {\it free parameter} refers to a collection of free variables of the
same sort in a formula in the Denef-Pas language, ranging over a
definable subassignment.  A bound parameter is similar, except that
the variables are all bound by a contiguous block of existential or a
contiguous block of universal quantifiers.

For each definable subassignment $X\in \op{Def}_\Q$, Cluckers and
Loeser have defined a ring $C(X)$ of {\it constructible motivic
  functions}.  The construction of this ring is a major undertaking,
and we refer the reader to their articles for details.  The elements
of this ring are called constructible motivic functions.  Although
they behave in many ways as functions on $X$, the elements of the ring
are not literal functions in the set-theoretic sense of function.

If $\phi:X\to Y$ is a morphism of definable subassignments, there is a
pullback of functions $\phi^*:C(Y)\to C(X)$.  The pullback $\phi^*$ is
a ring homomorphism, and pullbacks compose: $(\phi\psi)^* = \psi^*
\phi^*$.

If $X\to S$ is a morphism of definable subassignments, there is a
subgroup $I_S C(X)$ of $S$-integrable constructible motivic functions.
The intuitive interpretation of an $S$-integrable function $f$ is a
function such that the integral over each fiber of $X\to S$ is
convergent with respect to the canonical motivic measure.  For a
morphism $\phi: X\to Y$ over $S$, there is a pushforward
$\phi_!:I_SC(X)\to I_SC(Y)$ that is called {\it integration over
  fibers}.  Pushforwards compose: $(\phi\psi)_! = \phi_!\psi_!$.  In
this article, we always deal with bounded constructible functions.
Such functions are always integrable
\cite[Prop~12.2.2]{cluckers2008constructible}.  Thus, we do not need
to deal with integrability issues.

\subsection{Presburger constructible functions}

The ring $C(X)$ of constructible functions is 
the graded algebra associated with a filtration on a tensor product $P(X) \otimes
Q(X)$.   In terms of the
three sorts of the Denef-Pas language, data related to the value-group
sort $\ring{Z}$ is encoded in $P(X)$ and data related to the residue
field sort $RF$ is encoded in $Q(X)$.  The left-hand side $P(X)$ is a
ring of {\it Presburger constructible functions.}  Every Presburger
constructible function $f$ gives a constructible motivic function
$f\otimes 1$.

Much of what we do in this article is related to constructible
functions on integer lattices.  For this, we work with Presburger
constructible functions rather than the entire ring of constructible
motivic functions.

\subsection{volume forms}

Cluckers and Loeser have an extension of motivic integration that
allows integration with respect to volume forms
\cite[\S8]{cluckers2008constructible}.  In brief, there is a notion of
differential forms on a definable subassignment and a space of
definable positive volume forms.  Each differential form $\omega$ of
top degree has an associated volume form $|\omega|$.  For each
morphism $\phi:X\to Y$ over $S$, the pushforward $\phi_!$ extends to a
pushforward $f \mapsto \phi_!(f,\omega)$ with respect to the volume
form.  It is to be interpreted loosely as integration over the fibers
of $\phi:X\to Y$ with respect to a volume form constructed from a
Leray residue of $\omega$ on the fiber.

\subsection{$p$-adic specialization}

Let $\C$ denote the class of $p$-adic fields.  Let $\C_N\subseteq \C$
denote the subclass of fields whose residue characteristic is at least
$p\ge N$.

In general, we only care about what occurs in fields in $\C_N$ for $N$
arbitrarily large.  To make this precise, suppose that we have for
some $N$, a function $X$ with domain $\C_N$.  Then by restriction of
domain $\C_i$ to $\C_{j}$, for $N\le i\le j$, we may take the filtered
colimit of $X_i=X|_{\C_i}$.  Two functions $X$, $X'$ have the same
filtered colimit if they are equal in $\C_i$ for some sufficiently
large $i$.

Let $X$ be a definable subassignment of $h[m,n,r]$, and let $f$ be a
constructible motivic function on $X$.  There exists an $N$ such that
for all $F\in \C_N$, there are specializations
\[
X(F)\subseteq F^m\times k_F^n\times \ring{Z}^r,  \quad f_F: X(F) \to\ring{C},
\]
To us, only the  filtered colimits of $X$ and $f$ matter.

We warn the reader of a notational overload; we write $X(K)$ or $X(F)$
as $K$ and $F$ range over two quite different classes of fields.
Different symbols $K$ and $F$ disambiguate the context.  When $K\in
\op{Field}_\Q$, the valued field is $K((t))$ and the residue field is
$K$; but when $F$ is a $p$-adic field, $F$ is the valued field and its
residue field is denoted $k_F$.  We also warn that $K$ is used both for
a hyperspecial subgroup and for $K\in\op{Field}_\Q$.

The specializations have various expected properties.  If $\phi:X\to
Y$ is a morphism of definable subassignments, then we have functions
$\phi_F:X(F)\to Y(F)$.  When $f$ is $S$-integrable on $X$, integration
$\phi_!(f)$ over fibers specializes to integration over fibers with
respect to a canonical measure in $p$-adic fields $F\in \C_N$ (for
some $N$ depending on $\phi$).

The functions $f_F:X(F)\to\ring{C}$ that come from constructible
motivic functions $f\in C(X)$ have a special form
\begin{equation}\label{eqn:q}
f_F(x) = \sum_i \card(Y_i(F,x)) q_F^{\alpha_{i,F}(x)} 
\prod_j \beta_{i,j,F}(x)\prod_k \frac{1}{1-q_F^{a_{i,k}}},
\end{equation}
where all sums and products are finite, $\alpha_{i}:X\to\ring{Z}$,
$\beta_{ij}:X\to\ring{Z}$ are definable, $q_F$ is the cardinality of
the residue field of $F$, and $a_{i,k}$ are nonzero integers
\cite[\S2]{cluckers2011btransfer}.  The filtered colimits of these
functions are {\it $q$-constructible functions}.  Let $C_q(X)$ be the
space of $q$-constructible functions on $X$.  Sometimes we call the
specialization of a definable subassignment a definable set.  There is
an element $\ring{L}$, called the Lefschetz motive, in the ring of
constructible motivic functions that specializes to $q_F$ for every
$p$-adic field $F$.  When the first factors $Y_i$ are absent from
Equation \ref{eqn:q}, we say the function $f$ is Presburger
constructible.

We warn the reader that very different constructible motivic functions
can yield the same $q$-constructible function.  For example, let
$[S]\in C(\op{pt})$ be the isomorphism class in the residue sort of
the set of nonzero squares, considered as a constructible motivic
functions on a point.  Similarly, let $[N]$ be the class of the set of
nonsquares.  Then, under specialization to $p$-adic fields, the two
functions are equal: $[S](F) = [N](F) = (q_F-1)/2$, for
$F\in\C_1$. However, $[S]$ and $[N]$ are not at all the same
constructible motivic function. Indeed, their values on algebraically
closed residue fields $K$ are not equal: $[N](K)$ is the emptyset and
$[S](K) = K^\times$ is not.  Another family of examples is provided by
isogenous elliptic curves.  They have the same number of points in a
finite field, but they are not generally isomorphic curves.  If a
constructible motivic function specializes to a $q$-constructible
function that is identically zero, then we call it a {\it null function}.

The theory of motivic integration specializes to $q$-constructible
functions. To integrate a $q$-constructible function $f$, we lift it
to a contructible motivic function, use Cluckers-Loeser integration
there, then take its specialization again.  Two different lifts differ
by a constructible motivic function whose integral specializes to
zero. Thus, this is well-defined.

\subsection{definable reductive groups}

Definable reductive groups are understood in the sense of
\cite{cluckers2011transfer}, \cite{gordon}.  In this work we restrict
to unramified reductive groups (quasi-split and split over an
unramified extension).

In the definable context, a reductive group $G\to Z$ lies over a
definable subassignment $Z$ called the {\it cocycle space} of $G$.  In
the case of an unramified reductive group that splits over an
extension of degree $r$, we can take $Z\subseteq h[m,0,0]$.  The set
$Z$ parameterizes lists of coefficients of irreducible monic
polynomials, each defining a degree $r$ unramified extension of $F$.
A field extension $E/VF$ of degree $r$ is identified with $VF^r =
VF[x]/(p)$, as $p$ runs over irreducible polynomials parameterized by
$Z$.

Recall that there is no Frobenius map in the context of the Denef-Pas
language, because it is not possible to take a $q$th power.  Instead,
we choose a generator of the Galois group of an unramified extension
$E/VF$ and call it the quasi-Frobenius element.  As part of the
cocycle space data $Z$, we assume we are given a quasi-Frobenius
element $\op{qFrob}$ that corresponds to the automorphism $\theta$ of
$\hat G$.

A connected split reductive group is treated as a definable
subassignment through a faithful representation of the group.  The
group is identified with a closed subgroup of $\op{GL}(n,F)$.
Quasi-split reductive groups that split over an unramified degree $r$
extension (parameterized by a cocycle space $Z$) are defined in terms
of explicit representations of those groups in $\op{GL}(n,E)$, where
$E/VF$ is treated as above.

If $G$ is an unramified reductive group, we may construct a
hyperspecial subgroup $K$ as a definable subassignment of $G$.

A quasi-split reductive group $G$ carries an invariant differential
form $\omega$ of top degree, which is described in the context of
definable subassignments in \cite{gordon}.  All integration in this
article is assumed to be carried out with respect to invariant
measures.  We write, for example, $\vartheta_!^\inv(f) =
\vartheta_!(f,\omega)$ for the invariant integral of a constructible
integrable function $f\in C_q(G)$ with respect to the morphism
$\vartheta:G\to\{\op{pt}\}$ to a point using the invariant
differential form $\omega$.

\subsection{definability results}\label{sec:definability}

In this section we assume that $G$ is an unramified connected
reductive group.  It is treated as definable subassignment over a
definable cocycle space $Z$.

Standard subgroups of $G$ such as hyperspecial $K$, Borel subgroup
$B$, $T\subseteq B$, the unipotent radical $N$ of $B$, the maximal
split subtorus $A$ of $T$ are all definable.

\XX{insert proofs}

\begin{lemma}  
  Let $G$ be an unramified reductive group.  There exists a definable
  subassignment of $G\times G$ of all pairs $(\gamma,x)$ such that
  $\gamma$ is semisimple (possibly singular) and $x$ lies in the
  connected component of the centralizer of $\gamma$.
\end{lemma}

\begin{lemma} 
  Let $G$ be an unramified reductive group.  There exists a definable
  subassignement of $G\times G$ of all pairs $(\gamma,\gamma')$ such
  that $\gamma$ is semisimple (possibly singular) and $\gamma'$ is
  stably conjugate to $\gamma$.
\end{lemma}

\begin{lemma} 
  Let $G$ be an unramified reductive group, given as a definable
  subassignment over a cocycle space $Z$.  There is a definable
  subassignment $G^u$ of $G$ over $Z$ consisting of strongly regular
  semisimple elements $\gamma$ such that the connected component of
  the centralizer of $\gamma$ is unramified.
\end{lemma}

\begin{lemma} 
  Let $G$ be an unramified reductive group with unramifed endoscopic
  group $H$, given as a definable subassignments over a common cocycle
  space $Z$.  There is a definable subassignment $GH$ of all pairs
  $(\gamma,\gamma_H)$ such that $\gamma_H$ is strongly $G$-regular and
  $\gamma\in G^u$ is an image of $\gamma_H$.  Moreover, consider the
  Denef-Pas statement $\psi$ that asserts that for all strongly
  $G$-regular elements $\gamma_H$, there exists an image $\gamma\in
  G^u$ that is an image of $\gamma_H$.  Then there exists $N$ such
  that $\psi_F$ is true for all $F\in\C_N$.
\end{lemma}

\begin{lemma} 
  The set of topologically unipotent elements in a reductive group is
  a definable subassignement.  The set of strongly compact elements is
  a definable subassignment.
\end{lemma}

\begin{lemma} 
  Let $T$ be a torus defined over a cocycle space $Z$. Assume that $T$
  is given by twisting a split torus by some cocycle the Galois group
  of a splitting field $L/VF$.  Let $S\subset T$ be a maximal
  unramified subtorus of $T$.  Consider the Denef-Pas statement
  asserting that (for every $z$ and) for every strongly compact $t\in
  T$, there exists $s\in S$ and a topologically unipotent element
  $u\in T$ such that $t =s u$.  Then there exists $N$ such that the
  statement is true in $F$ for all $F\in \C_N$.
\end{lemma}

\begin{lemma}[topological Jordan decomposition] 
  Let $G$ be an unramified reductive group.  There is a definable
  subassignment of triples $(\gamma,\gamma_s,\gamma_u)\in G^3$ such
  that $\gamma$ is strongly regular semisimple and strongly compact,
  $\gamma = \gamma_s \gamma_u = \gamma_u\gamma_s$, $\gamma_u$ is
  topologically unipotent, and
\[
\alpha(\gamma_s)=1,
\quad\text{ or }
\quad \op{ord}(\alpha(\gamma_s)-1)=0,
\]
for all absolute roots $\alpha$ of the Cartan subgroup $C_G(\gamma)$.
\end{lemma}

\subsection{spherical Hecke algebra for an unramified definable group}

Let $G$ be a definable unramified reductive group over a cocycle space
$Z$.  Let $A$ be a maximal split torus in $G$ of dimension $r$.  We
identify its lattice of cocharacters $X_*(A)$ with $\ring{Z}^r$ by a
choice of free generators of $X_*(A)$.  This allows us to treat
$X_*(A)$ as the definable subassignement $h[0,0,r] = \ring{Z}^r$.  Let
$X^*(A)$ be the lattice of characters of $A$.

There is a perfect pairing $\langle\cdot,\cdot\rangle:X^*(A)\times
X_*(A) \to \ring{Z}$.  For each $\lambda\in X_*(A)$, there is a
definable subassignement $A_\lambda \subseteq A$ given by the formula
\[
\{ a \in A \mid \op{ord}(\mu(a)) 
= \ang{\mu,\lambda},\text{ for all } \mu\in X^*(A) \}.
\]
There is a definable subassignment of $X_*(A)\times A$ given by pairs
$(\lambda,a)$ such that $a\in A_\lambda$.  Of course, $p$-adically,
$A_\lambda$ is just the coset $\varpi^\lambda A(O_F)$, where $O_F$ is
the ring of integers of $F$.

Let $P^+\subseteq X_*(A)$ be the set of cocharacters in the positive
Weyl chamber.

\begin{lemma} 
  $P^+$ is a definable subset (of $\ring{Z}^r$).
\end{lemma}

\begin{proof} 
  $P^+$ is defined by linear inequalities, which can be expressed in
  the Presburger language.
\end{proof}

\begin{lemma}[Cartan decomposition] \label{lemma:cartan}
  There is a definable subassignment of $P^+\times G$ given by the
  formula
\[
L_G = \{(\lambda,g)\in P^+\times G \mid g \in K A_\lambda K \}.
\]
The fiber $L_G(\lambda)$ over each $\lambda\in P^+$ is definable.
Moreover, $L_G(\lambda)\cap L_G(\lambda') = \emptyset$, for
$\lambda\ne \lambda'$.
\end{lemma}

By Bruhat-Tits, the Cartan decomposition over general discrete valued
fields.

\begin{remark}   
  $L_G$ captures the entire spherical Hecke algebra as a single
  definable subassignment.  In applications to the fundamental lemma,
  it is important to work with this single subassignment rather than
  an infinite basis of the spherical Hecke algebra.
\end{remark}

We define the {\it spherical Hecke function} to be the characteristic
function of $L_G$, viewed as a $q$-constructible function on
$P^+\times G$.

Let $G$ be an unramified reductive group and let ${}^LG = \hat
G\rtimes \ang{\theta}$ be its Langlands dual, where $\theta$ acts on
$\hat G$ as the action of the Frobenius on the root datum, as
explained in Section \ref{sec:B}.  The groups $W$ and $\ang{\theta}$
both act on $X^*(\hat T)$.  Let $\hat T$ be a Cartan subgroup of $\hat
G$, with Weyl group $W$.

In the $p$-adic context, the Satake transform $f\mapsto \hat f$ is an
isomorphism $\H_{\ring{C}}(G,K)\to\ring{C}[Y^*]^{W^\theta}$.  Let
$s_{\lambda,\mu}$ be the coeficients of the change of basis $\hat
f_\lambda = \sum_\mu s_{\lambda,\mu} m_\mu$.

The Satake transform lifts to the $q$-constructible setting.  The
Satake transform involves a term $q^{\langle\rho^\vee,\mu\rangle}$,
where $\rho^\vee = \rho(\Psi^\vee)$.  Constructible functions in the
formula (\ref{eqn:q}) only contain integral powers of $q$.  However,
\cite[\S B.3.1]{cluckers2011local} extends the theory of constructible
functions to allow half-integers.  To accommodate the square roots
introduced by $\rho$, we extend the theory in that way without further
comment.\footnote{We may ask whether the difference $\rho_G - \rho_H$,
  for $G$ and $H$ an unramified endoscopic group, is always a sum of
  roots.}

\begin{lemma}\label{lemma:satake} 
  There is a $q$-constructible function $s$ on $P^+\times P^+$ that
  specializes to the function $(\lambda,\mu)\mapsto s_{\lambda,\mu}$,
\end{lemma}

\begin{proof} 
  The coefficients $s$ are given by a integral of a $q$-constructible
  function on $P^+\times G$:
\begin{equation}\label{eqn:s}
(\lambda,\mu)\mapsto s_{\lambda,\mu}
=\frac{q^{\langle\rho,\mu\rangle}}{\op{vol}(A_0)} 
\int_{A_\mu} \int_N L_G(\lambda,t n) dn dt.
\end{equation}
Here $N$ is the unipotent radical of a Borel subgroup $B$ containing a
maximally split Cartan subgroup $T$.  The subgroup $A_0 = T\cap K$ is
a maximal compact subgroup of $T$.  Its volume $\op{vol}(A_0)$
specializes to a polynomial in $q$ that can be written as a product of
cyclotomic polynomials.  Adjusting $\op{vol}(A_0)$ by a null function,
we may assume that $\op{vol}(A_0)$ is the specialization of a product
of cyclotomic polynomials.  Cyclotomic polynomials are invertible
constructible motivic functions.  Thus, $\op{vol}(A_0)$ can be
inverted.  Integration here is understood to be motivic integration
with respect to invariant volume forms on $N$ and $A$.  The
pushforward under a definable morphism (integration over fibers)
carries $q$-constructible functions to $q$-constructible functions.
Therefore $(\lambda,\mu)\mapsto s_{\lambda,\mu}$ is a
$q$-constructible function.
\end{proof}

The $q$-constructible function is given explicitly by Macdonald's
formula \cite{casselman1980unramified}.  We return to Macdonald's
formula in Section~\ref{sec:macdonald}.


\section{Presburger constructibility}

In this section, we check that some functions related to the finite
dimensional representations of complex reductive groups are Presburger
constructible functions on the appropriate integer lattices.  In this
section, constructible means Presburger constructible.

\begin{remark}\label{rem:matrix}
  For purposes of constructibility, we consider $\ring{Z}^r$ and also
  $Y^*$ as definable subassignments $h[0,0,r]$. When dealing with
  $\ring{Z}^r$, integrals over fibers in the sense of motivic
  integration are discrete sums.  For example, if $(\lambda,\mu)\to
  a_{\lambda,\mu}$ and $(\mu,\nu)\to b_{\mu,\nu}$ are constructible
  functions of integer parameters $(\lambda,\mu,\nu)\in L\times
  M\times N$, then we may intepret the matrix product
  $(\lambda,\nu)\to \sum_{\mu} a_{\lambda,\mu} b_{\mu,\nu}$ as a fiber
  integral as follows.  We pull $a_{\lambda,\mu}$ and $b_{\mu,\nu}$
  both back to $L\times M\times N$, multiply them as constructible
  functions on $L\times M\times N$, then integrate (sum) over the
  fibers of the projection morphism $L\times M\times N\to L\times N$.
\end{remark}


\subsection{weight multiplicities}

We continue to work in the usual context of an unramified reductive
group $G$, dual ${}^LG$, and partition function
$P(E,q)=P(\hat G,\n,\theta,E,q)$.

We expand the partition function into an infinite series
\[
P(E,q) = \sum_\mu (P(E,q),e^\mu) e^{\mu},
\]

\begin{lemma}\label{lemma:partition}
  The function $\mu\mapsto (P(E,q),e^\mu)$ is Presburger
  constructible.  The function $\mu\mapsto (P(E,1),e^\mu)$ is
  Presburger constructible.
\end{lemma}

\begin{proof} 
Recall that
\[
P(E,q) = \prod_{\Sigma_1^+} \frac{1}{d_\alpha(q)},
\]
where the product runs over representatives $\beta_1,\ldots,\beta_k$
of $\theta$-orbits in $\Psi^+$.

If $\sum_\mu a_\mu e^\mu$ and $\sum_\mu b_\mu e^\mu$ have
constructible coefficients, then it is easily checked that the product
also has constructible coefficients.  Thus, the proof reduces
immediately to showing that constructibility of the coefficients of
\[
\frac{1}{1-\epsilon q^b e^\alpha} 
= \sum_{i=0}^\infty \epsilon^i q^{i b} e^{i\alpha}
\]
This is evident.
\end{proof}

Let $m_{\lambda,\mu}\in \ring{N}$ be the multiplicity of the weight
$\mu\in X^*(T)$ in the irreducible representation with highest weight
$\lambda\in P^+$.

\begin{lemma}  
  The weight multiplicity function $(\lambda,\mu)\mapsto
  (\tau_\lambda,e^\mu)$, the $q$-weight multiplicity function
  $(\lambda,\mu)\mapsto (\tau_{\lambda,q},e^\mu)$ and the inverse
  Satake transform $(\lambda,\mu)\mapsto t_{\lambda,\mu}$ are all
  Presburger constructible functions.
\end{lemma}

\begin{proof} 
  Each function is a finite sum over $w\in W^\theta$ of partition
  functions.  Because constructible functions form a ring, it is
  enough to check that each term in the sum is constructible.  The
  relevant partition functions are $P(w(E)^{-1},1)$, $P(w(E)^{-1},q)$,
  and $P(w(E)^{-1},q^{-1})$, respectively.  These are constructible by
  Lemma \ref{lemma:partition}.
\end{proof}

\begin{theorem}\label{lemma:van-leeuwen} 
  $n_{\mu,\lambda}$ is a Presburger constructible function on
  $\dom\times\dom$.
\end{theorem}

\begin{proof} 
  This is a consequence of van Leeuwen's formula (Lemma
  \ref{lemma:van}).  Referring to that formula, it is enough to show
  constructibility of each term in the sum, with fixed $(w',w)$.  This
  follows from the definability of the set $Y^*_w$ and of the delta
  function $(\mu,\lambda)\mapsto \delta_{w\bullet (w'\mu),\lambda}$.
\end{proof}

\begin{corollary} 
  Consider the geometric Satake transform
\[
\hat f_\lambda = \sum_\mu g_{\lambda,\mu} \tau_\mu.
\]
Then $(\lambda,\mu)\mapsto g_{\lambda,\mu}$ is Presburger
constructible.
\end{corollary}

\begin{proof}  
  The functions $(\lambda,\mu)\mapsto s_{\lambda,\mu}$ and
  $(\lambda,\mu)\mapsto n_{\lambda,\mu}$ are constructible.  The basis
  $g_{\lambda,\mu}$ is the matrix product of these two bases.  The
  result follows from Remark \ref{rem:matrix}: matrix multiplications
  with definable indexing sets preserves constructibility.
\end{proof}

\subsection{branching formulas}

While we are on the topic of constructibility, we point out the
constructibility of branching multiplicities.  For example, we have
the following corollary of the branching multiplicity formula
\cite[Theorem ~8.2.1]{goodman}.

\begin{lemma} 
  Let $H\le G$ be complex reductive groups with Lie algebras
  ${\mathfrak h}\subseteq {\mathfrak g}$.  Fix maximal tori $T_H\le
  T_G$ with Lie algebras $t_h\subseteq t_g$.  Assume that there is an
  element $X_0\in t_h$ such that $\langle\alpha,X_0\rangle>0$ for
  every positive root of ${\mathfrak g}$.  Let $\dom_G$ and $\dom_H$
  be the sets of dominant weights in $G$ and $H$.  Let
  $m(\lambda,\mu)$ be the multiplicity of the irreducible $\mathfrak
  h$-module with highest weight $\mu$ in the irreducible $\mathfrak
  g$-module with highest weight $\lambda$.  Then $m(\lambda,\mu)$ is a
  Presburger constructible function on $\dom_G\times\dom_H$.
\end{lemma}

\begin{proof}  
  Kostant's formula expresses each branching multiplicity as a finite
  sum of partition functions.  Each partition function is rational.
  Thus, the argument used in the proof of Lemma~\ref{lemma:partition}
  applies.
\end{proof}

Explicit formulas for branching multiplicities are typical of what
Presburger constructible functions look like.  Typically branching
formulas look like products of linear factors depending on cases that
can be described by linear inequalities on parameters $\lambda$ and
$\mu$.  We do not pursue the topic, but we can similarly investigate
the constructibility of the function giving the multiplicities of
$\tau_\mu$ in $\op{Sym}^k \tau_\lambda$, and related operations on
characters.

\bigskip 

Let $(\lambda,\mu)\mapsto m(\lambda,\mu)$ be the function constructed
in Section \ref{sec:branch} that is attached to an embedding
$\xi:{}^LH\to {}^LG$ of endoscopic groups.

\begin{lemma}\label{lemma:branch} 
  The branching multiplicity function $m(\lambda,\mu)$ is Presburger
  constructible.
\end{lemma}

\begin{proof} 
  It is enough to show that each term in Equation \ref{eqn:branch} is
  Presburger constructible.  This reduces to the constructibility of
  the terms $p_{\mu'}$, which follows from the rationality of the
  partition function.
\end{proof}


\subsection{the constructibility of $B$}\label{sec:B}

Let ${}^LG$ be the Langlands dual of an unramified reductive group
$G$.  Let ${}^LH$ be the dual of an unramified endoscopic group $H$.
We assume that both $H$ and and $G$ are given in the category of
definable subassignments over a cocycle space $Z$.  We can assume that
the cocycle space $Z$ is the same for $H$ and $G$.

There exists a homomorphism ${}^LH\to {}^LG$ that factors through a
semidirect product with a finite group $\ang{\theta}$:
\[
\xi:\hat H \rtimes \ang{\theta} \to \hat G \rtimes \ang{\theta}.
\]
We fix such a homomorphism $\xi$.  

The morphism $\xi$ gives a restriction map
\begin{equation}
J_\xi:\ring{C}[Y^*]^{W^\theta} \to \ring{C}[X^*(\hat T_1)]^{W_H^{\theta_H}}
\end{equation}
that is constructed as follows.  The set of semisimple $\theta_H$
conjugacy classes in $\hat H$ is classified by $\hat
T_1/W_H^{\theta_H}$, where we have added subscripts $H$ to indicate
quantities for ${}^LH$ corresponding to $\hat S/W^\theta$ in ${}^LG$.
The morphism $\xi$ induces a map from the set of $\theta_H$-conjugacy
classes in $\hat H$ to $\theta$-conjugacy classes in $\hat G$.  This
is a morphism of varieties. The corresponding homomorphism of
coordinate rings is $J_\xi$.

Working $p$-adically, Langlands gives a homomorphism
$b = b_\xi$ from the spherical Hecke algebra of $G$ to the spherical
Hecke algebra of $H$.  If $f$ belongs to the spherical Hecek algebra
of $G$, its Satake transform belongs to $\ring{C}[Y^*]^{W^\theta}$,
where $W^\theta$ is the set of fixed points in $W$ under $\theta$.
The bi-invariant function $b_\xi(f)\in\H(H//K_H)$ is the inverse
Satake transform of the image of $f$ in
\[
\ring{C}[X^*(\hat T_1)]^{W_H^{\theta_H}}.
\]


\begin{theorem}\label{thm:B}
  Let $G$ be an unramified connected reductive group with unramified
  endoscopic group $H$, both considered as definable subassignments
  over a cocycle space $Z$.  Fix an $L$-embedding $\xi:{}^LH\to {}^LG$
  that factors through a finite cyclic group $\ang{\theta}$; that is,
  $\xi:\hat H\rtimes \ang{\theta} \to \hat G \rtimes \ang{\theta}$.
  Then there is a $q$-constructible function $B$ on $P^+_G\times H$
  and a natural number $N$ with the following specializations:
\[
B(\lambda,h)_F = b_\xi(f_{F,\lambda})(h),\quad \text{for } h\in H(F),
\]
for all $p$-adic fields in $F\in C_N$.  
\end{theorem}

Recall that for each $F$, we let $f_{F,\lambda}$ denote the
characteristic function of the double coset $K\varpi_F^\lambda K$ in
the unramified reductive group $G$ over $F$.  The theorem implies that
the homomorphism $b_\xi$ has a uniformity as the $p$-adic field
varies, and as $\lambda$ varies.

\begin{proof}
  We have done most of the work already for this theorem.  Let $L_G$
  and $L_H$ be the definable sets given in Lemma \ref{lemma:cartan}
  for $G$ and $H$.  By Lemma~\ref{lemma:satake}, the change of basis
  $L_G(\lambda,\cdot)$ to the basis $\tau_\lambda$ is constructible.
  By Theorem \ref{thm:branch} and Lemma \ref{lemma:branch}, the
  restriction of $\tau_\lambda$ is expressed in terms of the basis
  $\sigma_\mu$ through constructible coefficients $m(\lambda,\mu)$:
\[
\phi^*_\epsilon\tau_\lambda = \sum_{\mu} m(\lambda,\mu) \sigma_\mu.
\]
By the Kato-Lusztig constructibility result, the change of basis from
$\sigma_\mu$ to $\hat f^H_\mu$ or $L_H(\lambda,\cdot)$ is
constructible.

Composition of change of basis is given
by matrix multiplication of the transformation matrices.  This matrix
multiplication is constructible by Remark \ref{rem:matrix}.  Thus the
transformation $b_\xi$ expresses each $L_G(\lambda,\cdot)$ as a linear
combination with constructible coefficients of the $L_H(\mu,\cdot)$.
In other words, it is a linear combination of some constructible
functions $d(\lambda,\mu)$, indexed by $\lambda$ and summed over
$\mu\in X_*(A_H)$.  This sum is a fiber integral of the constructible
function $d$ on $X_*(A_G)\times X_*(A_H)$ for the projection to
$X_*(A_H)$.  It is therefore a constructible function.

In fact, the support of $d$ lies in a definable set $E$ such that the
fibers of $E\to X_*(A_H)$ are finite, so there are no integrability
issues.
\end{proof}

\begin{remark}  
  We have stated $q$-constructibility results in terms of the limiting
  behavior on $p$-adic fields $\C_N$ for $N$ large.  However, in fact,
  the formulas we obtain for $B$ hold for all $p$-adic fields.
\end{remark}


\subsection{transfer principle}\label{sec:transfer}

We review the transfer principle from
\cite{cluckers2010constructible}.
\XX{insert}

\subsection{enumerated Galois groups}

We deal with field extensions and Galois groups in the way described
in \cite{gordon} and \cite{cluckers2011transfer}.  We let $\Gamma$ be
an abstract group with fixed enumeration $1=\sigma_1,\ldots,\sigma_n$
of its elements.  We assume a fixed short exact sequence
\[
1\to \Gamma^t\to\Gamma\to\Gamma^{unr}\to 1,
\]
with $\Gamma^t$ and $\Gamma^{unr}$ both cyclic.  The group $\Gamma$
plays the role of a Galois group with inertia subgroup $\Gamma^t$ and
unramified quotient $\Gamma^{unr}$.  We treat this data as an abstract
fixed choice, without a priori connection to the Galois group of any
particular extension of $p$-adic fields.

We may fix an abstract root datum and choose an action of $\Gamma$ on
the root datum, stabilizing the set of simple roots.  Through this
action on the root datum, $\Gamma$ acts on the Weyl group, and we may
construct the semidirect product $W\rtimes \Gamma$.


\subsection{fundamental lemma}

We conclude this article with a proof of the fundamental lemma for the
spherical Hecke algebra for unramified groups in large positive
characteristic in the following form.

\begin{theorem} \label{thm:fl} For each absolute root system $R$,
  there is a constant $N=N_R\in\ring{N}$ such that the
  Langlands-Shelstad fundamental lemma holds for all unramified
  connected reductive groups $G$ with absolute root system $R$ and all
  of its unramified endoscopic groups $H$ over $F$ for all
  $p$-adic fields $F\in \C_N$.
\end{theorem}

By abstract unramified Galois group we mean a fixed finite cyclic
group $\Gamma=\Gamma^u$ with choice of generator $\op{qFrob}$ that we
call the quasi-Frobenius element.  It is not tied to any particular
$p$-adic field.  The abstract dual group is the Langlands dual
constructed with respect to $\Gamma$ and $\op{qFrob}$ rather than the
Galois (or Weil) group of a field.


\begin{proof}
  The fundamental lemma takes the form
\begin{equation}\label{eqn:fl}
\sum_{\gamma_G}\Delta_0(\gamma_H,\gamma_G,\cdots)
\op{O}(\gamma_G,f_\lambda) - \op{SO}(\gamma_H,b_\xi(f_\lambda)) = 0.
\end{equation}
Stable orbits of regular semisimple elements are definable as fibers
of the Chevalley morphism $G\to T/W$.  The invariant motivic measure
on stable orbits is the volume form attached to a Leray residue of an
invariant differential form on the group with respect to the canonical
form on $T/W$.  We have shown that the transfer factor and the
homomorphism $b_\xi$ can be lifted to a $q$-constructible motivic
functions.  The ellipsis $(\cdots)$ indicates extra parameters such as
a parameter running over $a$-data, a parameter running over admissible
pinnings for the canonical normalization, and uniformizing parameters
used in our explicit treatment of the $\chi$-data.  The $p$-adic
transfer factor is independent of these choices, but in dealing with
constructible motivic functions, it is best to make the dependence on
the parameters explicit (or at least honor them with an ellipsis).

We may consider the left-hand side of Equation \ref{eqn:fl} as a
$q$-constructible function of $(\lambda,\gamma_H,\cdots)\in P^+\times
H\times\cdots$, all over a definable cocycle space $Z$ used to
parameterize an unramified splitting field of $G$ and $H$.

The fundamental lemma holds for the unit element in positive
characteristic by the work of Ng\^o \cite{ngo2010lemme}.  This can be
lifted to characteristic zero \cite{cluckers2011transfer},
\cite{waldspurger2006endoscopie}.  It extends to the full Hecke
algebra in characteristic zero \cite{hales1995fundamental}.  Hence the
identity (\ref{eqn:fl}) holds in characteristic zero.  By the transfer
principle, there exists $N$ such that the fundamental lemma also holds
for all fields $F\in\C_N$.

It is important for the left-hand side of the equation to be viewed as
a single identity with $P^+$ forming a factor of the definable
subassignment, rather than viewed as an infinite collection of
identities indexed by $\lambda\in P^+$.  This allows us to invoke the
transfer principle a single time, rather than once for each
$\lambda\in P^+$.
\end{proof}

\section{Appendix on transfer factors}

In this section, we assume familiarity with the Langlands-Shelstad
transfer factor \cite{langlands1987definition}.

In \cite{gordon}, we showed that the Lie algebra transfer factor is a
constructible motivic function.  In that article, by restricting
attention to a small neighborhood of the identity element of the
group, we were able to avoid the analysis of multiplicative characters
that appear in the group-level transfer factor.  In this appendix we
analyze the multiplicative characters and prove that group level
transfer factor is constructible for unramified endoscopic data.

We use the canonical normalization of transfer factors given in
\cite[\S7]{hales1993simple}.  The canonical normalization requires on
a choice of an admissible pinning.  The admissible pinning involves a
choice of simple root vectors $X_\alpha$ relative fixed Borel subgroup
and Cartan.  The choices $X_\alpha$ range over a definable
subassignment, and we obtain the canonical normalization by
introducing a free parameter into the transfer factor ranging over the
definable subassignment.

\subsubsection{$a$-data}

To define the transfer factor for $p$-adic fields, a choice of
$a$-data is made, but the transfer-factor is in fact independent of
the choice of $a$-data.

This section introduces a definable subassignment of $a$-data and
introduces an explicit free variable $a$ into the transfer factor that
ranges over the definable subassignment of $a$-data.  The tuple
$a$-data is indexed by a fixed choice of indexing set.

We begin wih a review of $a$-data for a $p$-adic field, then show how
to make the construction as a definable subassignment.  Let $\Gamma$
be the Galois group of a Galois extension $L/F$.  We assume that
$\Gamma$ acts on a finite set $R$ of roots.  The $a$-data are a
collection of constants $a_\alpha\in L^\times$ indexed by $\lambda\in
R$ such that
\begin{equation}\label{eqn:a}
a_{-\lambda} = -a_\lambda,\quad a_{\sigma\lambda} 
= \sigma(a_\lambda),\quad \text{ for } \sigma\in \Gamma.
\end{equation}
Let $\epsilon:R\to R$, given by
$\epsilon(\lambda)=-\lambda\ne\lambda$.  Let $O$ be the orbit of some
$\lambda\in R$ under $\langle\Gamma,\epsilon\rangle$.  The choice of
$a$-data can clearly be made orbit by orbit.  If there is no
$\sigma\in \Gamma$ such that $\sigma\lambda=-\lambda$, we have a
specific choice of $a$-data (selecting a given $\lambda\in O$) given
by
\[
a_{\sigma\lambda}=1,
\quad a_{-\sigma\lambda}=-1,\quad \sigma\in\Gamma.
\]
If $\sigma_0\in\Gamma$ gives $\sigma_0\lambda=-\lambda$, then we let
$F_{+\lambda}$ be the fixed field of $\Gamma_{+\lambda} =
\{\sigma\in\Gamma\mid \sigma\lambda=\lambda\}$ and we let
$F_{\pm\lambda}$ be the fixed field of $\Gamma_{\pm\lambda} =
\{\sigma\in\Gamma\mid \sigma\lambda=\pm\lambda\}$.  The extension
$F_{+\lambda}/F_{\pm\lambda}$ is quadratic.  We may choose $a$-data by
fixing $a_\lambda\in F_{+\lambda}$ such that $\sigma_0(a_\lambda) =
-a_\lambda$ then extending uniquely to the entire orbit by the
relation (\ref{eqn:a}).  Specifically, the choice of $a_\lambda$ can
be taken to run over units of $F_{+\lambda}$ such that its square is a
nonsquare in $F_{\pm\lambda}$, when the quadratic extension is
unramified.  We take $a_\lambda$ to run over uniformizers in
$F_{\lambda}$ such that its square lies in $F_{\pm\lambda}$, when the
quadratic extension is ramified.  We see by these explicit
descriptions that $a_\lambda$ is a parameter in a definable
subassignment.

\subsubsection{$\Delta_{II}$}
Two terms in the transfer factor rely on multiplicative characters
constructed from $\chi$-data: the terms $\Delta_{II}$ and the term
$\Delta_2$.

\begin{lemma}  
  There is a $q$-constructible function representing $\Delta_{II}$
  (after introducing some free parameters ranging over definable
  subassignments).
\end{lemma}

\begin{proof}  
  We begin with an explicit construction of some characters for a
  $p$-adic field.  Then we analyze the construction to see that it can
  be done constructibly.

  Let $F_+/F_\pm$ be a quadratic extension of $p$-adic fields.  Let
  $\varpi_+$ be a uniformizer in $F_+$.  We define a multiplicative
  character $\chi_+ = \chi_{F_+/F_{\pm}}:F_+\to \ring{C}^\times$ as
  follows.  If $F_+/F_\pm$ is unramified, let $\chi_+$ be the
  unramified character of order two.

  If $-1$ is a square in $F_+$, we define $\chi_+$ by
  $\chi_+(\varpi_+) = i\in\ring{C}$ and $\chi_+$ restricted to units
  is the unique character of order two.

  If $-1$ is a nonsquare in $F_+$, we define $\chi_+$ by
  $\chi_+(\varpi_+)=1$ and $\chi_+$ restricted to units is the unique
  character of order two.

  In every case, $\chi_+^4 = 1$.

  Now we analyze constructibility.  The condition that $-1$ is a
  square or nonsquare is a definable condition.  Assume that $F_+$ and
  $F_\pm$ are both extensions of $VF$, presented as usual by a
  definable space of the characteristic polynomial of a generator of
  the fields.  Introduce a free parameter $\varpi_+$ that runs over
  the constructible subassignment of uniformizers in $F_+$.  We claim
  that $\chi_+$ is a linear combination of characteristic functions
\[
\chi_+ = \sum_{\zeta\in\mu_4(\ring{C})} \zeta\, \op{char}(D_\zeta).
\]
where each $D_\zeta$ is constructible over the space of parameters.
This is essentially obvious: $F_+/F_\pm$ being unramified is a
definable condition on the coefficients of the characteristic
polynomial; the unique character of order two is given in terms of the
characteristic function on squares and nonsquares, etc.

Now we turn to the transfer factor $\Delta_{II}$.  It has the form
\[
\prod_\alpha \chi_\alpha
\left(\frac{\alpha(\gamma)-1}{a_\alpha}\right)
\]
It is a constructible function if each factor is a constructible
functions. Each morphism $\gamma\to(\alpha(\gamma)-1)/a_\alpha$ is
definable, so we only need to check that each character $\chi_\lambda$
in some choice of $\chi$-data is constructible.  We use the characters
given above to do so.

There is no harm in partitioning the domain of $\Delta_{II}$ according
to definable characteristics of the element $\gamma$.  We consider a
definable family of $L/VF$ that split the centralizer of $\gamma$.  We
may assume fixed abstract Galois data $1\to\Gamma^t\to\Gamma\to
\Gamma^u\to 1$ with enumeration $\sigma_i$ of the elements of $\Gamma$
for $L$ and we may assume a fixed action of that data on the root
system coming from the centralizer of $\gamma$ (relative to a split
torus).  This gives the indexing set $R$ of roots and action of
$\Gamma$ as fixed choices used to partition the domain of
$\Delta_{II}$.

Let $\epsilon$ be an automorphism of $R$ that acts as $\lambda\mapsto
-\lambda$, and let $O(\lambda)$ be the orbit of $\lambda$ under
$\langle\Gamma,\epsilon\rangle$.  If there does not exist
$\sigma\in\Gamma$ such that $\sigma\lambda=-\lambda$, then we may take
the $\chi$-data for $\mu\in O(\lambda)$ to be the trivial character
(which is constructible).

Now assume that there exists $\sigma\in\Gamma$ such that
$\sigma\lambda = -\lambda$.  Then $F_{+\lambda}/F_{\pm \lambda}$ is a
nontrivial quadratic extension.  We set $\chi_\lambda = \chi_+$ for
this quadratic extension.  In more detail, we include free parameters
$\dot\sigma_i$ realizing each abstract automorphism $\sigma$ as a
linear transformation of $L/VF$.  The extension $F_{+\lambda}/VF$ and
the space of uniformizers $\varpi_+$ in the extension are then
described by definable conditions inside $L/VF$ (as in
\cite{cluckers2011transfer}).

By transport of structure, we obtain constructible $\chi$-data on the
entire orbit of $\lambda$, using the defining properties of
$\chi$-data: $\chi_{\sigma\lambda} = \chi_{\lambda}\cdot
\dot\sigma^{-1}$; $F_{+\sigma\lambda}=\dot\sigma F_{+\lambda}$;
$\varpi_{+\sigma\lambda}=\dot\sigma\varpi_{+\lambda}$, and so forth.
Running over all orbits this way, constructible $\chi$-data are
obtained.
\end{proof}
% Langlands-Shelstad use Sigma = <Gamma,epsilon>,
% Gamma_Langlands-Shelstad = Sigma_this.


\subsubsection{$\Delta_2$}

We have now treated all terms except $\Delta_2$.  We recall that the
term $\Delta_2$ restricts to a multiplicative character on each Cartan
subgroup of $G$.  It is constructed from $\chi$-data by means of class
field theory reciprocity for tori.  The following theorem completes
our analysis of the transfer factors on groups.

\begin{theorem}\label{thm:delta2}  
  There is a $q$-constructible function representing the transfer
  factor $\Delta$, possibly after introducing some free parameters.
  These parameters have no effect upon specialization to a $p$-adic
  field.
\end{theorem}

\begin{proof}  
  We give a sketch of a proof.  The idea of the proof is that
  multiplicative characters can be chosen to be tamely ramified; that
  is, they have trivial restricition to topologically unipotent
  elements.  We have descent formulas for unramified groups that
  reduce the transfer factor to the case of topologically unipotent
  elements \cite{langlands2007descent} \cite{hales1993simple}
  \cite{langlands2007descent}.

  We freely use various lemmas on definability from the next section
  \ref{sec:definability}.

  We enumerate the standard Levi components of $G$.  Each is a
  definable set.  If $\gamma_G$ is conjugate to an element $\gamma_M$
  in some proper Levi subgroup, then by descent formulas for transfer
  factors we have $\Delta(\gamma_G,\gamma_H) =
  \Delta_M(\gamma_M,\gamma_{M,H})$.  The element $\gamma_{M,H}$ is a
  conjugate of $\gamma_H$ in a Levi of $H$ constructed by descent.  By
  an induction on the dimension of the group, we may assume that
  $\Delta_M$ is constructible.  Every regular semisimple element that
  is not elliptic is conjugate to a proper Levi subgroup.  We may now
  assume that $\gamma_G$ belongs to an elliptic Cartan subgroup $T$.

  Since $G$ is unramified, the connected center $Z^0$ is also
  unramified.  $Z^0$ can be naturally identified with a torus in the
  center of $H$.  By Langlands and Shelstad, there is a character
  $\chi_Z$ on $Z^0$ such that
\[
\Delta(z\gamma_G,z\gamma_H) = \chi_Z(z)\Delta(\gamma_G,\gamma_H).
\]
The character is unramified \cite{hales1993simple}.  The character
$\chi_Z$ depends on $(\gamma_G,\gamma_H)$ only through the endoscopic
data $(G,H)$.  To check constructibility of $\chi_Z$, it is convenient
and allowable to temporarily assume that $\gamma_H$ belongs to the
maximally split Cartan subgroup of $H$.  We can apply Levi descent,
unless the image $\gamma_G$ of $\gamma_H$ lies in an elliptic torus.

If $G=H$ is a torus, then there is a tautological embedding
$\xi_0:{}^LH \to {}^LG$ for which the character $\chi_Z$ is trivial.
Any other choice of embedding $\xi$ that factors through a finite
unramified extension $\op{Gal}(E/F)$.  The cocycles attached to
$\xi_0$ and $\xi$ differ by a cocycle of $H^1(\op{Gal}(E/F),\hat T)$,
determined by the value $\phi$ on the Frobenius (or in the
constructible context, the quasi-Frobenius)
\[
\phi \in \hat T = X^*(T)\otimes \ring{C}^\times = \op{Hom}(X_*(T),\ring{C}^\times)
\]
By reciprocity, this corresponds to the unramified character of $T$
given by $\varpi_F^\lambda\mapsto \phi(\lambda)$, for $\lambda\in
X_{*,F}(T)$.  This clearly extends to a constructible function
$\chi_Z$ on $T$.

If $G$ has a nontrivial root system and $\gamma_G$ is elliptic, then
it is known that the adjoint group of $G$ is $\op{PGL}(n)$ and $H$ is
the elliptic unramified torus given by twisting by the longest element
of the Weyl group of $\op{PGL}(n)$.  In this case Kazhdan gave a
formula for the transfer factor (later repeated later in Hales and
Waldspurger), and by inspection, it is constructible
\cite{kazhdan1983lifting}.  It is essentially the quadratic character
attached to the unramified quadratic extension of $F$, evaluated on a
resultant polynomial constructed from $\gamma_H$.  This completes the
proof that $\chi_Z$ is constructible.

Now we drop the temporary assumption on $\gamma_H$; it is no longer
assumed to lie in a maximally split Cartan subgroup.

By adjusting $(\gamma_G,\gamma_H)$ by a central element, we may reduce
the proof of constructibility to the special case where $\gamma_G$ and
$\gamma_H$ lie in the maximal bounded subgroup of their Cartan
subgroups $T$ and $T_H$.  We take a definable topological Jordan
decompositon $\gamma_G = \gamma_s \gamma_u$, described in Section
\ref{sec:definability}.  Replacing $\gamma_G$ and $\gamma_s$ by stable
conjugates $\gamma'_G=\gamma_G^h$ and $\gamma_s^h$ (same $h$), we may
assume that $\gamma_s\in G_u$; that is, its centralizer is unramified.
We may do the same on the endoscopic side.  We have
\[
\Delta_G(\gamma_G,\gamma_H) = c \Delta_G(\gamma'_G,\gamma'_H)
\]
where $c$ is the ratio of terms coming from $\Delta_{III}$.  The
$\Delta_{III}$ terms are constructible, so the proof of
constructibility reduces to the case where we may now drop primes and
assume that $\gamma_s$ has an unramified centralizer.  We construct
descent data $(G_s,H_s)$ for the centralizer of $\gamma_s$ in $G$ and
the corresponding centralizer in $H$.  By \cite{hales1993simple}, the
normalized transfer factors satisfy
\[
\Delta(\gamma_G,\gamma_H) = \Delta_s(\gamma_G,\gamma_H),
\]
where the right-hand side is computed with respect to the endoscopic
data $(G_s,H_s)$.  (In that reference, it is assumed that $\gamma_G\in
G(O_F)$ and $\gamma_H\in H(O_F)$, but that assumption is only needed
to prove the fact that the centralizer of $\gamma_s$ is unramified.
Since we have a separate argument of that fact, the descent formula
holds in our context as well.)  By an induction on the dimension of
the group, the right-hand side is constructible, and the proof is
complete except in the case when $\gamma_s$ is central.

We now assume that $\gamma_s$ is central and strongly compact.  Then
$\gamma_s\in K$ because $K$ is a maximal compact.  It is known that
$\chi_Z$ is trivial on $K$ \cite[Lemma
3.2]{hales1995fundamental}. Thus again adjusting by an element in the
center, we may assume that $\gamma_s=1$.  That is, we are reduced to
proving the constructibility of transfer factors on the set of
topologically unipotent elements.  We pick our $\chi$-data to be
tamely ramified.  This implies that the characters $\Delta_2$ are
trivial on topologically unipotent elements.  This reduces
constructibility to the analysis of factors $\Delta_I$, $\Delta_{II}$,
$\Delta_1$, and $\Delta_{IV}$.  This has already been done.  This
completes the proof.
\end{proof}

%\section{Appendix on explicit partition functions and $\theta$-conjugacy}
%\subsection{some calculations of partition functions}

